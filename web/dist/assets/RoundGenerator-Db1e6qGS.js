import{j as e,r as x,b as X}from"./vendor-react-DpsG3A-O.js";import{d as as,r as is,s as Lt,e as It,h as Zt,i as es,j as ct,k as nn,l as ls,p as ze,L as pe,u as rn,m as on,n as an,o as ln,T as cn,C as dn,R as un,c as mn,a as pn,q as fn,f as ts,t as hn,v as xn,w as bn}from"./index-C_iWMZo5.js";import{g as cs,i as Fe}from"./visualBonuses-DFQrNomD.js";import{L as gn,R as yn,F as wn,a as ss,j as jn,k as Rt,l as Bt,h as ns,m as vn,X as kn,g as Nn,U as Sn,d as rs,e as Cn,f as An,T as Rn,n as os,o as Bn,p as Ln,q as In}from"./vendor-lucide-react-DoOgXp02.js";import{S as Tn,p as Mn}from"./vendor-react-pdf-renderer-DfOTdHag.js";import{D as En,P as $n,T as Z,V as Q}from"./vendor-react-pdf-primitives-B6ApagcG.js";import"./vendor-abs-svg-path-DCUpb6Nw.js";import"./vendor-react-dom-D1u-fJLi.js";import"./vendor-scheduler-CoSDG3-6.js";import"./vendor-firebase-BZrYkTdu.js";import"./vendor-firebase-app-DqcDUDC6.js";import"./vendor-firebase-component-B9jxOSis.js";import"./vendor-firebase-util-CIVODmCg.js";import"./vendor-firebase-logger-CNz1B4Yj.js";import"./vendor-idb-BXWtuYvb.js";import"./vendor-firebase-app-check-Co35-rT3.js";import"./vendor-firebase-firestore-BRp-7IKb.js";import"./vendor-firebase-webchannel-wrapper-QS5lB7L3.js";import"./vendor-firebase-storage-D1N4MLec.js";import"./vendor-firebase-database-DcYXcGm3.js";import"./vendor-react-helmet-async-bvMvt1Ax.js";import"./vendor-react-fast-compare-BCtOC5yC.js";import"./vendor-invariant-DW3JcdOx.js";import"./vendor-shallowequal-Df9Q-7bk.js";import"./vendor-react-router-dom-D6uELkfw.js";import"./vendor-react-router-B_FrsTVh.js";import"./vendor-remix-run-router-9r-WWGj9.js";import"./vendor-mui-material-DksXbHt-.js";import"./vendor-mui-utils-B23qfrSe.js";import"./vendor-clsx-B-dksMZM.js";import"./vendor-mui-system-BndTH9qf.js";import"./vendor-mui-styled-engine-CPmDJbkS.js";import"./vendor-emotion-styled-5vLscvJp.js";import"./vendor-babel-runtime-WXw8LxeR.js";import"./vendor-emotion-serialize-B6qc6euy.js";import"./vendor-emotion-hash-WldOFDRm.js";import"./vendor-emotion-unitless-x5IvBceT.js";import"./vendor-emotion-memoize-3S_6p140.js";import"./vendor-emotion-use-insertion-effect-with-fallbacks-B--OEmuQ.js";import"./vendor-emotion-utils-BijCJQMc.js";import"./vendor-emotion-is-prop-valid-DOnQZHJ6.js";import"./vendor-emotion-react-DrbGOuDy.js";import"./vendor-hoist-non-react-statics-mDtaWys7.js";import"./vendor-react-is-CnyDuYXe.js";import"./vendor-emotion-cache-DvsOMRO7.js";import"./vendor-emotion-sheet-6IwnyhEX.js";import"./vendor-stylis-DDa9OTMq.js";import"./vendor-react-transition-group-Q1VPUTjR.js";import"./vendor-katex-DP_4UPSs.js";import"./vendor-queue-IZnSDwnG.js";import"./vendor-inherits-BICa84dG.js";import"./vendor-events-DQ172AOg.js";import"./vendor-react-pdf-font-ByacAZ2x.js";import"./vendor-cross-fetch-DvOI2u39.js";import"./vendor-fontkit-5mDwoQ7O.js";import"./vendor-restructure-DwIbRzqP.js";import"./vendor-swc-helpers-DIxjOVuh.js";import"./vendor-fast-deep-equal-DtIvihjZ.js";import"./vendor-unicode-properties-BbL32wKl.js";import"./vendor-base64-js-BJmSPyJr.js";import"./vendor-unicode-trie-rSh8NucD.js";import"./vendor-tiny-inflate-BmeP50H3.js";import"./vendor-dfa-DFRa2UL2.js";import"./vendor-clone-DniFCc4t.js";import"./vendor-brotli-CUuIRSoC.js";import"./vendor-tslib-kHcLnhpD.js";import"./vendor-react-pdf-render-DYs5yDRr.js";import"./vendor-react-pdf-fns-DIcDsgsD.js";import"./vendor-parse-svg-path-Bi0KIs1g.js";import"./vendor-normalize-svg-path-CFWHe3yZ.js";import"./vendor-svg-arc-to-cubic-bezier-DEq50KMd.js";import"./vendor-color-string-BKSasjlw.js";import"./vendor-color-name-Dju3oUBS.js";import"./vendor-simple-swizzle-3gX0Onlb.js";import"./vendor-is-arrayish-DyGeW-O8.js";import"./vendor-react-pdf-pdfkit-CgWEQEi-.js";import"./vendor-pako-CNe1bWpJ.js";import"./vendor-crypto-js-C9XMI5TL.js";import"./vendor-jay-peg-DnV82Tak.js";import"./vendor-react-pdf-png-js-D_OjzuBh.js";import"./vendor-react-pdf-layout-CVT9JNgr.js";import"./vendor-react-pdf-stylesheet-B2kC1IpU.js";import"./vendor-postcss-value-parser-DOXmp8r9.js";import"./vendor-hsl-to-hex-CDkcI7Vq.js";import"./vendor-hsl-to-rgb-for-reals-jL61FXS_.js";import"./vendor-media-engine-BWjc9dwl.js";import"./vendor-react-pdf-textkit-R3VqYnwu.js";import"./vendor-bidi-js-DLACMwmw.js";import"./vendor-hyphen-B2aENclZ.js";import"./vendor-yoga-layout-nAHjiEuJ.js";import"./vendor-react-pdf-image-BJ1YGwqv.js";import"./vendor-object-assign-Dm9xdUEz.js";function Pn({auth:r,roundsIndex:p,setRoundsIndex:f,roundFolders:y,setRoundFolders:L,loadingUserRounds:j,refresh:M,selectedExcludeRoundIds:A,setSelectedExcludeRoundIds:I,foldersOpen:k,setFoldersOpen:E,handleExcludeRoundToggle:P,pushToast:u,setManagerSelection:S,setShowRoundsManager:R,setFolderDeleteTarget:D,setDeleteTarget:U,onViewRound:B}){return r?.user?e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold mb-2 flex items-center gap-2",children:["Exclude rounds",e.jsx("button",{className:"chip px-2 py-0.5 text-xs",title:"Clear selection",onClick:()=>I([]),children:e.jsx(gn,{size:16})}),e.jsx("button",{className:"chip px-2 py-0.5 text-xs inline-flex items-center","aria-label":"Refresh rounds & folders",title:"Refresh",onClick:M,children:e.jsx(yn,{size:14})}),e.jsx("button",{className:"chip px-2 py-0.5 text-xs inline-flex items-center","aria-label":"Create folder",title:"Create folder",onClick:async()=>{if(!r?.user)return;const F=window.prompt("Folder name");if(F==null)return;const K=F.trim();if(!K){u("Folder name cannot be empty.","error");return}const te=K.toLowerCase();if(y.some(c=>c.toLowerCase()===te)){u("Folder already exists.","error");return}try{await as(r.user.uid,K),L(c=>[...c,K].sort((a,w)=>a.localeCompare(w))),E(c=>{const a=new Set(c);return a.add(K),a}),u("Folder created.","success")}catch(c){u(c.message||"Failed to create folder.","error")}},children:e.jsx(wn,{size:14})}),e.jsx("button",{className:"chip px-2 py-0.5 text-xs inline-flex items-center","aria-label":"Open rounds manager",title:"Manage saved rounds",onClick:()=>{S(new Set(A)),R(!0)},children:e.jsx(ss,{size:14})})]}),j?e.jsx("div",{className:"text-sm opacity-70",children:"Loading your rounds…"}):p.length===0?e.jsx("div",{className:"text-sm opacity-70",children:"No saved rounds yet."}):e.jsx("div",{className:"border rounded-lg max-h-64 overflow-y-auto overflow-x-hidden divide-y divide-black/10 dark:divide-white/10",children:(()=>{const F=[],K=y.sort((a,w)=>a.localeCompare(w)).map(a=>{const w=k.has(a),N=p.filter(m=>m.folder===a);return e.jsxs("div",{className:"select-none",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 hover:bg-black/5 dark:hover:bg-white/10 cursor-pointer",onClick:()=>E(m=>{const b=new Set(m);return b.has(a)?b.delete(a):b.add(a),b}),onDragOver:m=>{m.preventDefault(),m.dataTransfer.dropEffect="move"},onDrop:async m=>{if(m.preventDefault(),!r?.user)return;const b=m.dataTransfer.getData("text/round-ids");if(!b)return;const T=b.split(",").filter(Boolean);for(const z of T)try{await Lt(r.user.uid,z,a)}catch{}f(z=>z.map(h=>T.includes(h.id)?{...h,folder:a}:h)),u(`Moved ${T.length} round(s) to ${a}.`,"success")},children:[e.jsx("button",{type:"button",className:"p-0.5 rounded hover:bg-black/10 dark:hover:bg-white/10","aria-label":w?"Collapse folder":"Expand folder",children:w?e.jsx(ss,{size:15}):e.jsx(jn,{size:15})}),e.jsx("input",{type:"checkbox",className:"accent-tint",ref:m=>{if(!m)return;const b=p.filter(h=>h.folder===a),T=b.length,z=b.filter(h=>A.includes(h.id)).length;m.indeterminate=z>0&&z<T},checked:(()=>{const m=p.filter(b=>b.folder===a);return m.length>0&&m.every(b=>A.includes(b.id))})(),onChange:()=>{const b=p.filter(T=>T.folder===a).map(T=>T.id);I(T=>{const z=new Set(T);return b.every(J=>z.has(J))?b.forEach(J=>z.delete(J)):b.forEach(J=>z.add(J)),Array.from(z)})},"aria-label":`Select all rounds in folder ${a}`,title:"Select all in folder"}),e.jsxs("span",{className:"font-medium flex-1 truncate",title:a,children:[a," ",e.jsxs("span",{className:"opacity-60 text-xs",children:["(",N.length,")"]})]}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-[11px] inline-flex items-center","aria-label":"Rename folder",title:"Rename folder",onClick:m=>{m.stopPropagation();const b=window.prompt("Rename folder",a);if(b==null)return;const T=b.trim();if(!(!T||T===a)){if(y.some(z=>z.toLowerCase()===T.toLowerCase())){u("Folder name already exists.","error");return}(async()=>{try{await is(r.user.uid,a,T),L(z=>z.map(h=>h===a?T:h)),f(z=>z.map(h=>h.folder===a?{...h,folder:T}:h)),E(z=>{const h=new Set(z);return h.has(a)&&(h.delete(a),h.add(T)),h}),u("Folder renamed.","success")}catch(z){u(z.message||"Failed to rename folder.","error")}})()}},children:e.jsx(Rt,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-[11px] inline-flex items-center text-red-600 border-red-200 hover:bg-red-50 dark:text-red-300 dark:border-red-700 dark:hover:bg-red-900/30","aria-label":"Delete folder and its rounds",title:"Delete folder",onClick:m=>{m.stopPropagation();const b=p.filter(T=>T.folder===a);D({name:a,count:b.length,roundIds:b.map(T=>T.id)})},children:e.jsx(Bt,{className:"h-3.5 w-3.5"})})]}),w&&e.jsx("ul",{className:"divide-y divide-black/5 dark:divide-white/10",role:"group",children:N.map(m=>{F.push(m.id);const b=m.createdAt?.seconds?new Date(m.createdAt.seconds*1e3):null,T=b?`${b.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})} on ${b.toLocaleDateString()}`:m.title||"Untitled",z=A.includes(m.id);return e.jsx("li",{draggable:!0,onDragStart:h=>{h.dataTransfer.effectAllowed="move";const J=A.includes(m.id)?A:[m.id];h.dataTransfer.setData("text/round-ids",J.join(","))},children:e.jsxs("div",{className:`group flex items-center justify-between gap-2 pl-10 pr-3 py-2 ${z?"bg-tint/10 ring-1 ring-tint":""}`,children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer flex-1 min-w-0",title:m.title||`Round ${T}`,children:[e.jsx("input",{type:"checkbox",checked:z,onChange:h=>P(h,m.id)}),e.jsx("span",{className:"block whitespace-normal overflow-visible group-hover:truncate group-focus-within:truncate",children:m.title||`Round ${T}`})]}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100 inline-flex items-center","aria-label":"View round",title:"View round",onClick:h=>{h.stopPropagation(),B?.(m)},children:e.jsx(ns,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100 inline-flex items-center","aria-label":"Rename round",title:"Rename round",onClick:async h=>{h.stopPropagation();const J=m.title||`Round ${T}`,se=window.prompt("Rename round",J);if(se==null)return;const oe=se.trim();if(!oe||oe===J)return;if(p.some(fe=>fe.id!==m.id&&(fe.title||"").trim().toLowerCase()===oe.toLowerCase())){u("Another round already has that title.","error");return}try{await It(r.user.uid,m.id,oe),f(fe=>fe.map(ge=>ge.id===m.id?{...ge,title:oe}:ge))}catch(fe){window.alert?.(fe?.message||"Failed to rename round.")}},children:e.jsx(Rt,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 text-red-600 border-red-200 hover:bg-red-50 dark:text-red-300 dark:border-red-700 dark:hover:bg-red-900/30",title:"Delete round",onClick:h=>{h.stopPropagation(),U(m)},children:e.jsx(Bt,{className:"h-3.5 w-3.5"})})]})},m.id)})})]},a)}),te=p.filter(a=>!a.folder),c=e.jsxs("div",{className:"select-none",onDragOver:a=>{a.preventDefault(),a.dataTransfer.dropEffect="move"},onDrop:async a=>{if(a.preventDefault(),!r?.user)return;const w=a.dataTransfer.getData("text/round-ids");if(!w)return;const N=w.split(",").filter(Boolean);for(const m of N)try{await Lt(r.user.uid,m,"")}catch{}f(m=>m.map(b=>N.includes(b.id)?(()=>{const{folder:T,...z}=b;return z})():b)),u(`Cleared folder for ${N.length} round(s).`,"success")},children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-black/5 dark:bg-white/10 font-medium",children:["Unfiled ",e.jsxs("span",{className:"opacity-60 text-xs",children:["(",te.length,")"]})]}),e.jsx("ul",{className:"divide-y divide-black/5 dark:divide-white/10",role:"group",children:te.map(a=>{F.push(a.id);const w=a.createdAt?.seconds?new Date(a.createdAt.seconds*1e3):null,N=w?`${w.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})} on ${w.toLocaleDateString()}`:a.title||"Untitled",m=A.includes(a.id);return e.jsx("li",{draggable:!0,onDragStart:b=>{b.dataTransfer.effectAllowed="move";const T=A.includes(a.id)?A:[a.id];b.dataTransfer.setData("text/round-ids",T.join(","))},children:e.jsxs("div",{className:`group flex items-center justify-between gap-2 pl-6 pr-3 py-2 ${m?"bg-tint/10 ring-1 ring-tint":""}`,children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer flex-1 min-w-0",title:a.title||`Round ${N}`,children:[e.jsx("input",{type:"checkbox",checked:m,onChange:b=>P(b,a.id)}),e.jsx("span",{className:"block whitespace-normal overflow-visible group-hover:truncate group-focus-within:truncate",children:a.title||`Round ${N}`})]}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100 inline-flex items-center","aria-label":"View round",title:"View round",onClick:b=>{b.stopPropagation(),B?.(a)},children:e.jsx(ns,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100 inline-flex items-center","aria-label":"Rename round",title:"Rename round",onClick:async b=>{b.stopPropagation();const T=a.title||`Round ${N}`,z=window.prompt("Rename round",T);if(z==null)return;const h=z.trim();if(!h||h===T)return;if(p.some(se=>se.id!==a.id&&(se.title||"").trim().toLowerCase()===h.toLowerCase())){u("Another round already has that title.","error");return}try{await It(r.user.uid,a.id,h),f(se=>se.map(oe=>oe.id===a.id?{...oe,title:h}:oe))}catch(se){window.alert?.(se?.message||"Failed to rename round.")}},children:e.jsx(Rt,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 text-red-600 border-red-200 hover:bg-red-50 dark:text-red-300 dark:border-red-700 dark:hover:bg-red-900/30",title:"Delete round",onClick:b=>{b.stopPropagation(),U(a)},children:e.jsx(Bt,{className:"h-3.5 w-3.5"})})]})},a.id)})})]},"__unfiled__");return e.jsxs(e.Fragment,{children:[K,c]})})()})]}):null}function Dn({auth:r,pushToast:p}){const[f,y]=x.useState([]),[L,j]=x.useState(!1),[M,A]=x.useState([]),[I,k]=x.useState(()=>new Set),[E,P]=x.useState([]),u=x.useRef(new Map);x.useEffect(()=>{let c=!1;async function a(){if(!r?.user){y([]),u.current.clear(),A([]);return}j(!0);try{const w=await Zt(r.user.uid).catch(()=>[]);c||y(w);const N=await es(r.user.uid).catch(()=>[]);c||A(N)}finally{c||j(!1)}}return a(),()=>{c=!0}},[r?.user?.uid]);async function S(c,a){c?.nativeEvent?.shiftKey||c?.shiftKey;const w=E.includes(a),N=!w;if(P(m=>{const b=new Set(m);return w?b.delete(a):b.add(a),Array.from(b)}),N&&r?.user&&!u.current.has(a))try{const m=await ls(r.user.uid,a);m&&u.current.set(a,m)}catch{}}async function R(){if(r?.user){j(!0);try{y(await Zt(r.user.uid,{force:!0})),A(await es(r.user.uid,{force:!0}))}finally{j(!1)}}}async function D(c){if(!r?.user)return;if(!c?.trim()){p?.("Folder name cannot be empty.","error");return}const a=c.toLowerCase();if(M.some(w=>w.toLowerCase()===a)){p?.("Folder already exists.","error");return}await as(r.user.uid,c),A(w=>[...w,c].sort((N,m)=>N.localeCompare(m))),k(w=>{const N=new Set(w);return N.add(c),N}),p?.("Folder created.","success")}async function U(c,a){if(!r?.user)return;const w=a.trim();if(!(!w||w===c)){if(M.some(N=>N.toLowerCase()===w.toLowerCase())){p?.("Folder name already exists.","error");return}await is(r.user.uid,c,w),A(N=>N.map(m=>m===c?w:m)),y(N=>N.map(m=>m.folder===c?{...m,folder:w}:m)),k(N=>{const m=new Set(N);return m.has(c)&&(m.delete(c),m.add(w)),m}),p?.("Folder renamed.","success")}}async function B(c,a){if(r?.user){for(const w of c)try{await Lt(r.user.uid,w,a)}catch{}y(w=>w.map(N=>c.includes(N.id)?{...N,folder:a}:N)),p?.(a?`Moved ${c.length} round(s) to ${a}.`:`Cleared folder for ${c.length} round(s).`,"success")}}async function F(c,a){if(!r?.user)return;if(f.some(m=>m.id!==c.id&&(m.title||"").trim().toLowerCase()===a.toLowerCase())){p?.("Another round already has that title.","error");return}await It(r.user.uid,c.id,a),y(m=>m.map(b=>b.id===c.id?{...b,title:a}:b));const N=u.current.get(c.id);N&&u.current.set(c.id,{...N,title:a})}async function K(c){r?.user&&(await ct(r.user.uid,c),y(a=>a.filter(w=>w.id!==c)),P(a=>a.filter(w=>w!==c)),u.current.delete(c),p?.("Round deleted.","error"))}async function te(c,a=[]){if(r?.user){for(const w of a)try{await ct(r.user.uid,w)}catch{}try{await nn(r.user.uid,c)}catch{}y(w=>w.filter(N=>!a.includes(N.id))),P(w=>w.filter(N=>!a.includes(N))),A(w=>w.filter(N=>N!==c)),p?.("Folder and rounds deleted.","error")}}return{roundsIndex:f,setRoundsIndex:y,loadingUserRounds:L,roundFolders:M,setRoundFolders:A,foldersOpen:I,setFoldersOpen:k,selectedExcludeRoundIds:E,setSelectedExcludeRoundIds:P,excludeDetailCache:u,handleExcludeRoundToggle:S,refresh:R,createFolder:D,renameFolder:U,moveRoundsToFolder:B,renameRound:F,deleteRoundPermanently:K,deleteFolderAndRounds:te}}const $=Tn.create({page:{padding:16,fontSize:8,fontFamily:"Times-Roman"},title:{textAlign:"center",fontSize:11,fontWeight:"bold",marginBottom:4},legendBlock:{marginBottom:4},tiny:{fontSize:6.5},footer:{marginTop:4,textAlign:"center",fontSize:6.5},tablesWrap:{flexDirection:"row"},teamACol:{flex:1.1,marginRight:4},teamBCol:{flex:.9,marginLeft:4},headerRow:{flexDirection:"row",backgroundColor:"#eee"},bodyRow:{flexDirection:"row"},cell:{borderWidth:.5,borderColor:"#000",paddingVertical:1.5,paddingHorizontal:2,justifyContent:"center",textAlign:"center",minHeight:12},headCellText:{fontWeight:"bold",fontSize:6.5},qnCell:{fontSize:6.5,fontWeight:"bold"},subjCell:{fontSize:6.5},attempt:{fontSize:6.5,fontWeight:"bold"},nameHead:{fontSize:6,fontWeight:"bold"},spacer:{width:4}});function Fn(r){return[4,7,6,...Array(r).fill(9),7,6,7]}function zn(r){return[...Array(r).fill(9),7,6,7]}function _n({playerLabels:r=[],cols:p}){const f=["Q","Subj","Type",...r,"Bonus","Pen","Score"];return e.jsx(Q,{style:$.headerRow,children:f.map((y,L)=>{const j=p[L];return e.jsx(Q,{style:[$.cell,{flexGrow:j,flexBasis:j}],children:e.jsx(Z,{style:$.headCellText,children:y})},L)})})}function Un({playerLabels:r=[],cols:p}){const f=[...r,"Bonus","Pen","Score"];return e.jsx(Q,{style:$.headerRow,children:f.map((y,L)=>{const j=p[L];return e.jsx(Q,{style:[$.cell,{flexGrow:j,flexBasis:j}],children:e.jsx(Z,{style:$.headCellText,children:y})},L)})})}function qn({r,seatPlayers:p,outRows:f,cols:y}){if(!r||r.pad)return e.jsx(Q,{style:$.bodyRow,children:y.map((S,R)=>e.jsx(Q,{style:[$.cell,{flexGrow:S,flexBasis:S}],children:R===0&&r?.index?e.jsx(Z,{style:$.qnCell,children:r.index}):null},R))});const L=(r.attempts||[]).filter(S=>S&&S.playerId!=null);function j(S){if(!S)return"";const R=L.filter(U=>U.playerId===S.id);if(!R.length)return"";const D=R[R.length-1];return D.result==="correct"?D.interrupt?"CI":"C":D.result==="incorrect"?D.interrupt?"II":"I":""}const M=r.bonusA,A=r.penaltyA,I=r.cumA;function k(S,R){let D=j(S);return!D&&S&&f[S.id]===r.index&&(D="out"),e.jsx(Q,{style:[$.cell,{flexGrow:R,flexBasis:R}],children:e.jsx(Z,{style:$.attempt,children:D})},S?S.id:Math.random())}const E=y.slice(0,3),P=y.slice(3,3+p.length),u=y.slice(3+p.length);return e.jsxs(Q,{style:$.bodyRow,children:[e.jsx(Q,{style:[$.cell,{flexGrow:E[0],flexBasis:E[0]}],children:e.jsx(Z,{style:$.qnCell,children:r.index})}),e.jsx(Q,{style:[$.cell,{flexGrow:E[1],flexBasis:E[1]}],children:e.jsx(Z,{style:$.subjCell,children:r.subject})}),e.jsx(Q,{style:[$.cell,{flexGrow:E[2],flexBasis:E[2]}],children:e.jsx(Z,{style:$.subjCell,children:r.type})}),p.map((S,R)=>k(S,P[R])),e.jsx(Q,{style:[$.cell,{flexGrow:u[0],flexBasis:u[0]}],children:e.jsx(Z,{children:M?String(M):""})}),e.jsx(Q,{style:[$.cell,{flexGrow:u[1],flexBasis:u[1]}],children:e.jsx(Z,{children:A?String(A):""})}),e.jsx(Q,{style:[$.cell,{flexGrow:u[2],flexBasis:u[2]}],children:e.jsx(Z,{children:I!=null?String(I):""})})]})}function On({r,seatPlayers:p,outRows:f,cols:y}){if(!r||r.pad)return e.jsx(Q,{style:$.bodyRow,children:y.map((u,S)=>e.jsx(Q,{style:[$.cell,{flexGrow:u,flexBasis:u}]},S))});const L=(r.attempts||[]).filter(u=>u&&u.playerId!=null);function j(u){if(!u)return"";const S=L.filter(D=>D.playerId===u.id);if(!S.length)return"";const R=S[S.length-1];return R.result==="correct"?R.interrupt?"CI":"C":R.result==="incorrect"?R.interrupt?"II":"I":""}const M=r.bonusB,A=r.penaltyB,I=r.cumB;function k(u,S){let R=j(u);return!R&&u&&f[u.id]===r.index&&(R="out"),e.jsx(Q,{style:[$.cell,{flexGrow:S,flexBasis:S}],children:e.jsx(Z,{style:$.attempt,children:R})},u?u.id:Math.random())}const E=y.slice(0,p.length),P=y.slice(p.length);return e.jsxs(Q,{style:$.bodyRow,children:[p.map((u,S)=>k(u,E[S])),e.jsx(Q,{style:[$.cell,{flexGrow:P[0],flexBasis:P[0]}],children:e.jsx(Z,{children:M?String(M):""})}),e.jsx(Q,{style:[$.cell,{flexGrow:P[1],flexBasis:P[1]}],children:e.jsx(Z,{children:A?String(A):""})}),e.jsx(Q,{style:[$.cell,{flexGrow:P[2],flexBasis:P[2]}],children:e.jsx(Z,{children:I!=null?String(I):""})})]})}function Gn({sheetRows:r=[],players:p=[],metadata:f={}}){const y=p.filter(c=>c.team==="A").sort((c,a)=>(c.seat||0)-(a.seat||0)),L=p.filter(c=>c.team==="B").sort((c,a)=>(c.seat||0)-(a.seat||0)),j=y.filter(c=>(c.seat||0)>=1&&(c.seat||0)<=4).sort((c,a)=>c.seat-a.seat),M=L.filter(c=>(c.seat||0)>=1&&(c.seat||0)<=4).sort((c,a)=>c.seat-a.seat),A=y.find(c=>(c.seat||0)===5&&c.status==="active"),I=L.find(c=>(c.seat||0)===5&&c.status==="active"),k=A?[...j,A]:[...j],E=I?[...M,I]:[...M],P=(c,a)=>c&&c.name?Wn(c.name,9):a,u=k.map((c,a)=>P(c,["Captain","P1","P2","P3","Sub"][a]||"P"+(a+1))),S=E.map((c,a)=>P(c,["Captain","P1","P2","P3","Sub"][a]||"P"+(a+1))),R=Fn(k.length),D=zn(E.length);function U(c,a){if(!c.length)return{};const w={};for(const m of r){if(!m||m.pad)continue;const b=m.index;for(const T of m.attempts||[])!T||T.team!==a||c.includes(T.playerId)&&(w[T.playerId]=b)}const N={};for(const m of c){const b=w[m];b&&b<25&&(N[m]=b+1)}return N}const B=y.filter(c=>c.status==="replaced").map(c=>c.id),F=L.filter(c=>c.status==="replaced").map(c=>c.id),K=U(B,"A"),te=U(F,"B");return e.jsx(En,{children:e.jsxs($n,{size:"LETTER",style:$.page,orientation:"landscape",children:[e.jsx(Z,{style:$.title,children:"Coaches Scoresheet"}),e.jsxs(Q,{style:$.legendBlock,children:[e.jsx(Z,{style:$.tiny,children:"Subjects: E ESS | C Chemistry | B Bio | M Math | P Physics | EN Energy"}),e.jsx(Z,{style:$.tiny,children:"Types: MC Multiple Choice | SA Short Answer | Markers: C / CI / I / II | 'out' = player substituted"})]}),e.jsxs(Q,{style:$.tablesWrap,children:[e.jsxs(Q,{style:$.teamACol,children:[e.jsx(_n,{playerLabels:u,cols:R}),r.slice(0,25).map(c=>e.jsx(qn,{r:c,seatPlayers:k,outRows:K,cols:R},"A-"+c.index))]}),e.jsxs(Q,{style:$.teamBCol,children:[e.jsx(Un,{playerLabels:S,cols:D}),r.slice(0,25).map(c=>e.jsx(On,{r:c,seatPlayers:E,outRows:te,cols:D},"B-"+c.index))]})]}),e.jsxs(Z,{style:$.footer,children:["Generated ",f.generatedAt||""," | scibowl.app"]})]})})}function Wn(r,p){return r?r.length<=p?r:r.slice(0,p-1)+"…":""}function Vn({pair:r,index:p,scorekeeping:f=!1,currentIndex:y=0,tossupResults:L=[],showBonusContent:j,questionRef:M}){const A=r.tossup?ze(r.tossup):[],I=r.bonus?ze(r.bonus):[],k=!f||p===y,[E,P]=X.useState(null),[u,S]=X.useState(!1);return X.useEffect(()=>{let R=!1;async function D(){P(null);const U=r?.bonus;if(!U||!(U.is_visual_bonus===!0||String(U.visual||"").toLowerCase()==="true"))return;const F=await cs({tournament:U.tournament,round:U.round,question_number:U.question_number}).catch(()=>null);R||P(F)}return j&&D(),()=>{R=!0}},[r?.bonus?.tournament,r?.bonus?.round,r?.bonus?.question_number,j]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:M,className:`glass p-6 space-y-4 min-w-0 relative ${f&&!k?"opacity-50 blur-sm select-none pointer-events-none":""}`,children:[f&&p===y&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-0 rounded-lg pointer-events-none border-2 border-green-500 shadow-[0_0_0_3px_rgba(34,197,94,0.35)]",style:{boxShadow:"0 0 0 3px rgba(34,197,94,0.35), 0 4px 12px -2px rgba(16,185,129,0.5)"}}),e.jsx("div",{className:"absolute -top-3 left-4 px-3 py-1 bg-green-600 text-white rounded-full text-[11px] font-semibold shadow-lg",children:"Active"})]}),r.tossup&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-sm text-black/60 dark:text-white/80 mb-2",children:[e.jsx("span",{className:"font-semibold",children:String(r.tossup.tournament).toUpperCase()})," • ","Round ",r.tossup.round??"—"," • ",r.tossup.category,r.tossup.question_number!=null&&e.jsxs(e.Fragment,{children:[" • ","Q",r.tossup.question_number]}),e.jsx("span",{className:"ml-2 inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold tracking-wide border "+(A.length>0?"bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-900/20 dark:text-blue-200 dark:border-blue-700":"bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/20 dark:text-purple-200 dark:border-purple-700"),children:A.length>0?"MULTIPLE CHOICE":"SHORT ANSWER"})]}),e.jsxs("div",{className:"font-medium mb-2",children:["Toss-up ",p+1]}),e.jsx("div",{className:"mb-3 whitespace-pre-line",children:e.jsx(pe,{children:r.tossup.question})}),A.length>0&&e.jsx("div",{className:"mb-3",children:A.map(([R,D])=>e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`gen-tossup-${p}`,className:"accent-tint",disabled:!0}),e.jsxs("span",{children:[R.toUpperCase(),") ",e.jsx(pe,{children:D})]})]},R))}),e.jsxs("div",{className:"text-sm text-black/70 dark:text-white/80",children:[e.jsx("span",{className:"uppercase text-black/60 dark:text-white/60",children:"Answer:"})," ",e.jsx("span",{className:"text-black dark:text-white",children:e.jsx(pe,{children:r.tossup.answer})})]})]}),r.bonus&&j&&e.jsxs("div",{className:r.tossup?"mt-6 pt-4 border-t":"mt-2",children:[e.jsxs("div",{className:"text-sm text-black/60 dark:text-white/80 mb-2",children:[e.jsx("span",{className:"font-semibold",children:String(r.tossup?r.tossup.tournament:r.bonus.tournament).toUpperCase()})," • ","Round ",r.bonus.round??"—"," • ",r.bonus.category,r.bonus.question_number!=null&&e.jsxs(e.Fragment,{children:[" • ","Q",r.bonus.question_number]}),e.jsx("span",{className:"ml-2 inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold tracking-wide border "+(I.length>0?"bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-900/20 dark:text-blue-200 dark:border-blue-700":"bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/20 dark:text-purple-200 dark:border-purple-700"),children:I.length>0?"MULTIPLE CHOICE":"SHORT ANSWER"})]}),e.jsxs("div",{className:"font-semibold mb-2",children:["Bonus ",p+1]}),E&&e.jsxs("div",{className:"mb-3",children:[e.jsx("img",{src:E,alt:`Visual bonus${r?.bonus?.tournament?` • ${r.bonus.tournament}`:""}${r?.bonus?.round?` • Round ${r.bonus.round}`:""}${r?.bonus?.question_number!=null?` • Q${r.bonus.question_number}`:""}`,className:"max-h-64 rounded-md border border-black/10 dark:border-white/10 object-contain cursor-zoom-in hover:opacity-95 transition",onClick:()=>S(!0)}),e.jsx("div",{className:"text-xs text-black/60 dark:text-white/60 mt-1",children:"Click image to view full screen"})]}),e.jsx("div",{className:"mb-2 whitespace-pre-line",children:e.jsx(pe,{children:r.bonus.question})}),I.length>0&&e.jsx("div",{className:"mb-3",children:I.map(([R,D])=>e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`gen-bonus-${p}`,className:"accent-tint",disabled:!0}),e.jsxs("span",{children:[R.toUpperCase(),") ",e.jsx(pe,{children:D})]})]},R))}),e.jsxs("div",{className:"text-sm text-black/70 dark:text-white/80",children:[e.jsx("span",{className:"uppercase text-black/60 dark:text-white/60",children:"Answer:"})," ",e.jsx("span",{className:"text-black dark:text-white",children:e.jsx(pe,{children:r.bonus.answer})})]})]})]}),u&&E&&e.jsxs("div",{className:"fixed inset-0 z-[90] flex items-center justify-center",role:"dialog","aria-modal":"true","aria-label":"Visual bonus image",children:[e.jsx("div",{className:"absolute inset-0 bg-black/80",onClick:()=>S(!1)}),e.jsxs("div",{className:"relative max-w-[96vw] max-h-[96vh] p-2",children:[e.jsx("img",{src:E,alt:"Visual bonus full screen",className:"max-w-[96vw] max-h-[92vh] object-contain rounded shadow-2xl"}),e.jsx("button",{type:"button",className:"absolute -top-3 -right-3 bg-white text-black rounded-full shadow p-2 hover:bg-white/90 focus:outline-none","aria-label":"Close full screen image",onClick:()=>S(!1),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"h-4 w-4",children:e.jsx("path",{fillRule:"evenodd",d:"M4.22 4.22a.75.75 0 011.06 0L10 8.94l4.72-4.72a.75.75 0 111.06 1.06L11.06 10l4.72 4.72a.75.75 0 11-1.06 1.06L10 11.06l-4.72 4.72a.75.75 0 01-1.06-1.06L8.94 10 4.22 5.28a.75.75 0 010-1.06z",clipRule:"evenodd"})})})]}),e.jsx(Hn,{onClose:()=>S(!1)})]})]})}function Hn({onClose:r}){return X.useEffect(()=>{const p=f=>{f.key==="Escape"&&r?.()};return window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)},[r]),null}function Qn({displayPairs:r,QUESTIONS_PER_PAGE:p=2,pdfRef:f}){const[y,L]=X.useState({});return X.useEffect(()=>{let j=!1;return(async()=>{const M={};for(let A=0;A<r.length;A++){const I=r[A]?.bonus;if(!(!I||!(I.is_visual_bonus===!0||String(I.visual||"").toLowerCase()==="true")))try{const E=await cs({tournament:I.tournament,round:I.round,question_number:I.question_number});E&&(M[A]=E)}catch{}}j||L(M)})(),()=>{j=!0}},[r]),e.jsx("div",{"aria-hidden":"true",style:{position:"fixed",left:"-10000px",top:0,width:816,pointerEvents:"none",opacity:0,visibility:"visible"},children:e.jsxs("div",{ref:f,className:"pdf-root",children:[e.jsx("style",{children:`
          .pdf-root, .pdf-root * { box-sizing: border-box; }
          .html2pdf__page-break + .pdf-header { margin-top: 0 !important; }
          @page { margin: 12mm; }
          .pdf-root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, 'Apple Color Emoji', 'Segoe UI Emoji'; color: #000; margin: 0; padding: 0; }
          .pdf-page { width: 720px; margin: 0 auto; padding: 2mm 4px 0 4px; }
          .pdf-page { page-break-after: always; }
          .pdf-page:last-child { page-break-after: auto; }
          .pdf-header { text-align: center; font-size: 16px; font-weight: bold; margin-bottom: 2mm; padding: 0 2px; }
          .pdf-q { page-break-inside: avoid; break-inside: avoid; margin-bottom: 4mm; }
          .pdf-hr { border: none; border-top: 1px solid #888; margin: 8px 0; }
          .pdf-meta { font-size: 11px; color: #333; margin-bottom: 2mm; }
          .pdf-title { font-weight: 600; margin-bottom: 2mm; }
          .pdf-body { white-space: pre-wrap; line-height: 1.4; word-break: break-word; overflow-wrap: anywhere; }
          .pdf-choices { margin: 2mm 0; break-inside: avoid; }
          .pdf-choice { display: flex; align-items: flex-start; gap: 4px; line-height: 1.35; }
          .pdf-choice-key { font-weight: 600; width: 16px; flex: 0 0 auto; }
          .pdf-choice-val { flex: 1; }
          .pdf-ans { font-size: 12px; margin-top: 2mm; }
          .pdf-footer { text-align: center; font-size: 12px; color: #888; margin-top: 2mm; }
          .katex-display { margin: 0; }
        `}),(()=>{const j=[];for(let I=0;I<r.length;I+=p){const k=r.slice(I,I+p);k.length>0&&j.push(k)}const M=new Date().toLocaleDateString(),A="scibowl.app";return j.map((I,k)=>{const E=k*p,P=k+1;return e.jsxs("div",{className:"pdf-page",children:[e.jsxs("div",{className:"pdf-header",children:[A," — ",M]}),I.map((u,S)=>{const R=E+S,D=u.tossup?ze(u.tossup):[],U=u.bonus?ze(u.bonus):[];return e.jsxs(X.Fragment,{children:[e.jsxs("div",{className:"pdf-q",children:[u.tossup&&e.jsxs("div",{children:[e.jsxs("div",{className:"pdf-meta",children:[u.tossup.tournament," • Round ",u.tossup.round??"—"," • ",u.tossup.category,u.tossup.question_number!=null?` • Q${u.tossup.question_number}`:"",e.jsx("span",{style:D.length>0?lt("mc"):lt("sa"),children:D.length>0?"MULTIPLE CHOICE":"SHORT ANSWER"})]}),e.jsxs("div",{className:"pdf-title",children:["Toss-up ",R+1]}),e.jsx("div",{className:"pdf-body",children:e.jsx(pe,{children:u.tossup.question})}),D.length>0&&e.jsx("div",{className:"pdf-choices",children:D.map(([B,F])=>e.jsxs("div",{className:"pdf-choice",children:[e.jsxs("span",{className:"pdf-choice-key",children:[B.toUpperCase(),")"]}),e.jsx("span",{className:"pdf-choice-val",children:e.jsx(pe,{children:F})})]},B))}),e.jsxs("div",{className:"pdf-ans",children:[e.jsx("span",{style:{opacity:.7},children:"Answer:"})," ",e.jsx(pe,{children:u.tossup.answer})]})]}),u.bonus&&e.jsxs("div",{style:{marginTop:u.tossup?"6mm":0,paddingTop:u.tossup?"2mm":0,borderTop:u.tossup?"1px solid #ddd":"none"},children:[e.jsxs("div",{className:"pdf-meta",children:[u.tossup?u.tossup.tournament:u.bonus.tournament," • Round ",u.bonus.round??"—"," • ",u.bonus.category,u.bonus.question_number!=null?` • Q${u.bonus.question_number}`:"",e.jsx("span",{style:U.length>0?lt("mc"):lt("sa"),children:U.length>0?"MULTIPLE CHOICE":"SHORT ANSWER"})]}),e.jsxs("div",{className:"pdf-title",children:["Bonus ",R+1]}),y[R]&&e.jsx("div",{className:"pdf-body",style:{marginBottom:"2mm"},children:e.jsx("img",{src:y[R],alt:"Visual bonus",style:{maxHeight:220,width:"100%",objectFit:"contain",border:"1px solid #e5e7eb",borderRadius:6}})}),e.jsx("div",{className:"pdf-body",children:e.jsx(pe,{children:u.bonus.question})}),U.length>0&&e.jsx("div",{className:"pdf-choices",children:U.map(([B,F])=>e.jsxs("div",{className:"pdf-choice",children:[e.jsxs("span",{className:"pdf-choice-key",children:[B.toUpperCase(),")"]}),e.jsx("span",{className:"pdf-choice-val",children:e.jsx(pe,{children:F})})]},B))}),e.jsxs("div",{className:"pdf-ans",children:[e.jsx("span",{style:{opacity:.7},children:"Answer:"})," ",e.jsx(pe,{children:u.bonus.answer})]})]})]}),S<I.length-1&&e.jsx("hr",{className:"pdf-hr"})]},`pdf-${R}`)}),e.jsxs("div",{className:"pdf-footer",children:["Page ",P," of ",j.length]})]},`pdf-group-${k}`)})})()]})})}function lt(r){return r==="mc"?{marginLeft:6,border:"1px solid #bfdbfe",background:"#eff6ff",color:"#1d4ed8",borderRadius:9999,padding:"1px 6px",fontSize:10,fontWeight:600}:{marginLeft:6,border:"1px solid #e9d5ff",background:"#faf5ff",color:"#6b21a8",borderRadius:9999,padding:"1px 6px",fontSize:10,fontWeight:600}}function Xn({searchInput:r,setSearchInput:p,committedSearch:f,setCommittedSearch:y,hasGenerated:L=!1}){return e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold mb-2 flex items-center gap-2",children:["Search",f&&e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs",onClick:()=>{p(""),y("")},"aria-label":"Clear search",children:"Clear"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(vn,{className:"h-4 w-4 absolute left-2 top-1/2 -translate-y-1/2 text-black/50 dark:text-white/50 pointer-events-none"}),e.jsx("input",{type:"text",value:r,onChange:j=>p(j.target.value),onKeyDown:j=>{j.key==="Enter"&&y(r)},placeholder:"Find text in generated round...",className:"w-full pl-8 pr-3 py-1.5 rounded-lg border border-black/10 bg-white dark:bg-darkcard text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Search questions",disabled:!L})]}),e.jsx("button",{type:"button",className:"btn btn-fancy whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed",disabled:!L||!r.trim()||r.trim()===f.trim(),onClick:()=>y(r),children:"Search"})]}),f.trim()&&e.jsxs("div",{className:"text-xs mt-1 opacity-70",children:['Showing all matches containing "',f,'" (ignores other filters except selected tournaments for loading).']})]})}function Yn({headerOffset:r,close:p,currentIndex:f,displayPairs:y,awaitingPlayer:L,interruptArmed:j,setAwaitingPlayer:M,setInterruptArmed:A,typedAnswerActive:I,setTypedAnswerActive:k,typedAnswerText:E,setTypedAnswerText:P,typedAnswerPlayerId:u,typedAnswerLoading:S,typedAnswerReason:R,checkTypedAnswer:D,isTossupFinal:U,recordNoAnswer:B,throwOutAndReplace:F,tossupResults:K,bonusResults:te,saveFixedBonus:c,players:a,handleSeatClick:w,allowedTeams:N,totalPoints:m,teamPoints:b,saveBonusPoints:T,subMode:z,setSubMode:h,resetScorekeeping:J,exportCoachesScoresheetPdf:se,coachesSheetLoading:oe,tryoutsMode:_e,setTryoutsMode:fe,questionType:ge}){return e.jsxs("div",{className:"fixed right-0 z-50 w-[400px] bg-white dark:bg-darkcard border-l border-black/10 dark:border-white/10 shadow-xl flex flex-col",style:{top:r,height:`calc(100vh - ${r}px)`},children:[e.jsxs("div",{className:"px-4 py-3 border-b border-black/10 dark:border-white/10 flex items-center justify-between",children:[e.jsx("h2",{className:"font-semibold text-sm",children:"Scorekeeper"}),e.jsx("button",{className:"text-xs chip",onClick:p,children:"Close"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-4 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{children:["Q ",Math.min(f+1,y.length)," / ",y.length]}),e.jsx("div",{className:"text-[10px] mt-0.5 opacity-70",children:N.length===0?"No buzz":"Buzz: "+N.join("/")})]}),e.jsxs("div",{className:"font-semibold text-xs leading-tight flex flex-col items-end",children:[e.jsxs("span",{children:["Total ",m]}),e.jsxs("span",{className:"text-green-600 dark:text-green-400",children:["A ",b.A]}),e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:["B ",b.B]})]})]}),f>=y.length&&e.jsx("div",{className:"p-2 rounded bg-emerald-600 text-white text-center text-xs",children:"Round complete"}),f<y.length&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-[11px] font-medium",children:[e.jsx("input",{type:"checkbox",className:"scale-110",checked:!!_e,onChange:V=>fe(V.target.checked),disabled:ge!=="tossup",title:ge==="tossup"?"Tryouts mode: an incorrect buzz only locks that player; others may continue buzzing.":"Switch question type to Toss-ups to enable Tryouts mode."}),"Tryouts"]}),ge!=="tossup"&&e.jsx("span",{className:"text-[10px] opacity-60",children:"Toss-ups only"})]}),e.jsxs("div",{className:"grid grid-cols-6 gap-2",children:[e.jsxs("button",{className:`col-span-2 chip flex items-center justify-center gap-1 text-xs disabled:opacity-40 disabled:cursor-not-allowed disabled:brightness-75 ${L?.type==="incorrect"?"ring-2 ring-red-500":""}`,onClick:()=>M({type:"incorrect",interrupt:j}),disabled:U(f),title:"Mark incorrect then click player seat (then select player)",children:[e.jsx(kn,{color:"#ff2600",className:"h-4 w-4"})," Incorrect"]}),e.jsxs("button",{className:`col-span-2 chip flex items-center justify-center gap-1 text-xs disabled:opacity-40 disabled:cursor-not-allowed disabled:brightness-75 ${L?.type==="correct"?"ring-2 ring-green-500":""}`,onClick:()=>M({type:"correct",interrupt:j}),disabled:U(f),title:"Mark correct then click player seat",children:[e.jsx(Nn,{color:"#00f900",className:"h-4 w-4"})," Correct"]}),e.jsx("button",{className:`col-span-2 chip flex items-center justify-center gap-1 text-xs disabled:opacity-40 disabled:cursor-not-allowed disabled:brightness-75 ${j?"bg-purple-600 text-white ring-2 ring-purple-500":""}`,onClick:()=>A(V=>!V),disabled:U(f),title:"Toggle interrupt (applies to next correct/incorrect)",children:j?"Interrupt ON":"Interrupt"})]}),j&&y[f]?.tossup&&!U(f)&&e.jsxs("div",{className:"space-y-1 rounded-md border border-black/10 dark:border-white/10 p-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-[11px] font-medium",children:"Typed answer (AI check)"}),e.jsx("button",{type:"button",className:`chip text-[11px] px-2 py-0.5 ${I?"bg-purple-600 text-white":""}`,onClick:()=>k(V=>!V),title:"Toggle typed answer entry for interrupts",children:I?"Hide":"Type Answer"})]}),I&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-[10px] opacity-70",children:"Select a player seat, then enter the answer as given and check with AI."}),e.jsx("input",{type:"text",className:"w-full rounded border border-black/10 dark:border-white/10 bg-white dark:bg-darkcard px-2 py-1 text-xs",placeholder:"Type the player’s answer…",value:E,onChange:V=>P(V.target.value),disabled:S}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"text-[10px]",children:["Seat: ",u?"selected":"—"]}),e.jsx("button",{type:"button",className:"chip text-[11px] bg-tint text-white disabled:opacity-50 disabled:cursor-not-allowed",onClick:D,disabled:S||!u||!E.trim(),children:S?"Checking…":"Check with AI"})]}),R&&e.jsxs("div",{className:"text-[10px] opacity-80",children:["AI: ",R]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{className:"chip text-xs disabled:opacity-40 disabled:cursor-not-allowed",onClick:B,disabled:U(f),title:"Record as no answer and advance (attempts already made remain in the log)",children:"No Answer"}),e.jsx("button",{className:"chip text-xs",onClick:F,children:"Throw Out & Replace"})]}),K[f]?.result==="correct"&&y[f]?.bonus&&y[f]?.tossup&&!te[f]&&e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("button",{className:"chip text-xs bg-green-600 text-white hover:bg-green-700",onClick:()=>{c(!0)},children:"Award +10"}),e.jsx("button",{className:"chip text-xs bg-red-600 text-white hover:bg-red-700",onClick:()=>{c(!1)},children:"No Bonus"})]}),te[f]&&e.jsxs("div",{className:"text-xs",children:["Bonus: ",te[f].points," pts"]}),L&&e.jsxs("div",{className:"text-xs text-center text-blue-600 dark:text-blue-300",children:["Select a player seat to apply a ",L.interrupt?"Interrupt ":"",L.type,"."]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium flex items-center gap-2 justify-between",children:[e.jsxs("span",{children:["Players ",z&&e.jsx("span",{className:"text-[10px] font-normal px-1.5 py-0.5 rounded bg-purple-600 text-white",children:"SUB MODE"})]}),e.jsx("button",{type:"button",className:"chip px-2 py-1 text-[11px]",onClick:()=>h(!0),title:"Open substitution modal",children:"Substitute"})]}),e.jsx("div",{className:"space-y-6",children:["A","B"].map(V=>e.jsxs("div",{children:[e.jsxs("div",{className:`text-[12px] font-semibold mb-2 tracking-wide ${V==="A"?"text-green-600 dark:text-green-400":"text-blue-600 dark:text-blue-400"}`,children:["Team ",V]}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:a.filter(G=>G.team===V).map(G=>{const Me=a.findIndex(Xe=>Xe.id===G.id);let je=G.status==="replaced"||L&&!N.includes(G.team);return _e&&ge==="tossup"&&L&&((K[f]?.attempts||[]).some(dt=>dt.playerId===G.id)?je=!0:je=G.status==="replaced"),e.jsxs("button",{onClick:()=>w(Me),className:`relative flex flex-col items-center justify-center h-24 rounded-xl border border-black/10 dark:border-white/10 ${je?"bg-black/10 dark:bg-white/10 opacity-40 cursor-not-allowed":"bg-gradient-to-br from-black/5 to-black/10 dark:from-white/10 dark:to-white/5 hover:from-black/10 hover:to-black/20 dark:hover:from-white/20 dark:hover:to-white/10"} transition text-[11px] font-medium ${L&&!je&&G.status!=="replaced"?"ring-2 ring-offset-2 ring-green-500 dark:ring-green-400 animate-pulse-slow":""}`,title:G.name||`Seat ${V}${G.seat??(G.id<=4?G.id:G.id-4)}`,disabled:G.status==="replaced",children:[e.jsx(Sn,{className:"h-7 w-7 opacity-70"}),e.jsx("span",{className:"mt-2 truncate max-w-[120px] px-2 text-center leading-tight",children:G.name||`Seat ${V}${G.seat??(G.id<=4?G.id:G.id-4)}`}),G.status==="replaced"&&e.jsx("span",{className:"absolute top-1 left-1 text-[10px] bg-red-600 text-white px-1 rounded",children:"OUT"}),G.stats.correct+G.stats.correctInterrupt>0&&e.jsx("span",{className:"absolute top-0 right-0 text-[10px] bg-green-600 text-white rounded-bl px-1",children:G.stats.correct+G.stats.correctInterrupt})]},G.id)})})]},V))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium mb-1",children:"Player Stats"}),e.jsxs("table",{className:"w-full text-[10px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-[9px] text-black/70 dark:text-white/70",children:[e.jsx("th",{className:"text-left",children:"Player"}),e.jsx("th",{children:"Tm"}),e.jsx("th",{children:"C"}),e.jsx("th",{children:"I"}),e.jsx("th",{children:"CI"}),e.jsx("th",{children:"II"})]})}),e.jsx("tbody",{children:a.filter(V=>V.name).map(V=>e.jsxs("tr",{className:"odd:bg-black/0 even:bg-black/5 dark:even:bg-white/5",children:[e.jsx("td",{className:"truncate max-w-[90px] pr-1",children:V.name}),e.jsx("td",{className:"text-center",children:V.team}),e.jsx("td",{className:"text-center",children:V.stats.correct}),e.jsx("td",{className:"text-center",children:V.stats.incorrect}),e.jsx("td",{className:"text-center",children:V.stats.correctInterrupt}),e.jsx("td",{className:"text-center",children:V.stats.incorrectInterrupt})]},V.id))})]})]}),f>=y.length&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{className:"btn btn-orange w-full justify-center",onClick:se,disabled:oe,children:oe?"Generating…":"Coaches Scoresheet PDF"}),e.jsx("button",{className:"btn btn-ghost w-full justify-center",onClick:()=>J(),children:"Reset Scorekeeping"})]})]})]})}function Kn({open:r,onClose:p,players:f,onSubmit:y,initialTeam:L="A"}){const[j,M]=x.useState(L),[A,I]=x.useState(null),[k,E]=x.useState(""),[P,u]=x.useState(!1);if(x.useEffect(()=>{if(r){M(L);const B=f.filter(F=>F.team===L)[0];I(B?.id??null),E(""),u(!1)}},[r,L,f]),!r)return null;const S=f.filter(B=>B.team===j),D=f.filter(B=>B.team===j).length>=5,U=k.trim().length>0&&A!=null&&!D;return f.find(B=>B.id===A),e.jsxs("div",{className:"fixed inset-0 z-[75] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:p}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl w-full max-w-md border border-black/10 dark:border-white/10 p-6 flex flex-col gap-5",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Substitute Player"}),e.jsx("button",{type:"button",className:"chip text-xs",onClick:p,children:"Close"})]}),e.jsxs("div",{className:"space-y-4 text-sm",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"font-medium text-xs uppercase tracking-wide",children:"Team"}),e.jsx("div",{className:"flex gap-2",children:["A","B"].map(B=>e.jsxs("button",{type:"button",className:`chip px-3 py-1 text-sm ${j===B?"ring-2 ring-tint bg-tint/10":""}`,onClick:()=>{M(B);const F=f.filter(K=>K.team===B)[0];I(F?.id??null)},children:["Team ",B]},B))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"font-medium text-xs uppercase tracking-wide",children:"Outgoing Seat"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:S.map(B=>e.jsxs("button",{type:"button",onClick:()=>I(B.id),className:`chip flex flex-col items-center gap-1 py-2 ${A===B.id?"ring-2 ring-tint bg-tint/10":""}`,children:[e.jsx("span",{className:"text-[11px] font-semibold",children:B.name||`Seat ${j}${B.seat??(B.id<=4?B.id:B.id-4)}`}),B.name&&e.jsxs("span",{className:"text-[10px] opacity-60",children:[B.stats.correct+B.stats.correctInterrupt," C / ",B.stats.incorrect+B.stats.incorrectInterrupt," I"]})]},B.id))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"font-medium text-xs uppercase tracking-wide",htmlFor:"new-player-name",children:"New Player Name"}),e.jsx("input",{id:"new-player-name",type:"text",className:"w-full rounded-lg border border-black/10 dark:border-white/10 bg-white dark:bg-darkcard px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-tint",placeholder:"Enter name",value:k,onChange:B=>{E(B.target.value),u(!0)},autoFocus:!0}),P&&k.trim()===""&&e.jsx("div",{className:"text-[11px] text-red-600 mt-1",children:"Name required."})]}),D&&e.jsx("div",{className:"text-[11px] text-red-600",children:"Team already has a substitute (5 players shown). Further substitutions disabled."})]}),e.jsxs("div",{className:"flex flex-col gap-2 pt-2",children:[e.jsx("button",{type:"button",disabled:!U,onClick:()=>{U&&(y({team:j,playerId:A,newName:k.trim()}),p())},className:"btn btn-primary w-full justify-center disabled:opacity-40 disabled:cursor-not-allowed",children:"Apply Substitution"}),e.jsx("button",{type:"button",onClick:p,className:"btn btn-ghost w-full justify-center",children:"Cancel"})]})]})]})}function Jn({leftPaneCollapsed:r,leftPanePinned:p,leftPaneHovered:f,setLeftPaneCollapsed:y,setLeftPanePinned:L,setLeftPaneHovered:j}){return e.jsx("button",{className:"absolute top-2 -right-2 bg-white dark:bg-darkcard border border-black/10 dark:border-white/20 rounded-full p-1 shadow hover:bg-gray-50 dark:hover:bg-white/10 transition z-10",onClick:()=>{r||!p?(y(!1),L(!0)):(L(!1),y(!0))},onMouseEnter:()=>j(!0),onMouseLeave:()=>j(!1),title:r?"Expand panel":p?"Unpin panel":"Pin panel",children:r?f?e.jsx(rs,{className:"h-4 w-4"}):e.jsx(Cn,{className:"h-4 w-4 transition-transform rotate-180"}):p?e.jsx(An,{className:"h-4 w-4"}):e.jsx(rs,{className:"h-4 w-4"})})}function _o({questions:r=[],lazy:p=null,auth:f=null,persistedGenerated:y=null,setPersistedGenerated:L=null,onNewRound:j=null}){const{isLazy:M,tournaments:A,tournamentGroups:I,selectedTournaments:k,setSelectedTournaments:E,selectedCategories:P,setSelectedCategories:u,tournamentGroupsOpen:S,setTournamentGroupsOpen:R,tournamentVisibleEntriesMainRef:D,handleTournamentToggle:U,loadedQuestions:B,validQuestions:F,categories:K,roundRanges:te,setRoundRanges:c,roundsByTournament:a,globalNumericRoundMax:w,inRanges:N}=rn({questions:r,lazy:p}),[m,b]=x.useState(!1),[T,z]=x.useState([]);function h(t,s="info",i=4e3){const o=Math.random().toString(36).slice(2),l=Date.now();z(n=>[...n,{id:o,message:t,type:s,ttl:i,created:l}]),i>0&&setTimeout(()=>z(n=>n.filter(d=>d.id!==o)),i+50)}const{roundsIndex:J,setRoundsIndex:se,loadingUserRounds:oe,roundFolders:_e,setRoundFolders:fe,foldersOpen:ge,setFoldersOpen:V,selectedExcludeRoundIds:G,setSelectedExcludeRoundIds:Me,excludeDetailCache:je,handleExcludeRoundToggle:Xe,refresh:dt,deleteFolderAndRounds:ds}=Dn({auth:f,pushToast:h});x.useRef(null),x.useRef(null);const[us,ms]=x.useState(!1),[he,ps]=x.useState(10),[fs,hs]=x.useState([]),ue=Array.isArray(y)?y:fs,ye=typeof L=="function"?L:hs,{history:ee}=on(),[Ue,ut]=x.useState(null);X.useEffect(()=>{Array.isArray(ee)&&ee.length>0?ut(ee.length-1):ut(null)},[ee]);function Tt(t){if(!Array.isArray(ee)||ee.length===0||t<0||t>=ee.length)return;vt(""),ut(t);const s=ee[t]||[];ye(s),Pe(!0),Ze();try{window.scrollTo({top:0,behavior:"smooth"})}catch{}}const[xe,xs]=x.useState(!0),[be,bs]=x.useState(!0),[we,gs]=x.useState(!1),[re,Mt]=x.useState("both"),mt=xe&&be&&we,Et=!xe&&be&&we;X.useEffect(()=>{let t="both";xe&&be?t="both":xe&&!be?t="tossup":!xe&&be&&!we?t="bonus":!xe&&!be&&we?t="visual-bonus":!xe&&be&&we?t="bonus":t="both",Mt(t)},[xe,be,we]);const $t=X.useRef(null),ys=2,[Pt,Dt]=x.useState(!1),[Ye,Ft]=x.useState(!1),[ws,js]=x.useState(!1),[vs,ks]=x.useState(()=>{try{return document.documentElement.classList.contains("dark")}catch{return!1}});X.useEffect(()=>{try{const t=document.documentElement,s=()=>ks(t.classList.contains("dark"));s();const i=new MutationObserver(s);i.observe(t,{attributes:!0,attributeFilter:["class"]});const o=window.matchMedia("(prefers-color-scheme: dark)");return o.addEventListener("change",s),()=>{i.disconnect(),o.removeEventListener("change",s)}}catch{}},[]);const[ae,zt]=x.useState(!1),Ns=x.useRef(9),[Y,qe]=x.useState(()=>Array.from({length:8},(t,s)=>({id:s+1,team:s<4?"A":"B",seat:s<4?s+1:s-3,name:"",status:"active",stats:{correct:0,incorrect:0,correctInterrupt:0,incorrectInterrupt:0}}))),[O,pt]=x.useState(0),[ie,Se]=x.useState(null),[Ss,Ee]=x.useState(!1),[ft,ht]=x.useState(!1),[_t,xt]=x.useState(""),[bt,gt]=x.useState(null),[Cs,Ut]=x.useState(!1),[As,yt]=x.useState(""),[le,Oe]=x.useState([]),[ve,Ke]=x.useState([]),[qt,me]=x.useState(null),[wt,ce]=x.useState(["A","B"]),[Ce,Ot]=x.useState(!1);X.useEffect(()=>{try{localStorage.getItem("sb_tryoutsMode")==="1"&&Ot(!0)}catch{}},[]),X.useEffect(()=>{try{localStorage.setItem("sb_tryoutsMode",Ce?"1":"0")}catch{}},[Ce]);const[Rs,Gt]=x.useState(!1),[Zn,er]=x.useState("A"),[Bs,Wt]=x.useState(!1),[Ls,Je]=x.useState(""),[jt,Vt]=x.useState(0),Ht=x.useRef([]);X.useEffect(()=>{function t(){const s=document.querySelector("header, .site-header, .app-header, .top-bar");if(s){const i=s.getBoundingClientRect();Vt(i.height)}else Vt(0)}return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),X.useEffect(()=>{if(!ae)return;const t=Ht.current[O];if(t&&typeof t.scrollIntoView=="function"){const s=Math.max(jt+12,0),i=t.getBoundingClientRect(),o=window.scrollY+i.top-s;window.scrollTo({top:o,behavior:"smooth"})}},[O,ae,jt]);const Is=x.useMemo(()=>{let t=0;return le.forEach(s=>{s&&(Array.isArray(s.attempts)?s.attempts.forEach(i=>{typeof i.points=="number"&&(t+=i.points)}):typeof s.points=="number"&&(t+=s.points))}),ve.forEach(s=>{s&&typeof s.points=="number"&&(t+=s.points)}),t},[le,ve]),Ts=x.useMemo(()=>{const t={A:0,B:0};return le.forEach(s=>{if(s){if(Array.isArray(s.attempts)&&s.attempts.length)s.attempts.forEach(i=>{const o=Y.find(l=>l.id===i.playerId)?.team;o&&(t[o]+=i.points||0)});else if(s.playerId){const i=Y.find(o=>o.id===s.playerId)?.team;i&&(t[i]+=s.points||0)}}}),ve.forEach(s=>{s?.team&&(t[s.team]+=s.points||0)}),t},[le,ve,Y]);function Ze(){pt(0),Se(null),Oe([]),Ke([]),Je(""),me(null),ce(["A","B"]),Gt(!1)}function Ms(t){const s=Y[t];if(s){if(ft){if(!wt.includes(s.team)){h(`Team ${s.team} not allowed to buzz now.`,"error");return}if(s.status==="replaced"){h("Cannot buzz: seat replaced.","error");return}if(Ce&&re==="tossup"&&(le[O]?.attempts||[]).some(o=>o.playerId===s.id)){h("This player already attempted this toss-up.","error");return}gt(s.id),h(`Selected ${s.name||`Seat ${s.team}${s.seat??""}`} for typed interrupt.`,"info",2500);return}if(s.status==="replaced"){h("Cannot buzz: seat replaced.","error");return}if(ie){if(!wt.includes(s.team)){h(`Team ${s.team} not allowed to buzz now.`,"error");return}const{type:i,interrupt:o}=ie,l=qt==null;if(Oe(n=>{const d=[...n],g=i==="correct"?4:i==="incorrect"&&o?-4:0,C=d[O]||{},v=Array.isArray(C.attempts)?[...C.attempts]:[];return v.push({playerId:s.id,team:s.team,result:i,interrupt:o,points:g}),i==="correct"?d[O]={...C,attempts:v,result:"correct",playerId:s.id,interrupt:o,points:g}:l?d[O]={...C,attempts:v,result:"incorrect",playerId:s.id,interrupt:o,points:g}:d[O]={...C,attempts:v,result:"incorrect",playerId:s.id,interrupt:o,points:g},d}),qe(n=>n.map(d=>d.id===s.id?{...d,stats:{...d.stats,correct:d.stats.correct+(ie.type==="correct"&&!ie.interrupt?1:0),incorrect:d.stats.incorrect+(ie.type==="incorrect"&&!ie.interrupt?1:0),correctInterrupt:d.stats.correctInterrupt+(ie.type==="correct"&&ie.interrupt?1:0),incorrectInterrupt:d.stats.incorrectInterrupt+(ie.type==="incorrect"&&ie.interrupt?1:0)}}:d)),Se(null),Ee(!1),l&&ie.type==="incorrect")Ce&&re==="tossup"?(me(null),ce(["A","B"])):(me(s.team),ce([s.team==="A"?"B":"A"]));else if(ie.type==="incorrect")me(null),ce([]),setTimeout(()=>$e(),200);else if(ie.type==="correct"){me(null),ce([]);const n=ne[O];n?.bonus&&n.tossup?Je(""):setTimeout(()=>$e(),150)}return}if(s.name){const i=window.prompt("Rename player",s.name);i!=null&&qe(o=>o.map((l,n)=>n===t?{...l,name:i.trim()}:l))}else{const i=window.prompt("Enter player name (seat "+(t+1)+")","");i!=null&&qe(o=>o.map((l,n)=>n===t?{...l,name:i.trim()}:l))}}}function Es({player:t,type:s,interrupt:i}){if(!t)return;const o=qt==null;if(Oe(l=>{const n=[...l],d=s==="correct"?4:s==="incorrect"&&i?-4:0,g=n[O]||{},C=Array.isArray(g.attempts)?[...g.attempts]:[];return C.push({playerId:t.id,team:t.team,result:s,interrupt:i,points:d}),s==="correct"?n[O]={...g,attempts:C,result:"correct",playerId:t.id,interrupt:i,points:d}:n[O]={...g,attempts:C,result:"incorrect",playerId:t.id,interrupt:i,points:d},n}),qe(l=>l.map(n=>n.id===t.id?{...n,stats:{...n.stats,correct:n.stats.correct+0,incorrect:n.stats.incorrect+0,correctInterrupt:n.stats.correctInterrupt+(s==="correct"&&i?1:0),incorrectInterrupt:n.stats.incorrectInterrupt+(s==="incorrect"&&i?1:0)}}:n)),Se(null),Ee(!1),s==="incorrect")o?Ce&&re==="tossup"?(me(null),ce(["A","B"])):(me(t.team),ce([t.team==="A"?"B":"A"])):(me(null),ce([]),setTimeout(()=>$e(),200));else if(s==="correct"){me(null),ce([]);const l=ne[O];l?.bonus&&l.tossup?Je(""):setTimeout(()=>$e(),150)}}async function $s(){try{if(!ft)return;const s=ne[O]?.tossup;if(!s){h("No toss-up at this question.","error");return}if(!bt){h("Select a player seat first.","error");return}const i=Y.find(H=>H.id===bt);if(!i){h("Invalid player selection.","error");return}const o=String(_t||"").trim();if(!o){h("Enter an answer to check.","error");return}Ut(!0),yt("");const l=ze(s),n=Array.isArray(l)&&l.length>0,d={userAnswer:o,correctAnswer:s.answer,question:s.question};n&&(d.choices=l);const g=await(n?mn(d):pn(d)).catch(H=>({ok:!1,statusText:H?.message}));if(!g||!g.ok){h("AI check failed. You can record manually.","error");return}const C=await g.json().catch(()=>({})),v=!!C?.correct,W=typeof C?.reason=="string"?C.reason:"";yt(W||""),Es({player:i,type:v?"correct":"incorrect",interrupt:!0}),h(v?"AI: Correct interrupt.":"AI: Incorrect interrupt.",v?"success":"error")}catch(t){console.error(t),h("AI check encountered an error.","error")}finally{Ut(!1),ht(!1),xt(""),gt(null),setTimeout(()=>yt(""),4e3)}}function Ps(){Oe(t=>{const s=[...t],i=s[O]||{},o=Array.isArray(i.attempts)?i.attempts:[];return s[O]={...i,attempts:o,result:"no-answer",points:i.points||0},s}),Se(null),Ee(!1),ce([]),setTimeout(()=>$e(),150)}function $e(){const t=ne[O],s=le[O];t?.bonus&&t?.tossup&&s?.result==="correct"&&!ve[O]||(pt(i=>Math.min(i+1,ne.length)),me(null),ce(["A","B"]))}function Ds(){const t=Number(Ls);if(!Number.isFinite(t)||t<0)return;const s=Math.min(10,Math.max(0,t)),i=le[O],o=i?.playerId&&Y.find(l=>l.id===i.playerId)?.team||"A";Ke(l=>{const n=[...l];return n[O]={points:s,team:o},n}),Je(""),setTimeout(()=>$e(),100)}function Fs(t){const s=le[t];if(!s)return!1;if(s.result==="replaced"||s.result==="no-answer"||s.result==="correct")return!0;if(Ce&&re==="tossup"){const l=s.attempts||[],n=new Set(l.map(g=>g.playerId));return Y.filter(g=>g.status!=="replaced").filter(g=>!n.has(g.id)).length===0}const i=s.attempts||[];return new Set(i.map(l=>Y.find(n=>n.id===l.playerId)?.team).filter(Boolean)).size>=2&&s.result==="incorrect"}function zs(t){const s=t?10:0,i=le[O],o=i?.playerId&&Y.find(l=>l.id===i.playerId)?.team||"A";Ke(l=>{const n=[...l];return n[O]={points:s,team:o},n}),Se(null),Ee(!1),me(null),ce(["A","B"]),pt(l=>Math.min(l+1,ne.length))}function _s(){if(!ne[O])return;const s=new Set(ne.flatMap(l=>[l.tossup?.id,l.bonus?.id].filter(Boolean))),i=rt(),o=i.find(l=>!s.has(l.tossup?.id)&&!s.has(l.bonus?.id))||i[0];ye(l=>l.map((n,d)=>d===O?o:n)),Oe(l=>{const n=[...l];return n[O]=void 0,n}),Ke(l=>{const n=[...l];return n[O]=void 0,n}),me(null),ce(["A","B"]),Se(null),Ee(!1),ht(!1),xt(""),gt(null),h("Question replaced.","info")}const[Us,Qt]=x.useState(!1);async function qs(){Qt(!0);try{const t=await Mn(e.jsx(Gn,{sheetRows:Xs,players:Y,metadata:{generatedAt:new Date().toLocaleString()}})).toBlob(),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download="Coaches-Scoresheet-"+new Date().toISOString().slice(0,10)+".pdf",document.body.appendChild(i),i.click(),setTimeout(()=>{URL.revokeObjectURL(s),i.remove()},1e3)}catch(t){console.error("Failed to export coaches scoresheet (react-pdf):",t),window.alert?.("Failed to export coaches scoresheet: "+(t.message||String(t)))}finally{Qt(!1)}}const Xt=25,[Os,Gs]=x.useState(""),[Ae,vt]=x.useState(""),[Ws,Pe]=x.useState(!1),[Vs,Ge]=x.useState(!1),[Re,et]=x.useState(null),[tt,Yt]=x.useState(!1),[Hs,kt]=x.useState(!1),[Be,Le]=x.useState(new Set),[De,st]=x.useState(null),[nt,Kt]=x.useState(!1);x.useRef([]),x.useRef(null),X.useEffect(()=>{const t=()=>{try{const s=window.scrollY||document.documentElement.scrollTop||0;js(s>300)}catch{}};return window.addEventListener("scroll",t,{passive:!0}),t(),()=>window.removeEventListener("scroll",t)},[]);function rt(){const t=new Set;G.filter(o=>!je.current.has(o));for(const o of G){const l=je.current.get(o);if(l){const n=fn(l);for(const d of n)t.add(d)}}function s(o,l){if(o.length===0||l<=0)return[];const n=new Map;for(const q of o)n.has(q.category)||n.set(q.category,[]),n.get(q.category).push(q);let d=Array.from(n.keys());if(P.length){const q=new Set(P);d=d.filter(de=>q.has(de))}if(d=d.filter(q=>(n.get(q)?.length||0)>0),d.length===0)return[];const g=[...d].sort(()=>Math.random()-.5),C=Math.floor(l/g.length);let v=l%g.length;const W=[],H=new Set;for(let q=0;q<g.length;q++){const de=g[q],ke=[...n.get(de)];ke.sort(()=>Math.random()-.5);const ot=Math.min(C+(v>0?1:0),ke.length);v>0&&v--;for(let Qe=0;Qe<ot;Qe++){const Ne=ke[Qe];H.has(Ne.id)||(W.push(Ne),H.add(Ne.id))}}if(W.length<l){const q=[];for(const de of d)for(const ke of n.get(de))H.has(ke.id)||q.push(ke);q.sort(()=>Math.random()-.5);for(const de of q){if(W.length>=l)break;W.push(de),H.add(de.id)}}return W.slice(0,l)}let i=[];if(re==="tossup"){const o=F.filter(n=>(k.length?k.includes(n.tournament):!0)&&N(n)&&n.question_type?.toLowerCase()==="tossup"&&!t.has(n.id)),l=o.length<=he?[...o]:s(o,he);for(let n=l.length-1;n>0;n--){const d=Math.floor(Math.random()*(n+1));[l[n],l[d]]=[l[d],l[n]]}i=l.map(n=>({tossup:n,bonus:null}))}else if(re==="bonus"){const o=F.filter(n=>(k.length?k.includes(n.tournament):!0)&&N(n)&&n.question_type?.toLowerCase()==="bonus"&&(Et?!0:!Fe(n))&&!t.has(n.id)),l=o.length<=he?[...o]:s(o,he);for(let n=l.length-1;n>0;n--){const d=Math.floor(Math.random()*(n+1));[l[n],l[d]]=[l[d],l[n]]}i=l.map(n=>({tossup:null,bonus:n}))}else if(re==="visual-bonus"){const o=F.filter(n=>(k.length?k.includes(n.tournament):!0)&&N(n)&&n.question_type?.toLowerCase()==="bonus"&&Fe(n)&&!t.has(n.id)),l=o.length<=he?[...o]:s(o,he);for(let n=l.length-1;n>0;n--){const d=Math.floor(Math.random()*(n+1));[l[n],l[d]]=[l[d],l[n]]}i=l.map(n=>({tossup:null,bonus:n}))}else{const l=F.filter(d=>(k.length?k.includes(d.tournament):!0)&&N(d)&&d.question_type?.toLowerCase()==="tossup"&&!t.has(d.id)).filter(d=>{const g=ts(d,F);return!(!g||t.has(g.id)||!mt&&Fe(g))}),n=l.length<=he?[...l]:s(l,he);for(let d=n.length-1;d>0;d--){const g=Math.floor(Math.random()*(d+1));[n[d],n[g]]=[n[g],n[d]]}i=n.map(d=>{const g=ts(d,F),C=g&&(mt||!Fe(g))&&!t.has(g.id)?g:null;return{tossup:d,bonus:C}})}return i}X.useEffect(()=>{M&&k.length!==0&&p.ensureLoaded(k)},[M,p,k]);const Qs=x.useMemo(()=>{const t=Ae.trim().toLowerCase();return t?F.filter(s=>[s.question,s.answer,s.category,s.tournament,s.round].some(o=>o!=null&&String(o).toLowerCase().includes(t))).map(s=>({tossup:s.question_type?.toLowerCase()==="tossup"?s:null,bonus:s.question_type?.toLowerCase()==="bonus"?s:null})):[]},[Ae,F]),ne=Ae.trim()&&ue.length>0?Qs:ue,Xs=x.useMemo(()=>{const t=[];for(let o=0;o<Math.min(ne.length,Xt);o++){const l=ne[o],n=l.tossup,d=le[o],g=ve[o],C=n?ze(n).length>0:!1,v=d?.attempts||[],W={A:v.filter(H=>Y.find(q=>q.id===H.playerId)?.team==="A"),B:v.filter(H=>Y.find(q=>q.id===H.playerId)?.team==="B")};t.push({index:o+1,subject:an(n?.category||l.bonus?.category),type:C?"MC":"SA",attempts:v,byTeam:W,bonusA:g&&g.team==="A"?g.points:0,bonusB:g&&g.team==="B"?g.points:0,penaltyA:v.filter(H=>Y.find(q=>q.id===H.playerId)?.team==="A"&&(H.points||0)<0).reduce((H,q)=>H+Math.abs(q.points||0),0),penaltyB:v.filter(H=>Y.find(q=>q.id===H.playerId)?.team==="B"&&(H.points||0)<0).reduce((H,q)=>H+Math.abs(q.points||0),0),bonusAwardedTeam:g?.team||null})}for(;t.length<Xt;)t.push({pad:!0,index:t.length+1});let s=0,i=0;return t.forEach(o=>{if(o.pad){o.cumA=s,o.cumB=i;return}const l=(o.attempts||[]).filter(d=>Y.find(g=>g.id===d.playerId)?.team==="A").reduce((d,g)=>d+(g.points||0),0),n=(o.attempts||[]).filter(d=>Y.find(g=>g.id===d.playerId)?.team==="B").reduce((d,g)=>d+(g.points||0),0);s+=l+(o.bonusA||0),i+=n+(o.bonusB||0),o.cumA=s,o.cumB=i}),t},[ne,le,ve,Y]);async function Nt(t={}){const{force:s=!1}=t;if(Ae.trim())return;if(!xe&&!be&&!we){h("Select at least one question type (Toss-ups, Bonuses, or Visual bonuses).","error");return}if(ms(!0),!s&&ue.length>0&&Ws){Ge(!0);return}try{M&&k.length>0&&await p.ensureLoaded(k)}catch{}console.group("RoundGenerator.generate"),console.log("Filters:",{selectedTournaments:k,selectedCategories:P,roundRanges:te,count:he,questionType:re});try{const o=Math.max(1,Number(he)||1);async function l(){const v=await hn({questionType:re,categories:P,count:o}).catch(()=>({roundId:null}));if(!(v?.roundId||null))return{pairs:[],tournaments:[]};const H=Array.isArray(v.pairs)?v.pairs:[];if(H.length===0)return{pairs:[],tournaments:[]};const q=new Set;for(const _ of H){const at=_?.tossupMeta?.tournament;at&&q.add(at);const it=_?.bonusMeta?.tournament;it&&q.add(it)}const de=Array.from(q);try{M&&de.length&&await p.ensureLoaded(de)}catch{}const ke=M?p.getLoadedQuestions(de):F,ot=new Map(ke.map(_=>[_.id,_])),Qe=new Set(P),Ne=_=>!(!_||P.length&&!Qe.has(_.category));let Te=H.map(_=>({tossup:_.tossupId&&ot.get(_.tossupId)||null,bonus:_.bonusId&&ot.get(_.bonusId)||null}));return re==="tossup"?Te=Te.map(_=>_.tossup?{tossup:_.tossup,bonus:null}:null).filter(Boolean).filter(_=>Ne(_.tossup)):re==="bonus"?Te=Te.map(_=>_.bonus?{tossup:null,bonus:_.bonus}:null).filter(Boolean).filter(_=>Ne(_.bonus)).filter(_=>Et?!0:!Fe(_.bonus)):Te=Te.map(_=>{const at=Ne(_.tossup),it=_.bonus?Ne(_.bonus):!0,sn=_.bonus?it&&(mt||!Fe(_.bonus)):!0;return at?{tossup:_.tossup,bonus:sn?_.bonus:null}:null}).filter(Boolean),{pairs:Te,tournaments:de}}const n=[],d=new Set,g=v=>{let W="";re==="tossup"?W=v.tossup?.id?`tu:${v.tossup.id}`:"":re==="bonus"?W=v.bonus?.id?`bo:${v.bonus.id}`:"":W=v.tossup?.id?`tu:${v.tossup.id}`:v.bonus?.id?`bo:${v.bonus.id}`:"",!(!W||d.has(W))&&(d.add(W),n.push(v))};if((await l()).pairs.forEach(g),n.length>=o){const v=n.slice(0,o);typeof j=="function"?j(v):ye(v),Pe(!0),console.groupEnd();return}if(n.length<o&&(await l()).pairs.forEach(g),n.length>=o){const v=n.slice(0,o);typeof j=="function"?j(v):ye(v),Pe(!0),console.groupEnd();return}n.length>0&&h("Not enough preset questions matched filters; using normal generator.","info",5e3)}catch(o){console.warn("Preset round claim/materialization failed; falling back.",o)}const i=rt();typeof j=="function"?j(i):ye(i),i.length===0&&h("No questions match the criteria provided.","error",5e3),Pe(!0),console.groupEnd()}async function Jt(){if(!f?.user){window.alert?.("Please log in to save rounds.");return}Ft(!0);try{let t=ue;if((!t||t.length===0)&&(t=rt(),ye(t)),!t||t.length===0)return;const s=new Date,o={title:`Round at ${s.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})} on ${s.toLocaleDateString()}`,questionType:re,count:t.length,tournaments:k,categories:P,roundRanges:te,pairs:t.map(n=>({tossupId:n.tossup?.id||null,bonusId:n.bonus?.id||null,tossupMeta:n.tossup?{tournament:n.tossup.tournament,round:n.tossup.round,question_number:n.tossup.question_number,category:n.tossup.category}:null,bonusMeta:n.bonus?{tournament:n.bonus.tournament,round:n.bonus.round,question_number:n.bonus.question_number,category:n.bonus.category}:null}))},l=await xn(f.user.uid,o);se(n=>[{id:l,title:o.title,createdAt:{seconds:Math.floor(Date.now()/1e3)},count:o.count},...n]),h("Round saved to your account.","success"),Pe(!1)}catch(t){console.error(t),window.alert?.(`Failed to save round: ${t.message||String(t)}`),h(`Failed to save round: ${t.message||String(t)}`,"error",6e3)}finally{Ft(!1)}}async function Ys(){if(M&&k.length===0&&ue.length===0&&(B?.length??0)===0){window.alert?.("Select at least one tournament to generate a PDF.");return}Dt(!0);try{let t=[];if(Ae.trim()?t=ne:(t=ue,(!t||t.length===0)&&(t=rt(),ye(t),await new Promise(l=>requestAnimationFrame(()=>l())).then(()=>new Promise(l=>setTimeout(l,0))))),!t||t.length===0)return;const s=$t.current;if(!s)return;const i=await bn(),o={margin:[12,12,12,12],filename:`SciBowl-Round-${new Date().toISOString().slice(0,10)}.pdf`,image:{type:"jpeg",quality:.95},html2canvas:{scale:2,useCORS:!0,letterRendering:!0,scrollY:0},pagebreak:{mode:["css","legacy"]},jsPDF:{unit:"mm",format:"letter",orientation:"portrait"}};await i().from(s).set(o).save()}finally{Dt(!1)}}async function Ks(t){try{if(!f?.user||!t?.id)return;const s=await ls(f.user.uid,t.id).catch(()=>null);if(!s){h("Failed to open round details.","error");return}const i=new Set;for(const C of s.pairs||[])C?.tossupMeta?.tournament&&i.add(C.tossupMeta.tournament),C?.bonusMeta?.tournament&&i.add(C.bonusMeta.tournament);const o=Array.from(i);try{M&&o.length&&await p.ensureLoaded(o)}catch{}const l=M?p.getLoadedQuestions(o.length?o:k):F,n=new Map;for(const C of l)n.set(C.id,C);let d=(s.pairs||[]).map(C=>({tuId:C.tossupId||null,boId:C.bonusId||null,tossup:C.tossupId&&n.get(C.tossupId)||null,bonus:C.bonusId&&n.get(C.bonusId)||null}));if(d.some(C=>C.tuId&&!C.tossup||C.boId&&!C.bonus)){const C=M?p.getLoadedQuestions(Array.from(new Set([...o||[],...k]))):F,v=new Map;for(const W of C)v.set(W.id,W);d=d.map(W=>({...W,tossup:W.tossup||W.tuId&&v.get(W.tuId)||null,bonus:W.bonus||W.boId&&v.get(W.boId)||null}))}const g=d.map(({tossup:C,bonus:v})=>({tossup:C,bonus:v})).filter(C=>C.tossup||C.bonus);if(!g.length){h("Round questions are not available in the current dataset.","error");return}ye(g),Pe(!1),vt("");try{Array.isArray(s.tournaments)&&s.tournaments.length&&E(s.tournaments),Array.isArray(s.categories)&&u(s.categories),s.roundRanges&&c(s.roundRanges),s.questionType&&Mt(s.questionType)}catch{}Ze(),window.scrollTo({top:0,behavior:"smooth"}),h("Round opened.","success")}catch(s){h(s?.message||"Failed to open round.","error")}}X.useEffect(()=>{ue&&ue.length>0||(async()=>{try{const t=await ln("sb_current_round_meta");if(!Array.isArray(t)||t.length===0)return;const s=new Set;for(const d of t)d?.tu?.tournament&&s.add(d.tu.tournament),d?.bo?.tournament&&s.add(d.bo.tournament);const i=Array.from(s);try{M&&i.length&&await p.ensureLoaded(i)}catch{}const o=M?p.getLoadedQuestions(i.length?i:k):F,l=new Map(o.map(d=>[d.id,d])),n=t.map(d=>({tossup:d?.tu?.id&&l.get(d.tu.id)||null,bonus:d?.bo?.id&&l.get(d.bo.id)||null})).filter(d=>d.tossup||d.bonus);n.length>0&&ye(n)}catch{}})()},[M,p,F]);const[Ie,Js]=x.useState(!1),[St,We]=x.useState(!1),[Zs,en]=x.useState(!0),[Ve,tn]=x.useState(()=>{try{const t=localStorage.getItem("sb_leftPaneWidth_rounds"),s=Number(t);return Number.isFinite(s)&&s>=220&&s<=720?s:320}catch{return 320}}),He=X.useRef(!1),Ct=X.useRef(0),At=X.useRef(320);return X.useEffect(()=>{function t(i){if(!He.current)return;const l=(i.touches?i.touches[0].clientX:i.clientX)-Ct.current;let n=Math.round(At.current+l);n=Math.max(220,Math.min(720,n)),tn(n)}function s(){if(He.current){He.current=!1;try{localStorage.setItem("sb_leftPaneWidth",String(Ve))}catch{}document.body.style.cursor="",document.body.style.userSelect=""}}return window.addEventListener("mousemove",t),window.addEventListener("mouseup",s),window.addEventListener("touchmove",t,{passive:!1}),window.addEventListener("touchend",s),()=>{window.removeEventListener("mousemove",t),window.removeEventListener("mouseup",s),window.removeEventListener("touchmove",t),window.removeEventListener("touchend",s)}},[Ve]),e.jsxs("div",{className:`grid gap-6 max-w-[100vw] w-full overflow-x-hidden ${ae?"transition-all":""} md:[grid-template-columns:var(--left-pane-w)_minmax(0,1fr)]`,style:{...ae?{paddingRight:420}:{},"--left-pane-w":Ie&&!St?"25px":`${Ve}px`},children:[e.jsxs("div",{className:`md:self-start ${ae?"hidden":""} relative`,children:[Ie&&e.jsx("div",{className:"absolute inset-0 z-5",onMouseEnter:()=>We(!0),onMouseLeave:()=>We(!1)}),e.jsx(Jn,{leftPaneCollapsed:Ie,leftPanePinned:Zs,leftPaneHovered:St,setLeftPaneCollapsed:Js,setLeftPanePinned:en,setLeftPaneHovered:We}),e.jsxs("div",{className:`glass p-6 space-y-6 min-w-0 transition-all duration-300 ${Ie&&!St?"opacity-0 pointer-events-none scale-95":"opacity-100 scale-100"}`,onMouseEnter:()=>We(!0),onMouseLeave:()=>We(!1),children:[e.jsx(Xn,{searchInput:Os,setSearchInput:Gs,committedSearch:Ae,setCommittedSearch:vt,hasGenerated:ue.length>0}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2",children:"Question Types"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("label",{className:`chip cursor-pointer ${xe?"ring-1 ring-tint bg-tint/10":""}`,children:[e.jsx("input",{type:"checkbox",className:"mr-1",checked:xe,onChange:t=>xs(t.target.checked)})," Toss-ups"]}),e.jsxs("label",{className:`chip cursor-pointer ${be?"ring-1 ring-tint bg-tint/10":""}`,children:[e.jsx("input",{type:"checkbox",className:"mr-1",checked:be,onChange:t=>bs(t.target.checked)})," Bonuses"]}),e.jsxs("label",{className:`chip cursor-pointer ${we?"ring-1 ring-tint bg-tint/10":""}`,title:"Bonuses that have associated visual images",children:[e.jsx("input",{type:"checkbox",className:"mr-1",checked:we,onChange:t=>gs(t.target.checked)})," Visual bonuses"]})]})]}),k.length===0&&e.jsxs("div",{role:"alert","aria-live":"polite",className:"flex items-start gap-2 rounded-lg border-l-4 border-amber-500 bg-amber-50 text-amber-900 dark:border-amber-400 dark:bg-amber-900/20 dark:text-amber-100 px-3 py-2",children:[e.jsx(Rn,{className:"mt-0.5 h-4 w-4 shrink-0"}),e.jsx("div",{className:"text-sm",children:"No tournaments selected."})]}),e.jsx(cn,{tournaments:A,tournamentGroups:I,selectedTournaments:k,setSelectedTournaments:E,tournamentGroupsOpen:S,setTournamentGroupsOpen:R,handleTournamentToggle:U,tournamentVisibleEntriesMainRef:D,isDark:vs,showTournamentModal:m,setShowTournamentModal:b}),f?.user&&e.jsx(Pn,{auth:f,roundsIndex:J,setRoundsIndex:se,roundFolders:_e,setRoundFolders:fe,loadingUserRounds:oe,refresh:dt,selectedExcludeRoundIds:G,setSelectedExcludeRoundIds:Me,foldersOpen:ge,setFoldersOpen:V,handleExcludeRoundToggle:Xe,pushToast:h,setManagerSelection:Le,setShowRoundsManager:kt,setFolderDeleteTarget:st,setDeleteTarget:et,onViewRound:Ks}),e.jsx(dn,{categories:K,selectedCategories:P,setSelectedCategories:u}),e.jsx(un,{selectedTournaments:k,tournaments:A,roundRanges:te,setRoundRanges:c,roundsByTournament:a,globalNumericRoundMax:w}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("label",{className:"text-black dark:text-white",children:"Count"}),e.jsx("input",{type:"number",min:1,max:50,className:"w-24 rounded-lg border border-black/10 bg-white dark:bg-darkcard text-black dark:text-white px-2 py-1",value:he,onChange:t=>ps(Number(t.target.value))})]}),e.jsxs("div",{className:"pt-2 flex flex-wrap justify-center gap-4 w-full",children:[e.jsxs("button",{className:"btn btn-fancy flex items-center gap-2 hover-lift",onClick:Nt,style:{minWidth:140},children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 4V2m0 20v-2m7-7h-2M4 12H2m16.24-6.24l-1.42 1.42M6.34 17.66l-1.42 1.42M17.66 17.66l-1.42-1.42M6.34 6.34l-1.42-1.42M12 8a4 4 0 100 8 4 4 0 000-8z"})}),"Generate"]}),f?.user?e.jsxs("button",{className:"btn btn-fancy flex items-center gap-2 hover-lift disabled:opacity-50 disabled:cursor-not-allowed",onClick:Jt,disabled:Ye||ue.length===0,style:{minWidth:140},children:[e.jsx(os,{className:"h-5 w-5"}),Ye?"Saving…":"Save Round"]}):e.jsxs("button",{className:"btn btn-fancy flex items-center gap-2 hover-lift disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>window.alert?.("Log in to save rounds."),disabled:ue.length===0,style:{minWidth:140},children:[e.jsx(os,{className:"h-5 w-5"}),"Save Round"]}),e.jsx("button",{className:"btn btn-fancy hover-lift disabled:opacity-50 disabled:cursor-not-allowed",disabled:Pt,onClick:Ys,title:"Generate and export as PDF",children:Pt?e.jsxs("span",{className:"inline-flex items-center",children:[e.jsx("span",{className:"h-4 w-4 mr-2 inline-block animate-spin rounded-full border-2 border-current border-t-transparent","aria-hidden":"true"}),"Generating..."]}):e.jsxs("span",{className:"inline-flex items-center",children:[e.jsx(Bn,{className:"h-4 w-4 mr-1"})," Generate PDF"]})}),e.jsxs("button",{className:`btn flex items-center gap-2 hover-lift disabled:opacity-50 disabled:cursor-not-allowed ${ae?"btn-orange":"btn-fancy"}`,onClick:()=>{ae||Ze(),zt(t=>!t)},style:{minWidth:140},title:ae?"Close Scorekeeper":"Open Scorekeeper",disabled:ue.length===0,children:[e.jsx(Ln,{className:"h-5 w-5"})," ",ae?"Close":"Scorekeeper"]})]}),Array.isArray(ee)&&ee.length>0&&e.jsxs("div",{className:"mt-3 flex items-center justify-center gap-3 text-sm",children:[e.jsx("button",{className:"chip px-2 py-1 disabled:opacity-50",onClick:()=>Tt((Ue??ee.length-1)-1),disabled:(Ue??ee.length-1)<=0,"aria-label":"Previous generated round",children:"◀ Prev"}),e.jsxs("div",{className:"opacity-80",children:["Round ",(Ue??ee.length-1)+1," of ",ee.length," (this session)"]}),e.jsx("button",{className:"chip px-2 py-1 disabled:opacity-50",onClick:()=>Tt((Ue??ee.length-1)+1),disabled:(Ue??ee.length-1)>=ee.length-1,"aria-label":"Next generated round",children:"Next ▶"})]})]}),!Ie&&e.jsx("div",{role:"separator","aria-orientation":"vertical",title:"Drag to resize",onMouseDown:t=>{Ie||(He.current=!0,Ct.current=t.clientX,At.current=Ve,document.body.style.cursor="col-resize",document.body.style.userSelect="none")},onTouchStart:t=>{if(Ie)return;const s=t.touches?.[0];s&&(He.current=!0,Ct.current=s.clientX,At.current=Ve,document.body.style.cursor="col-resize",document.body.style.userSelect="none")},className:"hidden md:block absolute top-0 -right-5 h-full w-2 cursor-col-resize z-30 transition-colors",children:e.jsx("div",{className:"absolute inset-y-0 left-[-1px] right-[-1px] w-[1px] bg-gray-400 dark:bg-gray-500"})})]}),"  ",e.jsxs("div",{className:`${ae?"md:col-span-2":""} md:self-start space-y-4 min-w-0 overflow-x-hidden`,children:[null,ne.length===0&&e.jsx("div",{className:"glass p-6",role:"status","aria-live":"polite",children:Ae.trim()?"No matches found.":us?"No questions match the criteria provided.":"No questions generated yet."}),ne.map((t,s)=>{const o=(!ae||s===O)&&(!ae||!t.tossup||le[s]?.result==="correct"||s<O);return e.jsx(Vn,{pair:t,index:s,scorekeeping:ae,currentIndex:O,tossupResults:le,showBonusContent:o,questionRef:l=>{Ht.current[s]=l}},`${t.tossup?.id??"tu"}-${t.bonus?.id??"bo"}-${s}`)})]}),ae&&e.jsx(Yn,{headerOffset:jt,close:()=>zt(!1),currentIndex:O,displayPairs:ne,awaitingPlayer:ie,interruptArmed:Ss,setAwaitingPlayer:Se,setInterruptArmed:Ee,typedAnswerActive:ft,setTypedAnswerActive:ht,typedAnswerText:_t,setTypedAnswerText:xt,typedAnswerPlayerId:bt,typedAnswerLoading:Cs,typedAnswerReason:As,checkTypedAnswer:$s,isTossupFinal:Fs,recordNoAnswer:Ps,throwOutAndReplace:_s,tossupResults:le,bonusResults:ve,saveFixedBonus:zs,players:Y,handleSeatClick:Ms,allowedTeams:wt,totalPoints:Is,teamPoints:Ts,saveBonusPoints:Ds,subMode:Rs,setSubMode:()=>{Wt(!0)},resetScorekeeping:Ze,exportCoachesScoresheetPdf:qs,coachesSheetLoading:Us,tryoutsMode:Ce,setTryoutsMode:Ot,questionType:re}),e.jsx(Qn,{displayPairs:ne,QUESTIONS_PER_PAGE:ys,pdfRef:$t}),ws&&e.jsxs("button",{type:"button",onClick:()=>window.scrollTo({top:0,behavior:"smooth"}),"aria-label":"Back to top",className:"fixed bottom-6 right-6 z-40 inline-flex items-center gap-2 rounded-full bg-tint text-white shadow-lg px-4 py-2 hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-tint",children:[e.jsx(In,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Top"})]}),Vs&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:()=>Ge(!1)}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl max-w-sm w-full p-6 space-y-4 border border-black/10 dark:border-white/10",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Unsaved round"}),e.jsx("p",{className:"text-sm leading-relaxed text-black/70 dark:text-white/70",children:"You already have a generated round that hasn't been saved. What would you like to do?"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{disabled:Ye,onClick:async()=>{await Jt(),Ge(!1),Nt({force:!0})},className:"btn btn-primary w-full justify-center disabled:opacity-60",children:Ye?"Saving…":"Save & Generate New"}),e.jsx("button",{onClick:()=>{Ge(!1),console.log("Discarding unsaved round and generating new"),Nt({force:!0})},className:"btn btn-orange w-full justify-center",children:"Generate Without Saving"}),e.jsx("button",{onClick:()=>Ge(!1),className:"btn btn-ghost w-full justify-center",children:"Cancel"})]})]})]}),Re&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:()=>!tt&&et(null)}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl max-w-sm w-full p-6 space-y-5 border border-black/10 dark:border-white/10",children:[e.jsx("h2",{className:"text-lg font-semibold flex items-center gap-2 text-red-600 dark:text-red-300",children:"Delete Round"}),e.jsxs("div",{className:"text-sm leading-relaxed text-black/70 dark:text-white/70",children:["Are you sure you want to delete",e.jsxs("span",{className:"font-medium text-black dark:text-white",children:[" ",Re.title||"this round"]}),"? This action cannot be undone."]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{disabled:tt,onClick:async()=>{if(!(!f?.user||!Re)){Yt(!0);try{await ct(f.user.uid,Re.id),se(t=>t.filter(s=>s.id!==Re.id)),Me(t=>t.filter(s=>s!==Re.id)),je.current.delete(Re.id),et(null),h("Round deleted.","error")}catch(t){console.error(t),h(t?.message||"Failed to delete round.","error",6e3)}finally{Yt(!1)}}},className:"btn btn-orange w-full justify-center disabled:opacity-60",children:tt?"Deleting…":"Delete Permanently"}),e.jsx("button",{disabled:tt,onClick:()=>et(null),className:"btn btn-ghost w-full justify-center",children:"Cancel"})]})]})]}),De&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:()=>!nt&&st(null)}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl max-w-sm w-full p-6 space-y-5 border border-black/10 dark:border-white/10",children:[e.jsx("h2",{className:"text-lg font-semibold flex items-center gap-2 text-red-600 dark:text-red-300",children:"Delete Folder"}),e.jsxs("div",{className:"text-sm leading-relaxed text-black/70 dark:text-white/70",children:["Delete folder ",e.jsx("span",{className:"font-semibold text-black dark:text-white",children:De.name})," and its ",De.count," round(s)? This cannot be undone."]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{disabled:nt,onClick:async()=>{if(f?.user){Kt(!0);try{await ds(De.name,De.roundIds),fe(t=>t.filter(s=>s!==De.name)),Le(new Set),st(null)}finally{Kt(!1)}}},className:"btn btn-orange w-full justify-center disabled:opacity-60",children:nt?"Deleting…":"Delete Permanently"}),e.jsx("button",{disabled:nt,onClick:()=>st(null),className:"btn btn-ghost w-full justify-center",children:"Cancel"})]})]})]}),e.jsx(Kn,{open:Bs,onClose:()=>{Wt(!1),Gt(!1)},players:Y,onSubmit:({team:t,playerId:s,newName:i})=>{qe(o=>{if(o.filter(v=>v.team===t).length>=5)return o;const n=o.map(v=>v.id===s?{...v,status:"replaced"}:v),d=n.filter(v=>v.team===t).map(v=>v.seat).filter(Boolean),g=Math.max(0,...d,4)+(d.includes(5)?0:1),C={id:Ns.current++,team:t,seat:g>5?g:5,name:i,status:"active",stats:{correct:0,incorrect:0,correctInterrupt:0,incorrectInterrupt:0}};return[...n,C]}),h(`Substitution: ${i} entered for Team ${t}.`,"success")}}),Hs&&e.jsxs("div",{className:"fixed inset-0 z-[70] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>kt(!1)}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl max-w-3xl w-full p-6 space-y-4 border border-black/10 dark:border-white/10 flex flex-col max-h-[85vh]",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Manage Saved Rounds"}),e.jsx("button",{className:"btn btn-ghost btn-sm",onClick:()=>kt(!1),children:"Close"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:"chip px-3 py-1",onClick:()=>Le(new Set(J.map(t=>t.id))),children:"Select All"}),e.jsx("button",{className:"chip px-3 py-1",onClick:()=>Le(new Set),children:"Clear"}),e.jsx("button",{className:"chip px-3 py-1",onClick:()=>Le(t=>new Set(J.filter(s=>!t.has(s.id)).map(s=>s.id))),children:"Invert"}),e.jsx("button",{className:"chip px-3 py-1",onClick:()=>{Me(Array.from(Be)),h("Excluded rounds updated.","success")},children:"Apply Exclusions"}),e.jsx("button",{className:"chip px-3 py-1 text-red-600 border-red-200 hover:bg-red-50 dark:text-red-300 dark:border-red-700 dark:hover:bg-red-900/30",onClick:async()=>{if(!f?.user)return;if(Be.size===0){h("No rounds selected.","error");return}if(!window.confirm(`Delete ${Be.size} selected round(s)? This cannot be undone.`))return;const t=Array.from(Be);let s=0;for(const i of t)try{await ct(f.user.uid,i),s++}catch{}se(i=>i.filter(o=>!Be.has(o.id))),Me(i=>i.filter(o=>!Be.has(o))),Le(new Set),h(`Deleted ${s} round(s).`,"error")},children:"Delete Selected"})]}),e.jsx("div",{className:"flex-1 overflow-auto rounded border border-black/10 dark:border-white/10",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-black/5 dark:bg-white/10 backdrop-blur",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-3 py-2 w-10",children:"Sel"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Title"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Folder"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Count"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Created"})]})}),e.jsx("tbody",{children:J.map(t=>{const s=t.createdAt?.seconds?new Date(t.createdAt.seconds*1e3):null;return e.jsxs("tr",{className:"odd:bg-black/0 even:bg-black/5 dark:even:bg-white/5 hover:bg-tint/10",children:[e.jsx("td",{className:"px-3 py-1.5",children:e.jsx("input",{type:"checkbox",checked:Be.has(t.id),onChange:()=>Le(i=>{const o=new Set(i);return o.has(t.id)?o.delete(t.id):o.add(t.id),o})})}),e.jsx("td",{className:"px-3 py-1.5 truncate max-w-[280px]",title:t.title,children:t.title||"Untitled"}),e.jsx("td",{className:"px-3 py-1.5",children:t.folder||""}),e.jsx("td",{className:"px-3 py-1.5",children:t.count??""}),e.jsx("td",{className:"px-3 py-1.5 whitespace-nowrap",children:s?s.toLocaleDateString():""})]},t.id)})})]})})]})]}),e.jsx("div",{className:"fixed top-4 right-4 z-[60] flex flex-col gap-3 w-[min(92vw,360px)] pointer-events-none",children:T.map(t=>e.jsxs("div",{className:"group pointer-events-auto relative overflow-hidden rounded-md px-4 py-3 pr-10 text-sm shadow-lg flex items-start gap-3 animate-toast-enter "+(t.type==="success"?"bg-emerald-600 text-white":t.type==="error"?"bg-red-600 text-white":"bg-neutral-800 text-white"),role:"status","aria-live":"polite",children:[e.jsx("div",{className:"flex-1 break-words leading-relaxed",children:t.message}),e.jsx("button",{className:"absolute top-1.5 right-1.5 rounded p-1 text-white/70 hover:text-white hover:bg-white/10 transition-colors","aria-label":"Dismiss notification",onClick:()=>z(s=>s.filter(i=>i.id!==t.id)),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"h-4 w-4",children:e.jsx("path",{fillRule:"evenodd",d:"M4.22 4.22a.75.75 0 011.06 0L10 8.94l4.72-4.72a.75.75 0 111.06 1.06L11.06 10l4.72 4.72a.75.75 0 11-1.06 1.06L10 11.06l-4.72 4.72a.75.75 0 01-1.06-1.06L8.94 10 4.22 5.28a.75.75 0 010-1.06z",clipRule:"evenodd"})})}),e.jsx("span",{className:"absolute bottom-0 left-0 h-0.5 bg-white/70 group-hover:bg-white",style:{width:"100%",transformOrigin:"left",animation:`toast-bar-${t.id} ${t.ttl}ms linear forwards`}}),e.jsx("style",{children:`@keyframes toast-disappear { to { opacity:0; transform: translateY(-4px); } }
                @keyframes toast-enter { from { opacity:0; transform: translateY(-4px) scale(.98); } to { opacity:1; transform: translateY(0) scale(1); } }
                .animate-toast-enter { animation: toast-enter 160ms cubic-bezier(.4,0,.2,1); }
              `}),e.jsx("style",{children:`@keyframes toast-bar-${t.id} { from { transform: scaleX(1); } to { transform: scaleX(0); } }`})]},t.id))})]})}export{_o as default};
