import{j as e,r as w,b as Z}from"./vendor-react-DpsG3A-O.js";import{a as Jt,r as Zt,s as kt,b as Nt,c as Ht,d as Wt,e as ot,f as Vs,h as es,u as Hs,i as Ws,j as Qs,k as Ys,l as Ks}from"./index-DLnuwQ1T.js";import{L as pe,g as ts,i as Ee}from"./visualBonuses-P43A_idX.js";import{p as Pe,u as Xs,b as Js,T as Zs,c as en,a as tn,f as Qt,l as sn}from"./client-M5VKMgG_.js";import{P as nn,M as rn,R as on,F as an,b as Yt,c as ln,d as jt,e as vt,a as Kt,f as cn,X as dn,C as un,g as mn,T as pn,h as Xt,i as hn,j as fn,A as xn}from"./vendor-lucide-react-Lx6fY6Gz.js";import{S as bn,p as gn}from"./vendor-react-pdf-renderer-DfOTdHag.js";import{D as wn,P as yn,T as ee,V as K}from"./vendor-react-pdf-primitives-B6ApagcG.js";import"./vendor-abs-svg-path-DCUpb6Nw.js";import"./vendor-react-dom-D1u-fJLi.js";import"./vendor-scheduler-CoSDG3-6.js";import"./vendor-firebase-BxSqqaym.js";import"./vendor-firebase-app-CZHFuJSY.js";import"./vendor-firebase-component-BsAoxdSC.js";import"./vendor-firebase-util-DLzrvjrQ.js";import"./vendor-firebase-logger-CNz1B4Yj.js";import"./vendor-idb-BXWtuYvb.js";import"./vendor-firebase-app-check-D4a6coeq.js";import"./vendor-firebase-firestore-C-aRomGP.js";import"./vendor-firebase-webchannel-wrapper-QS5lB7L3.js";import"./vendor-firebase-storage-BvGgD_BW.js";import"./vendor-mui-material-DksXbHt-.js";import"./vendor-mui-utils-B23qfrSe.js";import"./vendor-clsx-B-dksMZM.js";import"./vendor-mui-system-BndTH9qf.js";import"./vendor-mui-styled-engine-CPmDJbkS.js";import"./vendor-emotion-styled-5vLscvJp.js";import"./vendor-babel-runtime-WXw8LxeR.js";import"./vendor-emotion-serialize-B6qc6euy.js";import"./vendor-emotion-hash-WldOFDRm.js";import"./vendor-emotion-unitless-x5IvBceT.js";import"./vendor-emotion-memoize-3S_6p140.js";import"./vendor-emotion-use-insertion-effect-with-fallbacks-B--OEmuQ.js";import"./vendor-emotion-utils-BijCJQMc.js";import"./vendor-emotion-is-prop-valid-DOnQZHJ6.js";import"./vendor-emotion-react-DrbGOuDy.js";import"./vendor-hoist-non-react-statics-mDtaWys7.js";import"./vendor-react-is-CnyDuYXe.js";import"./vendor-emotion-cache-DvsOMRO7.js";import"./vendor-emotion-sheet-6IwnyhEX.js";import"./vendor-stylis-DDa9OTMq.js";import"./vendor-react-transition-group-Q1VPUTjR.js";import"./vendor-react-router-dom-D-i9eXTo.js";import"./vendor-react-router-D4SgS1v_.js";import"./vendor-remix-run-router-9r-WWGj9.js";import"./vendor-react-helmet-async-bvMvt1Ax.js";import"./vendor-react-fast-compare-BCtOC5yC.js";import"./vendor-invariant-DW3JcdOx.js";import"./vendor-shallowequal-Df9Q-7bk.js";import"./vendor-katex-DP_4UPSs.js";import"./vendor-queue-IZnSDwnG.js";import"./vendor-inherits-BICa84dG.js";import"./vendor-events-DQ172AOg.js";import"./vendor-react-pdf-font-ByacAZ2x.js";import"./vendor-cross-fetch-DvOI2u39.js";import"./vendor-fontkit-5mDwoQ7O.js";import"./vendor-restructure-DwIbRzqP.js";import"./vendor-swc-helpers-DIxjOVuh.js";import"./vendor-fast-deep-equal-DtIvihjZ.js";import"./vendor-unicode-properties-BbL32wKl.js";import"./vendor-base64-js-BJmSPyJr.js";import"./vendor-unicode-trie-rSh8NucD.js";import"./vendor-tiny-inflate-BmeP50H3.js";import"./vendor-dfa-DFRa2UL2.js";import"./vendor-clone-DniFCc4t.js";import"./vendor-brotli-CUuIRSoC.js";import"./vendor-tslib-kHcLnhpD.js";import"./vendor-react-pdf-render-DYs5yDRr.js";import"./vendor-react-pdf-fns-DIcDsgsD.js";import"./vendor-parse-svg-path-Bi0KIs1g.js";import"./vendor-normalize-svg-path-CFWHe3yZ.js";import"./vendor-svg-arc-to-cubic-bezier-DEq50KMd.js";import"./vendor-color-string-BKSasjlw.js";import"./vendor-color-name-Dju3oUBS.js";import"./vendor-simple-swizzle-3gX0Onlb.js";import"./vendor-is-arrayish-DyGeW-O8.js";import"./vendor-react-pdf-pdfkit-CgWEQEi-.js";import"./vendor-pako-CNe1bWpJ.js";import"./vendor-crypto-js-C9XMI5TL.js";import"./vendor-jay-peg-DnV82Tak.js";import"./vendor-react-pdf-png-js-D_OjzuBh.js";import"./vendor-react-pdf-layout-CVT9JNgr.js";import"./vendor-react-pdf-stylesheet-B2kC1IpU.js";import"./vendor-postcss-value-parser-DOXmp8r9.js";import"./vendor-hsl-to-hex-CDkcI7Vq.js";import"./vendor-hsl-to-rgb-for-reals-jL61FXS_.js";import"./vendor-media-engine-BWjc9dwl.js";import"./vendor-react-pdf-textkit-R3VqYnwu.js";import"./vendor-bidi-js-DLACMwmw.js";import"./vendor-hyphen-B2aENclZ.js";import"./vendor-yoga-layout-nAHjiEuJ.js";import"./vendor-react-pdf-image-BJ1YGwqv.js";import"./vendor-object-assign-Dm9xdUEz.js";function jn({selectedTournaments:r,tournaments:f,roundRanges:p,setRoundRanges:y,roundsByTournament:D,globalNumericRoundMax:S}){return e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold mb-2 flex items-center justify-between gap-2",children:[e.jsx("span",{children:"Round ranges"}),e.jsx("button",{type:"button",className:`chip px-2 py-1 ${r.length===0?"opacity-50 cursor-not-allowed":""}`,"aria-label":"Add round range",title:"Add range",disabled:r.length===0,onClick:()=>{if(r.length===0)return;const x=r.length===1?r[0]:"";y([...p,{from:1,to:3,tournament:x}])},children:e.jsx(nn,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-2",children:[p.length===0&&e.jsx("div",{className:"text-xs italic text-black/70 dark:text-white/60 px-1",children:"All rounds included (no range filters). Add a range to limit rounds."}),p.map((N,x)=>{const F=r.length>0?r:f,C=r.length===1,P=r.length===0&&f.length===1,$=C||P||F.length===1,u=$&&(r[0]||F[0])||"",T=$?u:N.tournament||"",B=$?u:N.tournament||null,R=B?D[B]??[]:[],U=R.length>0&&R.every(m=>/^\d+$/.test(m));return e.jsxs("div",{className:"round-range-row w-full overflow-hidden",children:[e.jsx("div",{className:"select-wrapper flex-1 min-w-0",children:e.jsx("select",{className:"sb-select-range rounded-lg border px-3 py-1.5 shadow-none focus:outline-none "+($?"bg-gray-100 dark:bg-white/10 text-gray-500 dark:text-gray-400 border-gray-300 dark:border-white/20 cursor-not-allowed pointer-events-none":"bg-white text-black border-black/10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-darkcard dark:text-white dark:border-white/20"),value:T,disabled:$,onChange:m=>{if($)return;const j=[...p];j[x]={...j[x],tournament:m.target.value},y(j)},title:T||"All Tournaments",children:$?e.jsx("option",{value:u,children:u}):r.length===0?e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"",children:"All Tournaments"}),F.map(m=>e.jsx("option",{value:m,children:m},m))]}):F.map(m=>e.jsx("option",{value:m,children:m},m))})}),B?U?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"select-wrapper sb-select-round",children:e.jsx("select",{className:"rounded-lg border border-black/10 bg-white text-black px-2 py-1 shadow-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-darkcard dark:text-white dark:border-white/20 shrink-0 sb-select-round",value:N.from!=null&&R.includes(String(N.from))?String(N.from):R[0]??"",onChange:m=>{const j=[...p];let z=Number(m.target.value),L=Number(j[x].to);(!Number.isFinite(L)||L<z)&&(L=z),j[x]={...j[x],from:z,to:L,dFrom:void 0,dTo:void 0},y(j)},children:R.map(m=>e.jsx("option",{value:m,children:m},m))})}),e.jsx("span",{className:"text-black dark:text-white",children:"to"}),e.jsx("div",{className:"select-wrapper sb-select-round",children:e.jsx("select",{className:"rounded-lg border border-black/10 bg-white text-black px-2 py-1 shadow-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-darkcard dark:text-white dark:border-white/20 shrink-0 sb-select-round",value:N.to!=null&&R.includes(String(N.to))?String(N.to):R[R.length-1]??"",onChange:m=>{const j=[...p];let z=Number(m.target.value),L=Number(j[x].from);(!Number.isFinite(L)||L>z)&&(L=z),j[x]={...j[x],from:L,to:z,dFrom:void 0,dTo:void 0},y(j)},children:R.map(m=>e.jsx("option",{value:m,children:m},m))})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"select-wrapper sb-select-round",children:e.jsx("select",{className:"rounded-lg border border-black/10 bg-white text-black px-2 py-1 shadow-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-darkcard dark:text-white dark:border-white/20 shrink-0 sb-select-round",value:N.dFrom??R[0]??"",onChange:m=>{const j=[...p],z=m.target.value;let L=j[x].dTo;if(L){const a=R.indexOf(z),o=R.indexOf(L);a!==-1&&o!==-1&&a>o&&(L=z)}j[x]={...j[x],dFrom:z,dTo:L},y(j)},children:R.map(m=>e.jsx("option",{value:m,children:m},m))})}),e.jsx("span",{className:"text-black dark:text-white",children:"to"}),e.jsx("div",{className:"select-wrapper sb-select-round",children:e.jsx("select",{className:"rounded-lg border border-black/10 bg-white text-black px-2 py-1 shadow-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-darkcard dark:text-white dark:border-white/20 shrink-0 sb-select-round",value:N.dTo??R[R.length-1]??"",onChange:m=>{const j=[...p],z=m.target.value;let L=j[x].dFrom;if(L){const a=R.indexOf(L),o=R.indexOf(z);a!==-1&&o!==-1&&a>o&&(L=z)}j[x]={...j[x],dFrom:L??z,dTo:z},y(j)},children:R.map(m=>e.jsx("option",{value:m,children:m},m))})})]}):(()=>{const m=Array.from({length:S},(L,a)=>a+1),j=N.from!=null&&N.from>=1?N.from:m[0],z=N.to!=null&&N.to>=j||N.to!=null?N.to:m[m.length-1];return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"select-wrapper sb-select-round",children:e.jsx("select",{className:"rounded-lg border border-black/10 bg-white text-black px-2 py-1 shadow-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-darkcard dark:text-white dark:border-white/20 shrink-0 sb-select-round",value:String(j),onChange:L=>{const a=[...p];let o=Number(L.target.value),g=Number(a[x].to);(!Number.isFinite(g)||g<o)&&(g=o),a[x]={...a[x],from:o,to:g,dFrom:void 0,dTo:void 0},y(a)},children:m.map(L=>e.jsx("option",{value:L,children:L},L))})}),e.jsx("span",{className:"text-black dark:text-white",children:"to"}),e.jsx("div",{className:"select-wrapper sb-select-round",children:e.jsx("select",{className:"rounded-lg border border-black/10 bg-white text-black px-2 py-1 shadow-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-darkcard dark:text-white dark:border-white/20 shrink-0 sb-select-round",value:String(z),onChange:L=>{const a=[...p];let o=Number(L.target.value),g=Number(a[x].from);(!Number.isFinite(g)||g>o)&&(g=o),a[x]={...a[x],from:g,to:o,dFrom:void 0,dTo:void 0},y(a)},children:m.map(L=>e.jsx("option",{value:L,children:L},L))})})]})})(),e.jsx("button",{className:"chip shrink-0","aria-label":"Remove round range",title:"Remove range",onClick:()=>y(p.filter((m,j)=>j!==x)),children:e.jsx(rn,{className:"h-4 w-4"})})]},x)})]})]})}function vn({auth:r,roundsIndex:f,setRoundsIndex:p,roundFolders:y,setRoundFolders:D,loadingUserRounds:S,refresh:N,selectedExcludeRoundIds:x,setSelectedExcludeRoundIds:F,foldersOpen:C,setFoldersOpen:P,handleExcludeRoundToggle:$,pushToast:u,setManagerSelection:T,setShowRoundsManager:B,setFolderDeleteTarget:R,setDeleteTarget:U,onViewRound:m}){return r?.user?e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold mb-2 flex items-center gap-2",children:["Exclude rounds",e.jsx("button",{className:"chip px-2 py-0.5 text-xs",onClick:()=>F([]),children:"Clear"}),e.jsx("button",{className:"chip px-2 py-0.5 text-xs inline-flex items-center","aria-label":"Refresh rounds & folders",title:"Refresh",onClick:N,children:e.jsx(on,{size:14})}),e.jsx("button",{className:"chip px-2 py-0.5 text-xs inline-flex items-center","aria-label":"Create folder",title:"Create folder",onClick:async()=>{if(!r?.user)return;const j=window.prompt("Folder name");if(j==null)return;const z=j.trim();if(!z){u("Folder name cannot be empty.","error");return}const L=z.toLowerCase();if(y.some(a=>a.toLowerCase()===L)){u("Folder already exists.","error");return}try{await Jt(r.user.uid,z),D(a=>[...a,z].sort((o,g)=>o.localeCompare(g))),P(a=>{const o=new Set(a);return o.add(z),o}),u("Folder created.","success")}catch(a){u(a.message||"Failed to create folder.","error")}},children:e.jsx(an,{size:14})}),e.jsx("button",{className:"chip px-2 py-0.5 text-xs inline-flex items-center","aria-label":"Open rounds manager",title:"Manage saved rounds",onClick:()=>{T(new Set(x)),B(!0)},children:e.jsx(Yt,{size:14})})]}),S?e.jsx("div",{className:"text-sm opacity-70",children:"Loading your rounds…"}):f.length===0?e.jsx("div",{className:"text-sm opacity-70",children:"No saved rounds yet."}):e.jsx("div",{className:"border rounded-lg max-h-64 overflow-y-auto overflow-x-hidden divide-y divide-black/10 dark:divide-white/10",children:(()=>{const j=[],z=y.sort((o,g)=>o.localeCompare(g)).map(o=>{const g=C.has(o),I=f.filter(h=>h.folder===o);return e.jsxs("div",{className:"select-none",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 hover:bg-black/5 dark:hover:bg-white/10 cursor-pointer",onClick:()=>P(h=>{const v=new Set(h);return v.has(o)?v.delete(o):v.add(o),v}),onDragOver:h=>{h.preventDefault(),h.dataTransfer.dropEffect="move"},onDrop:async h=>{if(h.preventDefault(),!r?.user)return;const v=h.dataTransfer.getData("text/round-ids");if(!v)return;const E=v.split(",").filter(Boolean);for(const O of E)try{await kt(r.user.uid,O,o)}catch{}p(O=>O.map(b=>E.includes(b.id)?{...b,folder:o}:b)),u(`Moved ${E.length} round(s) to ${o}.`,"success")},children:[e.jsx("button",{type:"button",className:"p-0.5 rounded hover:bg-black/10 dark:hover:bg-white/10","aria-label":g?"Collapse folder":"Expand folder",children:g?e.jsx(Yt,{size:15}):e.jsx(ln,{size:15})}),e.jsx("input",{type:"checkbox",className:"accent-tint",ref:h=>{if(!h)return;const v=f.filter(b=>b.folder===o),E=v.length,O=v.filter(b=>x.includes(b.id)).length;h.indeterminate=O>0&&O<E},checked:(()=>{const h=f.filter(v=>v.folder===o);return h.length>0&&h.every(v=>x.includes(v.id))})(),onChange:()=>{const v=f.filter(E=>E.folder===o).map(E=>E.id);F(E=>{const O=new Set(E);return v.every(J=>O.has(J))?v.forEach(J=>O.delete(J)):v.forEach(J=>O.add(J)),Array.from(O)})},"aria-label":`Select all rounds in folder ${o}`,title:"Select all in folder"}),e.jsxs("span",{className:"font-medium flex-1 truncate",title:o,children:[o," ",e.jsxs("span",{className:"opacity-60 text-xs",children:["(",I.length,")"]})]}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-[11px] inline-flex items-center","aria-label":"Rename folder",title:"Rename folder",onClick:h=>{h.stopPropagation();const v=window.prompt("Rename folder",o);if(v==null)return;const E=v.trim();if(!(!E||E===o)){if(y.some(O=>O.toLowerCase()===E.toLowerCase())){u("Folder name already exists.","error");return}(async()=>{try{await Zt(r.user.uid,o,E),D(O=>O.map(b=>b===o?E:b)),p(O=>O.map(b=>b.folder===o?{...b,folder:E}:b)),P(O=>{const b=new Set(O);return b.has(o)&&(b.delete(o),b.add(E)),b}),u("Folder renamed.","success")}catch(O){u(O.message||"Failed to rename folder.","error")}})()}},children:e.jsx(jt,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-[11px] inline-flex items-center text-red-600 border-red-200 hover:bg-red-50 dark:text-red-300 dark:border-red-700 dark:hover:bg-red-900/30","aria-label":"Delete folder and its rounds",title:"Delete folder",onClick:h=>{h.stopPropagation();const v=f.filter(E=>E.folder===o);R({name:o,count:v.length,roundIds:v.map(E=>E.id)})},children:e.jsx(vt,{className:"h-3.5 w-3.5"})})]}),g&&e.jsx("ul",{className:"divide-y divide-black/5 dark:divide-white/10",role:"group",children:I.map(h=>{j.push(h.id);const v=h.createdAt?.seconds?new Date(h.createdAt.seconds*1e3):null,E=v?`${v.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})} on ${v.toLocaleDateString()}`:h.title||"Untitled",O=x.includes(h.id);return e.jsx("li",{draggable:!0,onDragStart:b=>{b.dataTransfer.effectAllowed="move";const J=x.includes(h.id)?x:[h.id];b.dataTransfer.setData("text/round-ids",J.join(","))},children:e.jsxs("div",{className:`group flex items-center justify-between gap-2 pl-10 pr-3 py-2 ${O?"bg-tint/10 ring-1 ring-tint":""}`,children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer flex-1 min-w-0",title:h.title||`Round ${E}`,children:[e.jsx("input",{type:"checkbox",checked:O,onChange:b=>$(b,h.id)}),e.jsx("span",{className:"block whitespace-normal overflow-visible group-hover:truncate group-focus-within:truncate",children:h.title||`Round ${E}`})]}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100 inline-flex items-center","aria-label":"View round",title:"View round",onClick:b=>{b.stopPropagation(),m?.(h)},children:e.jsx(Kt,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100 inline-flex items-center","aria-label":"Rename round",title:"Rename round",onClick:async b=>{b.stopPropagation();const J=h.title||`Round ${E}`,se=window.prompt("Rename round",J);if(se==null)return;const oe=se.trim();if(!oe||oe===J)return;if(f.some(he=>he.id!==h.id&&(he.title||"").trim().toLowerCase()===oe.toLowerCase())){u("Another round already has that title.","error");return}try{await Nt(r.user.uid,h.id,oe),p(he=>he.map(ge=>ge.id===h.id?{...ge,title:oe}:ge))}catch(he){window.alert?.(he?.message||"Failed to rename round.")}},children:e.jsx(jt,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 text-red-600 border-red-200 hover:bg-red-50 dark:text-red-300 dark:border-red-700 dark:hover:bg-red-900/30",title:"Delete round",onClick:b=>{b.stopPropagation(),U(h)},children:e.jsx(vt,{className:"h-3.5 w-3.5"})})]})},h.id)})})]},o)}),L=f.filter(o=>!o.folder),a=e.jsxs("div",{className:"select-none",onDragOver:o=>{o.preventDefault(),o.dataTransfer.dropEffect="move"},onDrop:async o=>{if(o.preventDefault(),!r?.user)return;const g=o.dataTransfer.getData("text/round-ids");if(!g)return;const I=g.split(",").filter(Boolean);for(const h of I)try{await kt(r.user.uid,h,"")}catch{}p(h=>h.map(v=>I.includes(v.id)?(()=>{const{folder:E,...O}=v;return O})():v)),u(`Cleared folder for ${I.length} round(s).`,"success")},children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-black/5 dark:bg-white/10 font-medium",children:["Unfiled ",e.jsxs("span",{className:"opacity-60 text-xs",children:["(",L.length,")"]})]}),e.jsx("ul",{className:"divide-y divide-black/5 dark:divide-white/10",role:"group",children:L.map(o=>{j.push(o.id);const g=o.createdAt?.seconds?new Date(o.createdAt.seconds*1e3):null,I=g?`${g.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})} on ${g.toLocaleDateString()}`:o.title||"Untitled",h=x.includes(o.id);return e.jsx("li",{draggable:!0,onDragStart:v=>{v.dataTransfer.effectAllowed="move";const E=x.includes(o.id)?x:[o.id];v.dataTransfer.setData("text/round-ids",E.join(","))},children:e.jsxs("div",{className:`group flex items-center justify-between gap-2 pl-6 pr-3 py-2 ${h?"bg-tint/10 ring-1 ring-tint":""}`,children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer flex-1 min-w-0",title:o.title||`Round ${I}`,children:[e.jsx("input",{type:"checkbox",checked:h,onChange:v=>$(v,o.id)}),e.jsx("span",{className:"block whitespace-normal overflow-visible group-hover:truncate group-focus-within:truncate",children:o.title||`Round ${I}`})]}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100 inline-flex items-center","aria-label":"View round",title:"View round",onClick:v=>{v.stopPropagation(),m?.(o)},children:e.jsx(Kt,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100 inline-flex items-center","aria-label":"Rename round",title:"Rename round",onClick:async v=>{v.stopPropagation();const E=o.title||`Round ${I}`,O=window.prompt("Rename round",E);if(O==null)return;const b=O.trim();if(!b||b===E)return;if(f.some(se=>se.id!==o.id&&(se.title||"").trim().toLowerCase()===b.toLowerCase())){u("Another round already has that title.","error");return}try{await Nt(r.user.uid,o.id,b),p(se=>se.map(oe=>oe.id===o.id?{...oe,title:b}:oe))}catch(se){window.alert?.(se?.message||"Failed to rename round.")}},children:e.jsx(jt,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 text-red-600 border-red-200 hover:bg-red-50 dark:text-red-300 dark:border-red-700 dark:hover:bg-red-900/30",title:"Delete round",onClick:v=>{v.stopPropagation(),U(o)},children:e.jsx(vt,{className:"h-3.5 w-3.5"})})]})},o.id)})})]},"__unfiled__");return e.jsxs(e.Fragment,{children:[z,a]})})()})]}):null}function kn({auth:r,pushToast:f}){const[p,y]=w.useState([]),[D,S]=w.useState(!1),[N,x]=w.useState([]),[F,C]=w.useState(()=>new Set),[P,$]=w.useState([]),u=w.useRef(new Map);w.useEffect(()=>{let a=!1;async function o(){if(!r?.user){y([]),u.current.clear(),x([]);return}S(!0);try{const g=await Ht(r.user.uid).catch(()=>[]);a||y(g);const I=await Wt(r.user.uid).catch(()=>[]);a||x(I)}finally{a||S(!1)}}return o(),()=>{a=!0}},[r?.user?.uid]);async function T(a,o){a?.nativeEvent?.shiftKey||a?.shiftKey;const g=P.includes(o),I=!g;if($(h=>{const v=new Set(h);return g?v.delete(o):v.add(o),Array.from(v)}),I&&r?.user&&!u.current.has(o))try{const h=await es(r.user.uid,o);h&&u.current.set(o,h)}catch{}}async function B(){if(r?.user){S(!0);try{y(await Ht(r.user.uid,{force:!0})),x(await Wt(r.user.uid,{force:!0}))}finally{S(!1)}}}async function R(a){if(!r?.user)return;if(!a?.trim()){f?.("Folder name cannot be empty.","error");return}const o=a.toLowerCase();if(N.some(g=>g.toLowerCase()===o)){f?.("Folder already exists.","error");return}await Jt(r.user.uid,a),x(g=>[...g,a].sort((I,h)=>I.localeCompare(h))),C(g=>{const I=new Set(g);return I.add(a),I}),f?.("Folder created.","success")}async function U(a,o){if(!r?.user)return;const g=o.trim();if(!(!g||g===a)){if(N.some(I=>I.toLowerCase()===g.toLowerCase())){f?.("Folder name already exists.","error");return}await Zt(r.user.uid,a,g),x(I=>I.map(h=>h===a?g:h)),y(I=>I.map(h=>h.folder===a?{...h,folder:g}:h)),C(I=>{const h=new Set(I);return h.has(a)&&(h.delete(a),h.add(g)),h}),f?.("Folder renamed.","success")}}async function m(a,o){if(r?.user){for(const g of a)try{await kt(r.user.uid,g,o)}catch{}y(g=>g.map(I=>a.includes(I.id)?{...I,folder:o}:I)),f?.(o?`Moved ${a.length} round(s) to ${o}.`:`Cleared folder for ${a.length} round(s).`,"success")}}async function j(a,o){if(!r?.user)return;if(p.some(h=>h.id!==a.id&&(h.title||"").trim().toLowerCase()===o.toLowerCase())){f?.("Another round already has that title.","error");return}await Nt(r.user.uid,a.id,o),y(h=>h.map(v=>v.id===a.id?{...v,title:o}:v));const I=u.current.get(a.id);I&&u.current.set(a.id,{...I,title:o})}async function z(a){r?.user&&(await ot(r.user.uid,a),y(o=>o.filter(g=>g.id!==a)),$(o=>o.filter(g=>g!==a)),u.current.delete(a),f?.("Round deleted.","error"))}async function L(a,o=[]){if(r?.user){for(const g of o)try{await ot(r.user.uid,g)}catch{}try{await Vs(r.user.uid,a)}catch{}y(g=>g.filter(I=>!o.includes(I.id))),$(g=>g.filter(I=>!o.includes(I))),x(g=>g.filter(I=>I!==a)),f?.("Folder and rounds deleted.","error")}}return{roundsIndex:p,setRoundsIndex:y,loadingUserRounds:D,roundFolders:N,setRoundFolders:x,foldersOpen:F,setFoldersOpen:C,selectedExcludeRoundIds:P,setSelectedExcludeRoundIds:$,excludeDetailCache:u,handleExcludeRoundToggle:T,refresh:B,createFolder:R,renameFolder:U,moveRoundsToFolder:m,renameRound:j,deleteRoundPermanently:z,deleteFolderAndRounds:L}}const _=bn.create({page:{padding:16,fontSize:8,fontFamily:"Times-Roman"},title:{textAlign:"center",fontSize:11,fontWeight:"bold",marginBottom:4},legendBlock:{marginBottom:4},tiny:{fontSize:6.5},footer:{marginTop:4,textAlign:"center",fontSize:6.5},tablesWrap:{flexDirection:"row"},teamACol:{flex:1.1,marginRight:4},teamBCol:{flex:.9,marginLeft:4},headerRow:{flexDirection:"row",backgroundColor:"#eee"},bodyRow:{flexDirection:"row"},cell:{borderWidth:.5,borderColor:"#000",paddingVertical:1.5,paddingHorizontal:2,justifyContent:"center",textAlign:"center",minHeight:12},headCellText:{fontWeight:"bold",fontSize:6.5},qnCell:{fontSize:6.5,fontWeight:"bold"},subjCell:{fontSize:6.5},attempt:{fontSize:6.5,fontWeight:"bold"},nameHead:{fontSize:6,fontWeight:"bold"},spacer:{width:4}});function Nn(r){return[4,7,6,...Array(r).fill(9),7,6,7]}function Sn(r){return[...Array(r).fill(9),7,6,7]}function Cn({playerLabels:r=[],cols:f}){const p=["Q","Subj","Type",...r,"Bonus","Pen","Score"];return e.jsx(K,{style:_.headerRow,children:p.map((y,D)=>{const S=f[D];return e.jsx(K,{style:[_.cell,{flexGrow:S,flexBasis:S}],children:e.jsx(ee,{style:_.headCellText,children:y})},D)})})}function An({playerLabels:r=[],cols:f}){const p=[...r,"Bonus","Pen","Score"];return e.jsx(K,{style:_.headerRow,children:p.map((y,D)=>{const S=f[D];return e.jsx(K,{style:[_.cell,{flexGrow:S,flexBasis:S}],children:e.jsx(ee,{style:_.headCellText,children:y})},D)})})}function Rn({r,seatPlayers:f,outRows:p,cols:y}){if(!r||r.pad)return e.jsx(K,{style:_.bodyRow,children:y.map((T,B)=>e.jsx(K,{style:[_.cell,{flexGrow:T,flexBasis:T}],children:B===0&&r?.index?e.jsx(ee,{style:_.qnCell,children:r.index}):null},B))});const D=(r.attempts||[]).filter(T=>T&&T.playerId!=null);function S(T){if(!T)return"";const B=D.filter(U=>U.playerId===T.id);if(!B.length)return"";const R=B[B.length-1];return R.result==="correct"?R.interrupt?"CI":"C":R.result==="incorrect"?R.interrupt?"II":"I":""}const N=r.bonusA,x=r.penaltyA,F=r.cumA;function C(T,B){let R=S(T);return!R&&T&&p[T.id]===r.index&&(R="out"),e.jsx(K,{style:[_.cell,{flexGrow:B,flexBasis:B}],children:e.jsx(ee,{style:_.attempt,children:R})},T?T.id:Math.random())}const P=y.slice(0,3),$=y.slice(3,3+f.length),u=y.slice(3+f.length);return e.jsxs(K,{style:_.bodyRow,children:[e.jsx(K,{style:[_.cell,{flexGrow:P[0],flexBasis:P[0]}],children:e.jsx(ee,{style:_.qnCell,children:r.index})}),e.jsx(K,{style:[_.cell,{flexGrow:P[1],flexBasis:P[1]}],children:e.jsx(ee,{style:_.subjCell,children:r.subject})}),e.jsx(K,{style:[_.cell,{flexGrow:P[2],flexBasis:P[2]}],children:e.jsx(ee,{style:_.subjCell,children:r.type})}),f.map((T,B)=>C(T,$[B])),e.jsx(K,{style:[_.cell,{flexGrow:u[0],flexBasis:u[0]}],children:e.jsx(ee,{children:N?String(N):""})}),e.jsx(K,{style:[_.cell,{flexGrow:u[1],flexBasis:u[1]}],children:e.jsx(ee,{children:x?String(x):""})}),e.jsx(K,{style:[_.cell,{flexGrow:u[2],flexBasis:u[2]}],children:e.jsx(ee,{children:F!=null?String(F):""})})]})}function Tn({r,seatPlayers:f,outRows:p,cols:y}){if(!r||r.pad)return e.jsx(K,{style:_.bodyRow,children:y.map((u,T)=>e.jsx(K,{style:[_.cell,{flexGrow:u,flexBasis:u}]},T))});const D=(r.attempts||[]).filter(u=>u&&u.playerId!=null);function S(u){if(!u)return"";const T=D.filter(R=>R.playerId===u.id);if(!T.length)return"";const B=T[T.length-1];return B.result==="correct"?B.interrupt?"CI":"C":B.result==="incorrect"?B.interrupt?"II":"I":""}const N=r.bonusB,x=r.penaltyB,F=r.cumB;function C(u,T){let B=S(u);return!B&&u&&p[u.id]===r.index&&(B="out"),e.jsx(K,{style:[_.cell,{flexGrow:T,flexBasis:T}],children:e.jsx(ee,{style:_.attempt,children:B})},u?u.id:Math.random())}const P=y.slice(0,f.length),$=y.slice(f.length);return e.jsxs(K,{style:_.bodyRow,children:[f.map((u,T)=>C(u,P[T])),e.jsx(K,{style:[_.cell,{flexGrow:$[0],flexBasis:$[0]}],children:e.jsx(ee,{children:N?String(N):""})}),e.jsx(K,{style:[_.cell,{flexGrow:$[1],flexBasis:$[1]}],children:e.jsx(ee,{children:x?String(x):""})}),e.jsx(K,{style:[_.cell,{flexGrow:$[2],flexBasis:$[2]}],children:e.jsx(ee,{children:F!=null?String(F):""})})]})}function Bn({sheetRows:r=[],players:f=[],metadata:p={}}){const y=f.filter(a=>a.team==="A").sort((a,o)=>(a.seat||0)-(o.seat||0)),D=f.filter(a=>a.team==="B").sort((a,o)=>(a.seat||0)-(o.seat||0)),S=y.filter(a=>(a.seat||0)>=1&&(a.seat||0)<=4).sort((a,o)=>a.seat-o.seat),N=D.filter(a=>(a.seat||0)>=1&&(a.seat||0)<=4).sort((a,o)=>a.seat-o.seat),x=y.find(a=>(a.seat||0)===5&&a.status==="active"),F=D.find(a=>(a.seat||0)===5&&a.status==="active"),C=x?[...S,x]:[...S],P=F?[...N,F]:[...N],$=(a,o)=>a&&a.name?In(a.name,9):o,u=C.map((a,o)=>$(a,["Captain","P1","P2","P3","Sub"][o]||"P"+(o+1))),T=P.map((a,o)=>$(a,["Captain","P1","P2","P3","Sub"][o]||"P"+(o+1))),B=Nn(C.length),R=Sn(P.length);function U(a,o){if(!a.length)return{};const g={};for(const h of r){if(!h||h.pad)continue;const v=h.index;for(const E of h.attempts||[])!E||E.team!==o||a.includes(E.playerId)&&(g[E.playerId]=v)}const I={};for(const h of a){const v=g[h];v&&v<25&&(I[h]=v+1)}return I}const m=y.filter(a=>a.status==="replaced").map(a=>a.id),j=D.filter(a=>a.status==="replaced").map(a=>a.id),z=U(m,"A"),L=U(j,"B");return e.jsx(wn,{children:e.jsxs(yn,{size:"LETTER",style:_.page,orientation:"landscape",children:[e.jsx(ee,{style:_.title,children:"Coaches Scoresheet"}),e.jsxs(K,{style:_.legendBlock,children:[e.jsx(ee,{style:_.tiny,children:"Subjects: E ESS | C Chemistry | B Bio | M Math | P Physics | EN Energy"}),e.jsx(ee,{style:_.tiny,children:"Types: MC Multiple Choice | SA Short Answer | Markers: C / CI / I / II | 'out' = player substituted"})]}),e.jsxs(K,{style:_.tablesWrap,children:[e.jsxs(K,{style:_.teamACol,children:[e.jsx(Cn,{playerLabels:u,cols:B}),r.slice(0,25).map(a=>e.jsx(Rn,{r:a,seatPlayers:C,outRows:z,cols:B},"A-"+a.index))]}),e.jsxs(K,{style:_.teamBCol,children:[e.jsx(An,{playerLabels:T,cols:R}),r.slice(0,25).map(a=>e.jsx(Tn,{r:a,seatPlayers:P,outRows:L,cols:R},"B-"+a.index))]})]}),e.jsxs(ee,{style:_.footer,children:["Generated ",p.generatedAt||""," | scibowl.app"]})]})})}function In(r,f){return r?r.length<=f?r:r.slice(0,f-1)+"…":""}function Ln({pair:r,index:f,scorekeeping:p=!1,currentIndex:y=0,tossupResults:D=[],showBonusContent:S,questionRef:N}){const x=r.tossup?Pe(r.tossup):[],F=r.bonus?Pe(r.bonus):[],C=!p||f===y,[P,$]=Z.useState(null),[u,T]=Z.useState(!1);return Z.useEffect(()=>{let B=!1;async function R(){$(null);const U=r?.bonus;if(!U||!(U.is_visual_bonus===!0||String(U.visual||"").toLowerCase()==="true"))return;const j=await ts({tournament:U.tournament,round:U.round,question_number:U.question_number}).catch(()=>null);B||$(j)}return S&&R(),()=>{B=!0}},[r?.bonus?.tournament,r?.bonus?.round,r?.bonus?.question_number,S]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:N,className:`glass p-6 space-y-4 min-w-0 relative ${p&&!C?"opacity-50 blur-sm select-none pointer-events-none":""}`,children:[p&&f===y&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-0 rounded-lg pointer-events-none border-2 border-green-500 shadow-[0_0_0_3px_rgba(34,197,94,0.35)]",style:{boxShadow:"0 0 0 3px rgba(34,197,94,0.35), 0 4px 12px -2px rgba(16,185,129,0.5)"}}),e.jsx("div",{className:"absolute -top-3 left-4 px-3 py-1 bg-green-600 text-white rounded-full text-[11px] font-semibold shadow-lg",children:"Active"})]}),r.tossup&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-sm text-black/60 dark:text-white/80 mb-2",children:[e.jsx("span",{className:"font-semibold",children:String(r.tossup.tournament).toUpperCase()})," • ","Round ",r.tossup.round??"—"," • ",r.tossup.category,r.tossup.question_number!=null&&e.jsxs(e.Fragment,{children:[" • ","Q",r.tossup.question_number]}),e.jsx("span",{className:"ml-2 inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold tracking-wide border "+(x.length>0?"bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-900/20 dark:text-blue-200 dark:border-blue-700":"bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/20 dark:text-purple-200 dark:border-purple-700"),children:x.length>0?"MULTIPLE CHOICE":"SHORT ANSWER"})]}),e.jsxs("div",{className:"font-medium mb-2",children:["Toss-up ",f+1]}),e.jsx("div",{className:"mb-3 whitespace-pre-line",children:e.jsx(pe,{children:r.tossup.question})}),x.length>0&&e.jsx("div",{className:"mb-3",children:x.map(([B,R])=>e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`gen-tossup-${f}`,className:"accent-tint",disabled:!0}),e.jsxs("span",{children:[B.toUpperCase(),") ",e.jsx(pe,{children:R})]})]},B))}),e.jsxs("div",{className:"text-sm text-black/70 dark:text-white/80",children:[e.jsx("span",{className:"uppercase text-black/60 dark:text-white/60",children:"Answer:"})," ",e.jsx("span",{className:"text-black dark:text-white",children:e.jsx(pe,{children:r.tossup.answer})})]})]}),r.bonus&&S&&e.jsxs("div",{className:r.tossup?"mt-6 pt-4 border-t":"mt-2",children:[e.jsxs("div",{className:"text-sm text-black/60 dark:text-white/80 mb-2",children:[e.jsx("span",{className:"font-semibold",children:String(r.tossup?r.tossup.tournament:r.bonus.tournament).toUpperCase()})," • ","Round ",r.bonus.round??"—"," • ",r.bonus.category,r.bonus.question_number!=null&&e.jsxs(e.Fragment,{children:[" • ","Q",r.bonus.question_number]}),e.jsx("span",{className:"ml-2 inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold tracking-wide border "+(F.length>0?"bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-900/20 dark:text-blue-200 dark:border-blue-700":"bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/20 dark:text-purple-200 dark:border-purple-700"),children:F.length>0?"MULTIPLE CHOICE":"SHORT ANSWER"})]}),e.jsxs("div",{className:"font-semibold mb-2",children:["Bonus ",f+1]}),P&&e.jsxs("div",{className:"mb-3",children:[e.jsx("img",{src:P,alt:`Visual bonus${r?.bonus?.tournament?` • ${r.bonus.tournament}`:""}${r?.bonus?.round?` • Round ${r.bonus.round}`:""}${r?.bonus?.question_number!=null?` • Q${r.bonus.question_number}`:""}`,className:"max-h-64 rounded-md border border-black/10 dark:border-white/10 object-contain cursor-zoom-in hover:opacity-95 transition",onClick:()=>T(!0)}),e.jsx("div",{className:"text-xs text-black/60 dark:text-white/60 mt-1",children:"Click image to view full screen"})]}),e.jsx("div",{className:"mb-2 whitespace-pre-line",children:e.jsx(pe,{children:r.bonus.question})}),F.length>0&&e.jsx("div",{className:"mb-3",children:F.map(([B,R])=>e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`gen-bonus-${f}`,className:"accent-tint",disabled:!0}),e.jsxs("span",{children:[B.toUpperCase(),") ",e.jsx(pe,{children:R})]})]},B))}),e.jsxs("div",{className:"text-sm text-black/70 dark:text-white/80",children:[e.jsx("span",{className:"uppercase text-black/60 dark:text-white/60",children:"Answer:"})," ",e.jsx("span",{className:"text-black dark:text-white",children:e.jsx(pe,{children:r.bonus.answer})})]})]})]}),u&&P&&e.jsxs("div",{className:"fixed inset-0 z-[90] flex items-center justify-center",role:"dialog","aria-modal":"true","aria-label":"Visual bonus image",children:[e.jsx("div",{className:"absolute inset-0 bg-black/80",onClick:()=>T(!1)}),e.jsxs("div",{className:"relative max-w-[96vw] max-h-[96vh] p-2",children:[e.jsx("img",{src:P,alt:"Visual bonus full screen",className:"max-w-[96vw] max-h-[92vh] object-contain rounded shadow-2xl"}),e.jsx("button",{type:"button",className:"absolute -top-3 -right-3 bg-white text-black rounded-full shadow p-2 hover:bg-white/90 focus:outline-none","aria-label":"Close full screen image",onClick:()=>T(!1),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"h-4 w-4",children:e.jsx("path",{fillRule:"evenodd",d:"M4.22 4.22a.75.75 0 011.06 0L10 8.94l4.72-4.72a.75.75 0 111.06 1.06L11.06 10l4.72 4.72a.75.75 0 11-1.06 1.06L10 11.06l-4.72 4.72a.75.75 0 01-1.06-1.06L8.94 10 4.22 5.28a.75.75 0 010-1.06z",clipRule:"evenodd"})})})]}),e.jsx(Mn,{onClose:()=>T(!1)})]})]})}function Mn({onClose:r}){return Z.useEffect(()=>{const f=p=>{p.key==="Escape"&&r?.()};return window.addEventListener("keydown",f),()=>window.removeEventListener("keydown",f)},[r]),null}function Fn({displayPairs:r,QUESTIONS_PER_PAGE:f=2,pdfRef:p}){const[y,D]=Z.useState({});return Z.useEffect(()=>{let S=!1;return(async()=>{const N={};for(let x=0;x<r.length;x++){const F=r[x]?.bonus;if(!(!F||!(F.is_visual_bonus===!0||String(F.visual||"").toLowerCase()==="true")))try{const P=await ts({tournament:F.tournament,round:F.round,question_number:F.question_number});P&&(N[x]=P)}catch{}}S||D(N)})(),()=>{S=!0}},[r]),e.jsx("div",{"aria-hidden":"true",style:{position:"fixed",left:"-10000px",top:0,width:816,pointerEvents:"none",opacity:0,visibility:"visible"},children:e.jsxs("div",{ref:p,className:"pdf-root",children:[e.jsx("style",{children:`
          .pdf-root, .pdf-root * { box-sizing: border-box; }
          .html2pdf__page-break + .pdf-header { margin-top: 0 !important; }
          @page { margin: 12mm; }
          .pdf-root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, 'Apple Color Emoji', 'Segoe UI Emoji'; color: #000; margin: 0; padding: 0; }
          .pdf-page { width: 720px; margin: 0 auto; padding: 2mm 4px 0 4px; }
          .pdf-page { page-break-after: always; }
          .pdf-page:last-child { page-break-after: auto; }
          .pdf-header { text-align: center; font-size: 16px; font-weight: bold; margin-bottom: 2mm; padding: 0 2px; }
          .pdf-q { page-break-inside: avoid; break-inside: avoid; margin-bottom: 4mm; }
          .pdf-hr { border: none; border-top: 1px solid #888; margin: 8px 0; }
          .pdf-meta { font-size: 11px; color: #333; margin-bottom: 2mm; }
          .pdf-title { font-weight: 600; margin-bottom: 2mm; }
          .pdf-body { white-space: pre-wrap; line-height: 1.4; word-break: break-word; overflow-wrap: anywhere; }
          .pdf-choices { margin: 2mm 0; break-inside: avoid; }
          .pdf-choice { display: flex; align-items: flex-start; gap: 4px; line-height: 1.35; }
          .pdf-choice-key { font-weight: 600; width: 16px; flex: 0 0 auto; }
          .pdf-choice-val { flex: 1; }
          .pdf-ans { font-size: 12px; margin-top: 2mm; }
          .pdf-footer { text-align: center; font-size: 12px; color: #888; margin-top: 2mm; }
          .katex-display { margin: 0; }
        `}),(()=>{const S=[];for(let F=0;F<r.length;F+=f){const C=r.slice(F,F+f);C.length>0&&S.push(C)}const N=new Date().toLocaleDateString(),x="scibowl.app";return S.map((F,C)=>{const P=C*f,$=C+1;return e.jsxs("div",{className:"pdf-page",children:[e.jsxs("div",{className:"pdf-header",children:[x," — ",N]}),F.map((u,T)=>{const B=P+T,R=u.tossup?Pe(u.tossup):[],U=u.bonus?Pe(u.bonus):[];return e.jsxs(Z.Fragment,{children:[e.jsxs("div",{className:"pdf-q",children:[u.tossup&&e.jsxs("div",{children:[e.jsxs("div",{className:"pdf-meta",children:[u.tossup.tournament," • Round ",u.tossup.round??"—"," • ",u.tossup.category,u.tossup.question_number!=null?` • Q${u.tossup.question_number}`:"",e.jsx("span",{style:R.length>0?rt("mc"):rt("sa"),children:R.length>0?"MULTIPLE CHOICE":"SHORT ANSWER"})]}),e.jsxs("div",{className:"pdf-title",children:["Toss-up ",B+1]}),e.jsx("div",{className:"pdf-body",children:e.jsx(pe,{children:u.tossup.question})}),R.length>0&&e.jsx("div",{className:"pdf-choices",children:R.map(([m,j])=>e.jsxs("div",{className:"pdf-choice",children:[e.jsxs("span",{className:"pdf-choice-key",children:[m.toUpperCase(),")"]}),e.jsx("span",{className:"pdf-choice-val",children:e.jsx(pe,{children:j})})]},m))}),e.jsxs("div",{className:"pdf-ans",children:[e.jsx("span",{style:{opacity:.7},children:"Answer:"})," ",e.jsx(pe,{children:u.tossup.answer})]})]}),u.bonus&&e.jsxs("div",{style:{marginTop:u.tossup?"6mm":0,paddingTop:u.tossup?"2mm":0,borderTop:u.tossup?"1px solid #ddd":"none"},children:[e.jsxs("div",{className:"pdf-meta",children:[u.tossup?u.tossup.tournament:u.bonus.tournament," • Round ",u.bonus.round??"—"," • ",u.bonus.category,u.bonus.question_number!=null?` • Q${u.bonus.question_number}`:"",e.jsx("span",{style:U.length>0?rt("mc"):rt("sa"),children:U.length>0?"MULTIPLE CHOICE":"SHORT ANSWER"})]}),e.jsxs("div",{className:"pdf-title",children:["Bonus ",B+1]}),y[B]&&e.jsx("div",{className:"pdf-body",style:{marginBottom:"2mm"},children:e.jsx("img",{src:y[B],alt:"Visual bonus",style:{maxHeight:220,width:"100%",objectFit:"contain",border:"1px solid #e5e7eb",borderRadius:6}})}),e.jsx("div",{className:"pdf-body",children:e.jsx(pe,{children:u.bonus.question})}),U.length>0&&e.jsx("div",{className:"pdf-choices",children:U.map(([m,j])=>e.jsxs("div",{className:"pdf-choice",children:[e.jsxs("span",{className:"pdf-choice-key",children:[m.toUpperCase(),")"]}),e.jsx("span",{className:"pdf-choice-val",children:e.jsx(pe,{children:j})})]},m))}),e.jsxs("div",{className:"pdf-ans",children:[e.jsx("span",{style:{opacity:.7},children:"Answer:"})," ",e.jsx(pe,{children:u.bonus.answer})]})]})]}),T<F.length-1&&e.jsx("hr",{className:"pdf-hr"})]},`pdf-${B}`)}),e.jsxs("div",{className:"pdf-footer",children:["Page ",$," of ",S.length]})]},`pdf-group-${C}`)})})()]})})}function rt(r){return r==="mc"?{marginLeft:6,border:"1px solid #bfdbfe",background:"#eff6ff",color:"#1d4ed8",borderRadius:9999,padding:"1px 6px",fontSize:10,fontWeight:600}:{marginLeft:6,border:"1px solid #e9d5ff",background:"#faf5ff",color:"#6b21a8",borderRadius:9999,padding:"1px 6px",fontSize:10,fontWeight:600}}function $n({searchInput:r,setSearchInput:f,committedSearch:p,setCommittedSearch:y,hasGenerated:D=!1}){return e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold mb-2 flex items-center gap-2",children:["Search",p&&e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs",onClick:()=>{f(""),y("")},"aria-label":"Clear search",children:"Clear"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(cn,{className:"h-4 w-4 absolute left-2 top-1/2 -translate-y-1/2 text-black/50 dark:text-white/50 pointer-events-none"}),e.jsx("input",{type:"text",value:r,onChange:S=>f(S.target.value),onKeyDown:S=>{S.key==="Enter"&&y(r)},placeholder:"Find text in generated round...",className:"w-full pl-8 pr-3 py-1.5 rounded-lg border border-black/10 bg-white dark:bg-darkcard text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Search questions",disabled:!D})]}),e.jsx("button",{type:"button",className:"btn btn-sm btn-primary whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed",disabled:!D||!r.trim()||r.trim()===p.trim(),onClick:()=>y(r),children:"Search"})]}),p.trim()&&e.jsxs("div",{className:"text-xs mt-1 opacity-70",children:['Showing all matches containing "',p,'" (ignores other filters except selected tournaments for loading).']})]})}function Dn({headerOffset:r,close:f,currentIndex:p,displayPairs:y,awaitingPlayer:D,interruptArmed:S,setAwaitingPlayer:N,setInterruptArmed:x,typedAnswerActive:F,setTypedAnswerActive:C,typedAnswerText:P,setTypedAnswerText:$,typedAnswerPlayerId:u,typedAnswerLoading:T,typedAnswerReason:B,checkTypedAnswer:R,isTossupFinal:U,recordNoAnswer:m,throwOutAndReplace:j,tossupResults:z,bonusResults:L,saveFixedBonus:a,players:o,handleSeatClick:g,allowedTeams:I,totalPoints:h,teamPoints:v,saveBonusPoints:E,subMode:O,setSubMode:b,resetScorekeeping:J,exportCoachesScoresheetPdf:se,coachesSheetLoading:oe,tryoutsMode:ze,setTryoutsMode:he,questionType:ge}){return e.jsxs("div",{className:"fixed right-0 z-50 w-[400px] bg-white dark:bg-darkcard border-l border-black/10 dark:border-white/10 shadow-xl flex flex-col",style:{top:r,height:`calc(100vh - ${r}px)`},children:[e.jsxs("div",{className:"px-4 py-3 border-b border-black/10 dark:border-white/10 flex items-center justify-between",children:[e.jsx("h2",{className:"font-semibold text-sm",children:"Scorekeeper"}),e.jsx("button",{className:"text-xs chip",onClick:f,children:"Close"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-4 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{children:["Q ",Math.min(p+1,y.length)," / ",y.length]}),e.jsx("div",{className:"text-[10px] mt-0.5 opacity-70",children:I.length===0?"No buzz":"Buzz: "+I.join("/")})]}),e.jsxs("div",{className:"font-semibold text-xs leading-tight flex flex-col items-end",children:[e.jsxs("span",{children:["Total ",h]}),e.jsxs("span",{className:"text-green-600 dark:text-green-400",children:["A ",v.A]}),e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:["B ",v.B]})]})]}),p>=y.length&&e.jsx("div",{className:"p-2 rounded bg-emerald-600 text-white text-center text-xs",children:"Round complete"}),p<y.length&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-[11px] font-medium",children:[e.jsx("input",{type:"checkbox",className:"scale-110",checked:!!ze,onChange:Q=>he(Q.target.checked),disabled:ge!=="tossup",title:ge==="tossup"?"Tryouts mode: an incorrect buzz only locks that player; others may continue buzzing.":"Switch question type to Toss-ups to enable Tryouts mode."}),"Tryouts"]}),ge!=="tossup"&&e.jsx("span",{className:"text-[10px] opacity-60",children:"Toss-ups only"})]}),e.jsxs("div",{className:"grid grid-cols-6 gap-2",children:[e.jsxs("button",{className:`col-span-2 chip flex items-center justify-center gap-1 text-xs disabled:opacity-40 disabled:cursor-not-allowed disabled:brightness-75 ${D?.type==="incorrect"?"ring-2 ring-red-500":""}`,onClick:()=>N({type:"incorrect",interrupt:S}),disabled:U(p),title:"Mark incorrect then click player seat (then select player)",children:[e.jsx(dn,{color:"#ff2600",className:"h-4 w-4"})," Incorrect"]}),e.jsxs("button",{className:`col-span-2 chip flex items-center justify-center gap-1 text-xs disabled:opacity-40 disabled:cursor-not-allowed disabled:brightness-75 ${D?.type==="correct"?"ring-2 ring-green-500":""}`,onClick:()=>N({type:"correct",interrupt:S}),disabled:U(p),title:"Mark correct then click player seat",children:[e.jsx(un,{color:"#00f900",className:"h-4 w-4"})," Correct"]}),e.jsx("button",{className:`col-span-2 chip flex items-center justify-center gap-1 text-xs disabled:opacity-40 disabled:cursor-not-allowed disabled:brightness-75 ${S?"bg-purple-600 text-white ring-2 ring-purple-500":""}`,onClick:()=>x(Q=>!Q),disabled:U(p),title:"Toggle interrupt (applies to next correct/incorrect)",children:S?"Interrupt ON":"Interrupt"})]}),S&&y[p]?.tossup&&!U(p)&&e.jsxs("div",{className:"space-y-1 rounded-md border border-black/10 dark:border-white/10 p-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-[11px] font-medium",children:"Typed answer (AI check)"}),e.jsx("button",{type:"button",className:`chip text-[11px] px-2 py-0.5 ${F?"bg-purple-600 text-white":""}`,onClick:()=>C(Q=>!Q),title:"Toggle typed answer entry for interrupts",children:F?"Hide":"Type Answer"})]}),F&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-[10px] opacity-70",children:"Select a player seat, then enter the answer as given and check with AI."}),e.jsx("input",{type:"text",className:"w-full rounded border border-black/10 dark:border-white/10 bg-white dark:bg-darkcard px-2 py-1 text-xs",placeholder:"Type the player’s answer…",value:P,onChange:Q=>$(Q.target.value),disabled:T}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"text-[10px]",children:["Seat: ",u?"selected":"—"]}),e.jsx("button",{type:"button",className:"chip text-[11px] bg-tint text-white disabled:opacity-50 disabled:cursor-not-allowed",onClick:R,disabled:T||!u||!P.trim(),children:T?"Checking…":"Check with AI"})]}),B&&e.jsxs("div",{className:"text-[10px] opacity-80",children:["AI: ",B]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{className:"chip text-xs disabled:opacity-40 disabled:cursor-not-allowed",onClick:m,disabled:U(p),title:"Record as no answer and advance (attempts already made remain in the log)",children:"No Answer"}),e.jsx("button",{className:"chip text-xs",onClick:j,children:"Throw Out & Replace"})]}),z[p]?.result==="correct"&&y[p]?.bonus&&y[p]?.tossup&&!L[p]&&e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("button",{className:"chip text-xs bg-green-600 text-white hover:bg-green-700",onClick:()=>{a(!0)},children:"Award +10"}),e.jsx("button",{className:"chip text-xs bg-red-600 text-white hover:bg-red-700",onClick:()=>{a(!1)},children:"No Bonus"})]}),L[p]&&e.jsxs("div",{className:"text-xs",children:["Bonus: ",L[p].points," pts"]}),D&&e.jsxs("div",{className:"text-xs text-center text-blue-600 dark:text-blue-300",children:["Select a player seat to apply a ",D.interrupt?"Interrupt ":"",D.type,"."]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium flex items-center gap-2 justify-between",children:[e.jsxs("span",{children:["Players ",O&&e.jsx("span",{className:"text-[10px] font-normal px-1.5 py-0.5 rounded bg-purple-600 text-white",children:"SUB MODE"})]}),e.jsx("button",{type:"button",className:"chip px-2 py-1 text-[11px]",onClick:()=>b(!0),title:"Open substitution modal",children:"Substitute"})]}),e.jsx("div",{className:"space-y-6",children:["A","B"].map(Q=>e.jsxs("div",{children:[e.jsxs("div",{className:`text-[12px] font-semibold mb-2 tracking-wide ${Q==="A"?"text-green-600 dark:text-green-400":"text-blue-600 dark:text-blue-400"}`,children:["Team ",Q]}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:o.filter(H=>H.team===Q).map(H=>{const Le=o.findIndex(Ve=>Ve.id===H.id);let je=H.status==="replaced"||D&&!I.includes(H.team);return ze&&ge==="tossup"&&D&&((z[p]?.attempts||[]).some(at=>at.playerId===H.id)?je=!0:je=H.status==="replaced"),e.jsxs("button",{onClick:()=>g(Le),className:`relative flex flex-col items-center justify-center h-24 rounded-xl border border-black/10 dark:border-white/10 ${je?"bg-black/10 dark:bg-white/10 opacity-40 cursor-not-allowed":"bg-gradient-to-br from-black/5 to-black/10 dark:from-white/10 dark:to-white/5 hover:from-black/10 hover:to-black/20 dark:hover:from-white/20 dark:hover:to-white/10"} transition text-[11px] font-medium ${D&&!je&&H.status!=="replaced"?"ring-2 ring-offset-2 ring-green-500 dark:ring-green-400 animate-pulse-slow":""}`,title:H.name||`Seat ${Q}${H.seat??(H.id<=4?H.id:H.id-4)}`,disabled:H.status==="replaced",children:[e.jsx(mn,{className:"h-7 w-7 opacity-70"}),e.jsx("span",{className:"mt-2 truncate max-w-[120px] px-2 text-center leading-tight",children:H.name||`Seat ${Q}${H.seat??(H.id<=4?H.id:H.id-4)}`}),H.status==="replaced"&&e.jsx("span",{className:"absolute top-1 left-1 text-[10px] bg-red-600 text-white px-1 rounded",children:"OUT"}),H.stats.correct+H.stats.correctInterrupt>0&&e.jsx("span",{className:"absolute top-0 right-0 text-[10px] bg-green-600 text-white rounded-bl px-1",children:H.stats.correct+H.stats.correctInterrupt})]},H.id)})})]},Q))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium mb-1",children:"Player Stats"}),e.jsxs("table",{className:"w-full text-[10px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-[9px] text-black/70 dark:text-white/70",children:[e.jsx("th",{className:"text-left",children:"Player"}),e.jsx("th",{children:"Tm"}),e.jsx("th",{children:"C"}),e.jsx("th",{children:"I"}),e.jsx("th",{children:"CI"}),e.jsx("th",{children:"II"})]})}),e.jsx("tbody",{children:o.filter(Q=>Q.name).map(Q=>e.jsxs("tr",{className:"odd:bg-black/0 even:bg-black/5 dark:even:bg-white/5",children:[e.jsx("td",{className:"truncate max-w-[90px] pr-1",children:Q.name}),e.jsx("td",{className:"text-center",children:Q.team}),e.jsx("td",{className:"text-center",children:Q.stats.correct}),e.jsx("td",{className:"text-center",children:Q.stats.incorrect}),e.jsx("td",{className:"text-center",children:Q.stats.correctInterrupt}),e.jsx("td",{className:"text-center",children:Q.stats.incorrectInterrupt})]},Q.id))})]})]}),p>=y.length&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{className:"btn btn-orange w-full justify-center",onClick:se,disabled:oe,children:oe?"Generating…":"Coaches Scoresheet PDF"}),e.jsx("button",{className:"btn btn-ghost w-full justify-center",onClick:()=>J(),children:"Reset Scorekeeping"})]})]})]})}function En({open:r,onClose:f,players:p,onSubmit:y,initialTeam:D="A"}){const[S,N]=w.useState(D),[x,F]=w.useState(null),[C,P]=w.useState(""),[$,u]=w.useState(!1);if(w.useEffect(()=>{if(r){N(D);const m=p.filter(j=>j.team===D)[0];F(m?.id??null),P(""),u(!1)}},[r,D,p]),!r)return null;const T=p.filter(m=>m.team===S),R=p.filter(m=>m.team===S).length>=5,U=C.trim().length>0&&x!=null&&!R;return p.find(m=>m.id===x),e.jsxs("div",{className:"fixed inset-0 z-[75] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:f}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl w-full max-w-md border border-black/10 dark:border-white/10 p-6 flex flex-col gap-5",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Substitute Player"}),e.jsx("button",{type:"button",className:"chip text-xs",onClick:f,children:"Close"})]}),e.jsxs("div",{className:"space-y-4 text-sm",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"font-medium text-xs uppercase tracking-wide",children:"Team"}),e.jsx("div",{className:"flex gap-2",children:["A","B"].map(m=>e.jsxs("button",{type:"button",className:`chip px-3 py-1 text-sm ${S===m?"ring-2 ring-tint bg-tint/10":""}`,onClick:()=>{N(m);const j=p.filter(z=>z.team===m)[0];F(j?.id??null)},children:["Team ",m]},m))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"font-medium text-xs uppercase tracking-wide",children:"Outgoing Seat"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:T.map(m=>e.jsxs("button",{type:"button",onClick:()=>F(m.id),className:`chip flex flex-col items-center gap-1 py-2 ${x===m.id?"ring-2 ring-tint bg-tint/10":""}`,children:[e.jsx("span",{className:"text-[11px] font-semibold",children:m.name||`Seat ${S}${m.seat??(m.id<=4?m.id:m.id-4)}`}),m.name&&e.jsxs("span",{className:"text-[10px] opacity-60",children:[m.stats.correct+m.stats.correctInterrupt," C / ",m.stats.incorrect+m.stats.incorrectInterrupt," I"]})]},m.id))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"font-medium text-xs uppercase tracking-wide",htmlFor:"new-player-name",children:"New Player Name"}),e.jsx("input",{id:"new-player-name",type:"text",className:"w-full rounded-lg border border-black/10 dark:border-white/10 bg-white dark:bg-darkcard px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-tint",placeholder:"Enter name",value:C,onChange:m=>{P(m.target.value),u(!0)},autoFocus:!0}),$&&C.trim()===""&&e.jsx("div",{className:"text-[11px] text-red-600 mt-1",children:"Name required."})]}),R&&e.jsx("div",{className:"text-[11px] text-red-600",children:"Team already has a substitute (5 players shown). Further substitutions disabled."})]}),e.jsxs("div",{className:"flex flex-col gap-2 pt-2",children:[e.jsx("button",{type:"button",disabled:!U,onClick:()=>{U&&(y({team:S,playerId:x,newName:C.trim()}),f())},className:"btn btn-primary w-full justify-center disabled:opacity-40 disabled:cursor-not-allowed",children:"Apply Substitution"}),e.jsx("button",{type:"button",onClick:f,className:"btn btn-ghost w-full justify-center",children:"Cancel"})]})]})]})}function So({questions:r=[],lazy:f=null,auth:p=null,persistedGenerated:y=null,setPersistedGenerated:D=null,onNewRound:S=null}){const{isLazy:N,tournaments:x,tournamentGroups:F,selectedTournaments:C,setSelectedTournaments:P,selectedCategories:$,setSelectedCategories:u,tournamentGroupsOpen:T,setTournamentGroupsOpen:B,tournamentVisibleEntriesMainRef:R,handleTournamentToggle:U,loadedQuestions:m,validQuestions:j,categories:z,roundRanges:L,setRoundRanges:a,roundsByTournament:o,globalNumericRoundMax:g,inRanges:I}=Xs({questions:r,lazy:f}),[h,v]=w.useState(!1),[E,O]=w.useState([]);function b(t,s="info",i=4e3){const l=Math.random().toString(36).slice(2),c=Date.now();O(n=>[...n,{id:l,message:t,type:s,ttl:i,created:c}]),i>0&&setTimeout(()=>O(n=>n.filter(d=>d.id!==l)),i+50)}const{roundsIndex:J,setRoundsIndex:se,loadingUserRounds:oe,roundFolders:ze,setRoundFolders:he,foldersOpen:ge,setFoldersOpen:Q,selectedExcludeRoundIds:H,setSelectedExcludeRoundIds:Le,excludeDetailCache:je,handleExcludeRoundToggle:Ve,refresh:at,deleteFolderAndRounds:ss}=kn({auth:p,pushToast:b});w.useRef(null),w.useRef(null);const[ns,rs]=w.useState(!1),[fe,os]=w.useState(10),[as,ls]=w.useState([]),ue=Array.isArray(y)?y:as,we=typeof D=="function"?D:ls,{history:te}=Hs(),[_e,lt]=w.useState(null);Z.useEffect(()=>{Array.isArray(te)&&te.length>0?lt(te.length-1):lt(null)},[te]);function St(t){if(!Array.isArray(te)||te.length===0||t<0||t>=te.length)return;gt(""),lt(t);const s=te[t]||[];we(s),$e(!0),Ye();try{window.scrollTo({top:0,behavior:"smooth"})}catch{}}const[xe,is]=w.useState(!0),[be,cs]=w.useState(!0),[ye,ds]=w.useState(!1),[re,Ct]=w.useState("both"),it=xe&&be&&ye,At=!xe&&be&&ye;Z.useEffect(()=>{let t="both";xe&&be?t="both":xe&&!be?t="tossup":!xe&&be&&!ye?t="bonus":!xe&&!be&&ye?t="visual-bonus":!xe&&be&&ye?t="bonus":t="both",Ct(t)},[xe,be,ye]);const Rt=Z.useRef(null),us=2,[Tt,Bt]=w.useState(!1),[He,It]=w.useState(!1),[ms,ps]=w.useState(!1),[hs,fs]=w.useState(()=>{try{return document.documentElement.classList.contains("dark")}catch{return!1}});Z.useEffect(()=>{try{const t=document.documentElement,s=()=>fs(t.classList.contains("dark"));s();const i=new MutationObserver(s);i.observe(t,{attributes:!0,attributeFilter:["class"]});const l=window.matchMedia("(prefers-color-scheme: dark)");return l.addEventListener("change",s),()=>{i.disconnect(),l.removeEventListener("change",s)}}catch{}},[]);const[ae,Lt]=w.useState(!1),xs=w.useRef(9),[X,Oe]=w.useState(()=>Array.from({length:8},(t,s)=>({id:s+1,team:s<4?"A":"B",seat:s<4?s+1:s-3,name:"",status:"active",stats:{correct:0,incorrect:0,correctInterrupt:0,incorrectInterrupt:0}}))),[V,ct]=w.useState(0),[le,Se]=w.useState(null),[bs,Me]=w.useState(!1),[dt,ut]=w.useState(!1),[Mt,mt]=w.useState(""),[pt,ht]=w.useState(null),[gs,Ft]=w.useState(!1),[ws,ft]=w.useState(""),[ie,Ue]=w.useState([]),[ve,We]=w.useState([]),[$t,me]=w.useState(null),[xt,ce]=w.useState(["A","B"]),[Ce,Dt]=w.useState(!1);Z.useEffect(()=>{try{localStorage.getItem("sb_tryoutsMode")==="1"&&Dt(!0)}catch{}},[]),Z.useEffect(()=>{try{localStorage.setItem("sb_tryoutsMode",Ce?"1":"0")}catch{}},[Ce]);const[ys,Et]=w.useState(!1),[Pn,zn]=w.useState("A"),[js,Pt]=w.useState(!1),[vs,Qe]=w.useState(""),[bt,zt]=w.useState(0),_t=w.useRef([]);Z.useEffect(()=>{function t(){const s=document.querySelector("header, .site-header, .app-header, .top-bar");if(s){const i=s.getBoundingClientRect();zt(i.height)}else zt(0)}return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),Z.useEffect(()=>{if(!ae)return;const t=_t.current[V];if(t&&typeof t.scrollIntoView=="function"){const s=Math.max(bt+12,0),i=t.getBoundingClientRect(),l=window.scrollY+i.top-s;window.scrollTo({top:l,behavior:"smooth"})}},[V,ae,bt]);const ks=w.useMemo(()=>{let t=0;return ie.forEach(s=>{s&&(Array.isArray(s.attempts)?s.attempts.forEach(i=>{typeof i.points=="number"&&(t+=i.points)}):typeof s.points=="number"&&(t+=s.points))}),ve.forEach(s=>{s&&typeof s.points=="number"&&(t+=s.points)}),t},[ie,ve]),Ns=w.useMemo(()=>{const t={A:0,B:0};return ie.forEach(s=>{if(s){if(Array.isArray(s.attempts)&&s.attempts.length)s.attempts.forEach(i=>{const l=X.find(c=>c.id===i.playerId)?.team;l&&(t[l]+=i.points||0)});else if(s.playerId){const i=X.find(l=>l.id===s.playerId)?.team;i&&(t[i]+=s.points||0)}}}),ve.forEach(s=>{s?.team&&(t[s.team]+=s.points||0)}),t},[ie,ve,X]);function Ye(){ct(0),Se(null),Ue([]),We([]),Qe(""),me(null),ce(["A","B"]),Et(!1)}function Ss(t){const s=X[t];if(s){if(dt){if(!xt.includes(s.team)){b(`Team ${s.team} not allowed to buzz now.`,"error");return}if(s.status==="replaced"){b("Cannot buzz: seat replaced.","error");return}if(Ce&&re==="tossup"&&(ie[V]?.attempts||[]).some(l=>l.playerId===s.id)){b("This player already attempted this toss-up.","error");return}ht(s.id),b(`Selected ${s.name||`Seat ${s.team}${s.seat??""}`} for typed interrupt.`,"info",2500);return}if(s.status==="replaced"){b("Cannot buzz: seat replaced.","error");return}if(le){if(!xt.includes(s.team)){b(`Team ${s.team} not allowed to buzz now.`,"error");return}const{type:i,interrupt:l}=le,c=$t==null;if(Ue(n=>{const d=[...n],k=i==="correct"?4:i==="incorrect"&&l?-4:0,M=d[V]||{},A=Array.isArray(M.attempts)?[...M.attempts]:[];return A.push({playerId:s.id,team:s.team,result:i,interrupt:l,points:k}),i==="correct"?d[V]={...M,attempts:A,result:"correct",playerId:s.id,interrupt:l,points:k}:c?d[V]={...M,attempts:A,result:"incorrect",playerId:s.id,interrupt:l,points:k}:d[V]={...M,attempts:A,result:"incorrect",playerId:s.id,interrupt:l,points:k},d}),Oe(n=>n.map(d=>d.id===s.id?{...d,stats:{...d.stats,correct:d.stats.correct+(le.type==="correct"&&!le.interrupt?1:0),incorrect:d.stats.incorrect+(le.type==="incorrect"&&!le.interrupt?1:0),correctInterrupt:d.stats.correctInterrupt+(le.type==="correct"&&le.interrupt?1:0),incorrectInterrupt:d.stats.incorrectInterrupt+(le.type==="incorrect"&&le.interrupt?1:0)}}:d)),Se(null),Me(!1),c&&le.type==="incorrect")Ce&&re==="tossup"?(me(null),ce(["A","B"])):(me(s.team),ce([s.team==="A"?"B":"A"]));else if(le.type==="incorrect")me(null),ce([]),setTimeout(()=>Fe(),200);else if(le.type==="correct"){me(null),ce([]);const n=ne[V];n?.bonus&&n.tossup?Qe(""):setTimeout(()=>Fe(),150)}return}if(s.name){const i=window.prompt("Rename player",s.name);i!=null&&Oe(l=>l.map((c,n)=>n===t?{...c,name:i.trim()}:c))}else{const i=window.prompt("Enter player name (seat "+(t+1)+")","");i!=null&&Oe(l=>l.map((c,n)=>n===t?{...c,name:i.trim()}:c))}}}function Cs({player:t,type:s,interrupt:i}){if(!t)return;const l=$t==null;if(Ue(c=>{const n=[...c],d=s==="correct"?4:s==="incorrect"&&i?-4:0,k=n[V]||{},M=Array.isArray(k.attempts)?[...k.attempts]:[];return M.push({playerId:t.id,team:t.team,result:s,interrupt:i,points:d}),s==="correct"?n[V]={...k,attempts:M,result:"correct",playerId:t.id,interrupt:i,points:d}:n[V]={...k,attempts:M,result:"incorrect",playerId:t.id,interrupt:i,points:d},n}),Oe(c=>c.map(n=>n.id===t.id?{...n,stats:{...n.stats,correct:n.stats.correct+0,incorrect:n.stats.incorrect+0,correctInterrupt:n.stats.correctInterrupt+(s==="correct"&&i?1:0),incorrectInterrupt:n.stats.incorrectInterrupt+(s==="incorrect"&&i?1:0)}}:n)),Se(null),Me(!1),s==="incorrect")l?Ce&&re==="tossup"?(me(null),ce(["A","B"])):(me(t.team),ce([t.team==="A"?"B":"A"])):(me(null),ce([]),setTimeout(()=>Fe(),200));else if(s==="correct"){me(null),ce([]);const c=ne[V];c?.bonus&&c.tossup?Qe(""):setTimeout(()=>Fe(),150)}}async function As(){try{if(!dt)return;const s=ne[V]?.tossup;if(!s){b("No toss-up at this question.","error");return}if(!pt){b("Select a player seat first.","error");return}const i=X.find(Y=>Y.id===pt);if(!i){b("Invalid player selection.","error");return}const l=String(Mt||"").trim();if(!l){b("Enter an answer to check.","error");return}Ft(!0),ft("");const c=Pe(s),n=Array.isArray(c)&&c.length>0,d={userAnswer:l,correctAnswer:s.answer,question:s.question};n&&(d.choices=c);const k=await(n?en(d):tn(d)).catch(Y=>({ok:!1,statusText:Y?.message}));if(!k||!k.ok){b("AI check failed. You can record manually.","error");return}const M=await k.json().catch(()=>({})),A=!!M?.correct,W=typeof M?.reason=="string"?M.reason:"";ft(W||""),Cs({player:i,type:A?"correct":"incorrect",interrupt:!0}),b(A?"AI: Correct interrupt.":"AI: Incorrect interrupt.",A?"success":"error")}catch(t){console.error(t),b("AI check encountered an error.","error")}finally{Ft(!1),ut(!1),mt(""),ht(null),setTimeout(()=>ft(""),4e3)}}function Rs(){Ue(t=>{const s=[...t],i=s[V]||{},l=Array.isArray(i.attempts)?i.attempts:[];return s[V]={...i,attempts:l,result:"no-answer",points:i.points||0},s}),Se(null),Me(!1),ce([]),setTimeout(()=>Fe(),150)}function Fe(){const t=ne[V],s=ie[V];t?.bonus&&t?.tossup&&s?.result==="correct"&&!ve[V]||(ct(i=>Math.min(i+1,ne.length)),me(null),ce(["A","B"]))}function Ts(){const t=Number(vs);if(!Number.isFinite(t)||t<0)return;const s=Math.min(10,Math.max(0,t)),i=ie[V],l=i?.playerId&&X.find(c=>c.id===i.playerId)?.team||"A";We(c=>{const n=[...c];return n[V]={points:s,team:l},n}),Qe(""),setTimeout(()=>Fe(),100)}function Bs(t){const s=ie[t];if(!s)return!1;if(s.result==="replaced"||s.result==="no-answer"||s.result==="correct")return!0;if(Ce&&re==="tossup"){const c=s.attempts||[],n=new Set(c.map(k=>k.playerId));return X.filter(k=>k.status!=="replaced").filter(k=>!n.has(k.id)).length===0}const i=s.attempts||[];return new Set(i.map(c=>X.find(n=>n.id===c.playerId)?.team).filter(Boolean)).size>=2&&s.result==="incorrect"}function Is(t){const s=t?10:0,i=ie[V],l=i?.playerId&&X.find(c=>c.id===i.playerId)?.team||"A";We(c=>{const n=[...c];return n[V]={points:s,team:l},n}),Se(null),Me(!1),me(null),ce(["A","B"]),ct(c=>Math.min(c+1,ne.length))}function Ls(){if(!ne[V])return;const s=new Set(ne.flatMap(c=>[c.tossup?.id,c.bonus?.id].filter(Boolean))),i=et(),l=i.find(c=>!s.has(c.tossup?.id)&&!s.has(c.bonus?.id))||i[0];we(c=>c.map((n,d)=>d===V?l:n)),Ue(c=>{const n=[...c];return n[V]=void 0,n}),We(c=>{const n=[...c];return n[V]=void 0,n}),me(null),ce(["A","B"]),Se(null),Me(!1),ut(!1),mt(""),ht(null),b("Question replaced.","info")}const[Ms,Ot]=w.useState(!1);async function Fs(){Ot(!0);try{const t=await gn(e.jsx(Bn,{sheetRows:Os,players:X,metadata:{generatedAt:new Date().toLocaleString()}})).toBlob(),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download="Coaches-Scoresheet-"+new Date().toISOString().slice(0,10)+".pdf",document.body.appendChild(i),i.click(),setTimeout(()=>{URL.revokeObjectURL(s),i.remove()},1e3)}catch(t){console.error("Failed to export coaches scoresheet (react-pdf):",t),window.alert?.("Failed to export coaches scoresheet: "+(t.message||String(t)))}finally{Ot(!1)}}const Ut=25,[$s,Ds]=w.useState(""),[Ae,gt]=w.useState(""),[Es,$e]=w.useState(!1),[Ps,qe]=w.useState(!1),[Re,Ke]=w.useState(null),[Xe,qt]=w.useState(!1),[zs,wt]=w.useState(!1),[Te,Be]=w.useState(new Set),[De,Je]=w.useState(null),[Ze,Gt]=w.useState(!1);w.useRef([]),w.useRef(null),Z.useEffect(()=>{const t=()=>{try{const s=window.scrollY||document.documentElement.scrollTop||0;ps(s>300)}catch{}};return window.addEventListener("scroll",t,{passive:!0}),t(),()=>window.removeEventListener("scroll",t)},[]);function et(){const t=new Set;H.filter(l=>!je.current.has(l));for(const l of H){const c=je.current.get(l);if(c){const n=Qs(c);for(const d of n)t.add(d)}}function s(l,c){if(l.length===0||c<=0)return[];const n=new Map;for(const G of l)n.has(G.category)||n.set(G.category,[]),n.get(G.category).push(G);let d=Array.from(n.keys());if($.length){const G=new Set($);d=d.filter(de=>G.has(de))}if(d=d.filter(G=>(n.get(G)?.length||0)>0),d.length===0)return[];const k=[...d].sort(()=>Math.random()-.5),M=Math.floor(c/k.length);let A=c%k.length;const W=[],Y=new Set;for(let G=0;G<k.length;G++){const de=k[G],ke=[...n.get(de)];ke.sort(()=>Math.random()-.5);const tt=Math.min(M+(A>0?1:0),ke.length);A>0&&A--;for(let Ge=0;Ge<tt;Ge++){const Ne=ke[Ge];Y.has(Ne.id)||(W.push(Ne),Y.add(Ne.id))}}if(W.length<c){const G=[];for(const de of d)for(const ke of n.get(de))Y.has(ke.id)||G.push(ke);G.sort(()=>Math.random()-.5);for(const de of G){if(W.length>=c)break;W.push(de),Y.add(de.id)}}return W.slice(0,c)}let i=[];if(re==="tossup"){const l=j.filter(n=>(C.length?C.includes(n.tournament):!0)&&I(n)&&n.question_type?.toLowerCase()==="tossup"&&!t.has(n.id)),c=l.length<=fe?[...l]:s(l,fe);for(let n=c.length-1;n>0;n--){const d=Math.floor(Math.random()*(n+1));[c[n],c[d]]=[c[d],c[n]]}i=c.map(n=>({tossup:n,bonus:null}))}else if(re==="bonus"){const l=j.filter(n=>(C.length?C.includes(n.tournament):!0)&&I(n)&&n.question_type?.toLowerCase()==="bonus"&&(At?!0:!Ee(n))&&!t.has(n.id)),c=l.length<=fe?[...l]:s(l,fe);for(let n=c.length-1;n>0;n--){const d=Math.floor(Math.random()*(n+1));[c[n],c[d]]=[c[d],c[n]]}i=c.map(n=>({tossup:null,bonus:n}))}else if(re==="visual-bonus"){const l=j.filter(n=>(C.length?C.includes(n.tournament):!0)&&I(n)&&n.question_type?.toLowerCase()==="bonus"&&Ee(n)&&!t.has(n.id)),c=l.length<=fe?[...l]:s(l,fe);for(let n=c.length-1;n>0;n--){const d=Math.floor(Math.random()*(n+1));[c[n],c[d]]=[c[d],c[n]]}i=c.map(n=>({tossup:null,bonus:n}))}else{const c=j.filter(d=>(C.length?C.includes(d.tournament):!0)&&I(d)&&d.question_type?.toLowerCase()==="tossup"&&!t.has(d.id)).filter(d=>{const k=Qt(d,j);return!(!k||t.has(k.id)||!it&&Ee(k))}),n=c.length<=fe?[...c]:s(c,fe);for(let d=n.length-1;d>0;d--){const k=Math.floor(Math.random()*(d+1));[n[d],n[k]]=[n[k],n[d]]}i=n.map(d=>{const k=Qt(d,j),M=k&&(it||!Ee(k))&&!t.has(k.id)?k:null;return{tossup:d,bonus:M}})}return i}Z.useEffect(()=>{N&&C.length!==0&&f.ensureLoaded(C)},[N,f,C]);const _s=w.useMemo(()=>{const t=Ae.trim().toLowerCase();return t?j.filter(s=>[s.question,s.answer,s.category,s.tournament,s.round].some(l=>l!=null&&String(l).toLowerCase().includes(t))).map(s=>({tossup:s.question_type?.toLowerCase()==="tossup"?s:null,bonus:s.question_type?.toLowerCase()==="bonus"?s:null})):[]},[Ae,j]),ne=Ae.trim()&&ue.length>0?_s:ue,Os=w.useMemo(()=>{const t=[];for(let l=0;l<Math.min(ne.length,Ut);l++){const c=ne[l],n=c.tossup,d=ie[l],k=ve[l],M=n?Pe(n).length>0:!1,A=d?.attempts||[],W={A:A.filter(Y=>X.find(G=>G.id===Y.playerId)?.team==="A"),B:A.filter(Y=>X.find(G=>G.id===Y.playerId)?.team==="B")};t.push({index:l+1,subject:Js(n?.category||c.bonus?.category),type:M?"MC":"SA",attempts:A,byTeam:W,bonusA:k&&k.team==="A"?k.points:0,bonusB:k&&k.team==="B"?k.points:0,penaltyA:A.filter(Y=>X.find(G=>G.id===Y.playerId)?.team==="A"&&(Y.points||0)<0).reduce((Y,G)=>Y+Math.abs(G.points||0),0),penaltyB:A.filter(Y=>X.find(G=>G.id===Y.playerId)?.team==="B"&&(Y.points||0)<0).reduce((Y,G)=>Y+Math.abs(G.points||0),0),bonusAwardedTeam:k?.team||null})}for(;t.length<Ut;)t.push({pad:!0,index:t.length+1});let s=0,i=0;return t.forEach(l=>{if(l.pad){l.cumA=s,l.cumB=i;return}const c=(l.attempts||[]).filter(d=>X.find(k=>k.id===d.playerId)?.team==="A").reduce((d,k)=>d+(k.points||0),0),n=(l.attempts||[]).filter(d=>X.find(k=>k.id===d.playerId)?.team==="B").reduce((d,k)=>d+(k.points||0),0);s+=c+(l.bonusA||0),i+=n+(l.bonusB||0),l.cumA=s,l.cumB=i}),t},[ne,ie,ve,X]);async function yt(t={}){const{force:s=!1}=t;if(Ae.trim())return;if(!xe&&!be&&!ye){b("Select at least one question type (Toss-ups, Bonuses, or Visual bonuses).","error");return}if(rs(!0),!s&&ue.length>0&&Es){qe(!0);return}try{N&&C.length>0&&await f.ensureLoaded(C)}catch{}console.group("RoundGenerator.generate"),console.log("Filters:",{selectedTournaments:C,selectedCategories:$,roundRanges:L,count:fe,questionType:re});try{const l=Math.max(1,Number(fe)||1);async function c(){const A=await Ys({questionType:re,categories:$,count:l}).catch(()=>({roundId:null}));if(!(A?.roundId||null))return{pairs:[],tournaments:[]};const Y=Array.isArray(A.pairs)?A.pairs:[];if(Y.length===0)return{pairs:[],tournaments:[]};const G=new Set;for(const q of Y){const st=q?.tossupMeta?.tournament;st&&G.add(st);const nt=q?.bonusMeta?.tournament;nt&&G.add(nt)}const de=Array.from(G);try{N&&de.length&&await f.ensureLoaded(de)}catch{}const ke=N?f.getLoadedQuestions(de):j,tt=new Map(ke.map(q=>[q.id,q])),Ge=new Set($),Ne=q=>!(!q||$.length&&!Ge.has(q.category));let Ie=Y.map(q=>({tossup:q.tossupId&&tt.get(q.tossupId)||null,bonus:q.bonusId&&tt.get(q.bonusId)||null}));return re==="tossup"?Ie=Ie.map(q=>q.tossup?{tossup:q.tossup,bonus:null}:null).filter(Boolean).filter(q=>Ne(q.tossup)):re==="bonus"?Ie=Ie.map(q=>q.bonus?{tossup:null,bonus:q.bonus}:null).filter(Boolean).filter(q=>Ne(q.bonus)).filter(q=>At?!0:!Ee(q.bonus)):Ie=Ie.map(q=>{const st=Ne(q.tossup),nt=q.bonus?Ne(q.bonus):!0,Gs=q.bonus?nt&&(it||!Ee(q.bonus)):!0;return st?{tossup:q.tossup,bonus:Gs?q.bonus:null}:null}).filter(Boolean),{pairs:Ie,tournaments:de}}const n=[],d=new Set,k=A=>{let W="";re==="tossup"?W=A.tossup?.id?`tu:${A.tossup.id}`:"":re==="bonus"?W=A.bonus?.id?`bo:${A.bonus.id}`:"":W=A.tossup?.id?`tu:${A.tossup.id}`:A.bonus?.id?`bo:${A.bonus.id}`:"",!(!W||d.has(W))&&(d.add(W),n.push(A))};if((await c()).pairs.forEach(k),n.length>=l){const A=n.slice(0,l);typeof S=="function"?S(A):we(A),$e(!0),console.groupEnd();return}if(n.length<l&&(await c()).pairs.forEach(k),n.length>=l){const A=n.slice(0,l);typeof S=="function"?S(A):we(A),$e(!0),console.groupEnd();return}n.length>0&&b("Not enough preset questions matched filters; using normal generator.","info",5e3)}catch(l){console.warn("Preset round claim/materialization failed; falling back.",l)}const i=et();typeof S=="function"?S(i):we(i),i.length===0&&b("No questions match the criteria provided.","error",5e3),$e(!0),console.groupEnd()}async function Vt(){if(!p?.user){window.alert?.("Please log in to save rounds.");return}It(!0);try{let t=ue;if((!t||t.length===0)&&(t=et(),we(t)),!t||t.length===0)return;const s=new Date,l={title:`Round at ${s.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})} on ${s.toLocaleDateString()}`,questionType:re,count:t.length,tournaments:C,categories:$,roundRanges:L,pairs:t.map(n=>({tossupId:n.tossup?.id||null,bonusId:n.bonus?.id||null,tossupMeta:n.tossup?{tournament:n.tossup.tournament,round:n.tossup.round,question_number:n.tossup.question_number,category:n.tossup.category}:null,bonusMeta:n.bonus?{tournament:n.bonus.tournament,round:n.bonus.round,question_number:n.bonus.question_number,category:n.bonus.category}:null}))},c=await Ks(p.user.uid,l);se(n=>[{id:c,title:l.title,createdAt:{seconds:Math.floor(Date.now()/1e3)},count:l.count},...n]),b("Round saved to your account.","success"),$e(!1)}catch(t){console.error(t),window.alert?.(`Failed to save round: ${t.message||String(t)}`),b(`Failed to save round: ${t.message||String(t)}`,"error",6e3)}finally{It(!1)}}async function Us(){if(N&&C.length===0&&ue.length===0&&(m?.length??0)===0){window.alert?.("Select at least one tournament to generate a PDF.");return}Bt(!0);try{let t=[];if(Ae.trim()?t=ne:(t=ue,(!t||t.length===0)&&(t=et(),we(t),await new Promise(c=>requestAnimationFrame(()=>c())).then(()=>new Promise(c=>setTimeout(c,0))))),!t||t.length===0)return;const s=Rt.current;if(!s)return;const i=await sn(),l={margin:[12,12,12,12],filename:`SciBowl-Round-${new Date().toISOString().slice(0,10)}.pdf`,image:{type:"jpeg",quality:.95},html2canvas:{scale:2,useCORS:!0,letterRendering:!0,scrollY:0},pagebreak:{mode:["css","legacy"]},jsPDF:{unit:"mm",format:"letter",orientation:"portrait"}};await i().from(s).set(l).save()}finally{Bt(!1)}}async function qs(t){try{if(!p?.user||!t?.id)return;const s=await es(p.user.uid,t.id).catch(()=>null);if(!s){b("Failed to open round details.","error");return}const i=new Set;for(const M of s.pairs||[])M?.tossupMeta?.tournament&&i.add(M.tossupMeta.tournament),M?.bonusMeta?.tournament&&i.add(M.bonusMeta.tournament);const l=Array.from(i);try{N&&l.length&&await f.ensureLoaded(l)}catch{}const c=N?f.getLoadedQuestions(l.length?l:C):j,n=new Map;for(const M of c)n.set(M.id,M);let d=(s.pairs||[]).map(M=>({tuId:M.tossupId||null,boId:M.bonusId||null,tossup:M.tossupId&&n.get(M.tossupId)||null,bonus:M.bonusId&&n.get(M.bonusId)||null}));if(d.some(M=>M.tuId&&!M.tossup||M.boId&&!M.bonus)){const M=N?f.getLoadedQuestions(Array.from(new Set([...l||[],...C]))):j,A=new Map;for(const W of M)A.set(W.id,W);d=d.map(W=>({...W,tossup:W.tossup||W.tuId&&A.get(W.tuId)||null,bonus:W.bonus||W.boId&&A.get(W.boId)||null}))}const k=d.map(({tossup:M,bonus:A})=>({tossup:M,bonus:A})).filter(M=>M.tossup||M.bonus);if(!k.length){b("Round questions are not available in the current dataset.","error");return}we(k),$e(!1),gt("");try{Array.isArray(s.tournaments)&&s.tournaments.length&&P(s.tournaments),Array.isArray(s.categories)&&u(s.categories),s.roundRanges&&a(s.roundRanges),s.questionType&&Ct(s.questionType)}catch{}Ye(),window.scrollTo({top:0,behavior:"smooth"}),b("Round opened.","success")}catch(s){b(s?.message||"Failed to open round.","error")}}return Z.useEffect(()=>{ue&&ue.length>0||(async()=>{try{const t=await Ws("sb_current_round_meta");if(!Array.isArray(t)||t.length===0)return;const s=new Set;for(const d of t)d?.tu?.tournament&&s.add(d.tu.tournament),d?.bo?.tournament&&s.add(d.bo.tournament);const i=Array.from(s);try{N&&i.length&&await f.ensureLoaded(i)}catch{}const l=N?f.getLoadedQuestions(i.length?i:C):j,c=new Map(l.map(d=>[d.id,d])),n=t.map(d=>({tossup:d?.tu?.id&&c.get(d.tu.id)||null,bonus:d?.bo?.id&&c.get(d.bo.id)||null})).filter(d=>d.tossup||d.bonus);n.length>0&&we(n)}catch{}})()},[N,f,j]),e.jsxs("div",{className:`grid gap-6 md:grid-cols-3 max-w-[100vw] w-full overflow-x-hidden ${ae?"transition-all":""}`,style:ae?{paddingRight:420}:void 0,children:[e.jsx("div",{className:`md:self-start ${ae?"hidden":""}`,children:e.jsxs("div",{className:"glass p-6 space-y-6 overflow-x-hidden min-w-0",children:[e.jsx($n,{searchInput:$s,setSearchInput:Ds,committedSearch:Ae,setCommittedSearch:gt,hasGenerated:ue.length>0}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2",children:"Question Types"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("label",{className:`chip cursor-pointer ${xe?"ring-1 ring-tint bg-tint/10":""}`,children:[e.jsx("input",{type:"checkbox",className:"mr-1",checked:xe,onChange:t=>is(t.target.checked)})," Toss-ups"]}),e.jsxs("label",{className:`chip cursor-pointer ${be?"ring-1 ring-tint bg-tint/10":""}`,children:[e.jsx("input",{type:"checkbox",className:"mr-1",checked:be,onChange:t=>cs(t.target.checked)})," Bonuses"]}),e.jsxs("label",{className:`chip cursor-pointer ${ye?"ring-1 ring-tint bg-tint/10":""}`,title:"Bonuses that have associated visual images",children:[e.jsx("input",{type:"checkbox",className:"mr-1",checked:ye,onChange:t=>ds(t.target.checked)})," Visual bonuses"]})]})]}),C.length===0&&e.jsxs("div",{role:"alert","aria-live":"polite",className:"flex items-start gap-2 rounded-lg border-l-4 border-amber-500 bg-amber-50 text-amber-900 dark:border-amber-400 dark:bg-amber-900/20 dark:text-amber-100 px-3 py-2",children:[e.jsx(pn,{className:"mt-0.5 h-4 w-4 shrink-0"}),e.jsx("div",{className:"text-sm",children:"No tournaments selected."})]}),e.jsx(Zs,{tournaments:x,tournamentGroups:F,selectedTournaments:C,setSelectedTournaments:P,tournamentGroupsOpen:T,setTournamentGroupsOpen:B,handleTournamentToggle:U,tournamentVisibleEntriesMainRef:R,isDark:hs,showTournamentModal:h,setShowTournamentModal:v}),p?.user&&e.jsx(vn,{auth:p,roundsIndex:J,setRoundsIndex:se,roundFolders:ze,setRoundFolders:he,loadingUserRounds:oe,refresh:at,selectedExcludeRoundIds:H,setSelectedExcludeRoundIds:Le,foldersOpen:ge,setFoldersOpen:Q,handleExcludeRoundToggle:Ve,pushToast:b,setManagerSelection:Be,setShowRoundsManager:wt,setFolderDeleteTarget:Je,setDeleteTarget:Ke,onViewRound:qs}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold mb-2 flex items-center gap-2",children:["Categories",e.jsx("button",{className:"chip px-2 py-0.5 text-xs",onClick:()=>u([]),children:"Clear"}),e.jsx("button",{className:"chip px-2 py-0.5 text-xs",onClick:()=>u(z),children:"Select All"}),e.jsx("button",{className:"chip px-2 py-0.5 text-xs",onClick:()=>{new Set(z),u(t=>z.filter(s=>!t.includes(s)))},children:"Invert"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 min-w-0",children:z.map(t=>{const s=$.includes(t);return e.jsxs("label",{className:`chip cursor-pointer ${s?"ring-1 ring-tint bg-tint/10":""}`,title:t,children:[e.jsx("input",{type:"checkbox",className:"mr-1",checked:s,onChange:()=>u(i=>i.includes(t)?i.filter(l=>l!==t):[...i,t])}),e.jsx("span",{className:"truncate max-w-[12rem] inline-block align-middle",children:t})]},t)})})]}),e.jsx(jn,{selectedTournaments:C,tournaments:x,roundRanges:L,setRoundRanges:a,roundsByTournament:o,globalNumericRoundMax:g}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("label",{className:"text-black dark:text-white",children:"Count"}),e.jsx("input",{type:"number",min:1,max:50,className:"w-24 rounded-lg border border-black/10 bg-white dark:bg-darkcard text-black dark:text-white px-2 py-1",value:fe,onChange:t=>os(Number(t.target.value))})]}),e.jsxs("div",{className:"pt-2 flex flex-wrap justify-center gap-4 w-full",children:[e.jsxs("button",{className:"btn btn-fancy flex items-center gap-2 hover-lift",onClick:yt,style:{minWidth:140},children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 4V2m0 20v-2m7-7h-2M4 12H2m16.24-6.24l-1.42 1.42M6.34 17.66l-1.42 1.42M17.66 17.66l-1.42-1.42M6.34 6.34l-1.42-1.42M12 8a4 4 0 100 8 4 4 0 000-8z"})}),"Generate"]}),p?.user?e.jsxs("button",{className:"btn btn-outline-fancy flex items-center gap-2 hover-lift disabled:opacity-50 disabled:cursor-not-allowed",onClick:Vt,disabled:He||ue.length===0,style:{minWidth:140},children:[e.jsx(Xt,{className:"h-5 w-5"}),He?"Saving…":"Save Round"]}):e.jsxs("button",{className:"btn btn-outline-fancy flex items-center gap-2 hover-lift disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>window.alert?.("Log in to save rounds."),disabled:ue.length===0,style:{minWidth:140},children:[e.jsx(Xt,{className:"h-5 w-5"}),"Save Round"]}),e.jsx("button",{className:"btn btn-ghost btn-sm hover-lift disabled:opacity-50 disabled:cursor-not-allowed",disabled:Tt,onClick:Us,title:"Generate and export as PDF",children:Tt?e.jsxs("span",{className:"inline-flex items-center",children:[e.jsx("span",{className:"h-4 w-4 mr-2 inline-block animate-spin rounded-full border-2 border-current border-t-transparent","aria-hidden":"true"}),"Generating..."]}):e.jsxs("span",{className:"inline-flex items-center",children:[e.jsx(hn,{className:"h-4 w-4 mr-1"})," Generate PDF"]})}),e.jsxs("button",{className:`btn flex items-center gap-2 hover-lift disabled:opacity-50 disabled:cursor-not-allowed ${ae?"btn-orange":"btn-fancy"}`,onClick:()=>{ae||Ye(),Lt(t=>!t)},style:{minWidth:140},title:ae?"Close Scorekeeper":"Open Scorekeeper",disabled:ue.length===0,children:[e.jsx(fn,{className:"h-5 w-5"})," ",ae?"Close":"Scorekeeper"]})]}),Array.isArray(te)&&te.length>0&&e.jsxs("div",{className:"mt-3 flex items-center justify-center gap-3 text-sm",children:[e.jsx("button",{className:"chip px-2 py-1 disabled:opacity-50",onClick:()=>St((_e??te.length-1)-1),disabled:(_e??te.length-1)<=0,"aria-label":"Previous generated round",children:"◀ Prev"}),e.jsxs("div",{className:"opacity-80",children:["Round ",(_e??te.length-1)+1," of ",te.length," (this session)"]}),e.jsx("button",{className:"chip px-2 py-1 disabled:opacity-50",onClick:()=>St((_e??te.length-1)+1),disabled:(_e??te.length-1)>=te.length-1,"aria-label":"Next generated round",children:"Next ▶"})]})]})}),e.jsxs("div",{className:`${ae?"md:col-span-3":"md:col-span-2"} space-y-4 min-w-0 overflow-x-hidden`,children:[null,ne.length===0&&e.jsx("div",{className:"glass p-6",role:"status","aria-live":"polite",children:Ae.trim()?"No matches found.":ns?"No questions match the criteria provided.":"No questions generated yet."}),ne.map((t,s)=>{const l=(!ae||s===V)&&(!ae||!t.tossup||ie[s]?.result==="correct"||s<V);return e.jsx(Ln,{pair:t,index:s,scorekeeping:ae,currentIndex:V,tossupResults:ie,showBonusContent:l,questionRef:c=>{_t.current[s]=c}},`${t.tossup?.id??"tu"}-${t.bonus?.id??"bo"}-${s}`)})]}),ae&&e.jsx(Dn,{headerOffset:bt,close:()=>Lt(!1),currentIndex:V,displayPairs:ne,awaitingPlayer:le,interruptArmed:bs,setAwaitingPlayer:Se,setInterruptArmed:Me,typedAnswerActive:dt,setTypedAnswerActive:ut,typedAnswerText:Mt,setTypedAnswerText:mt,typedAnswerPlayerId:pt,typedAnswerLoading:gs,typedAnswerReason:ws,checkTypedAnswer:As,isTossupFinal:Bs,recordNoAnswer:Rs,throwOutAndReplace:Ls,tossupResults:ie,bonusResults:ve,saveFixedBonus:Is,players:X,handleSeatClick:Ss,allowedTeams:xt,totalPoints:ks,teamPoints:Ns,saveBonusPoints:Ts,subMode:ys,setSubMode:()=>{Pt(!0)},resetScorekeeping:Ye,exportCoachesScoresheetPdf:Fs,coachesSheetLoading:Ms,tryoutsMode:Ce,setTryoutsMode:Dt,questionType:re}),e.jsx(Fn,{displayPairs:ne,QUESTIONS_PER_PAGE:us,pdfRef:Rt}),ms&&e.jsxs("button",{type:"button",onClick:()=>window.scrollTo({top:0,behavior:"smooth"}),"aria-label":"Back to top",className:"fixed bottom-6 right-6 z-40 inline-flex items-center gap-2 rounded-full bg-tint text-white shadow-lg px-4 py-2 hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-tint",children:[e.jsx(xn,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Top"})]}),Ps&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:()=>qe(!1)}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl max-w-sm w-full p-6 space-y-4 border border-black/10 dark:border-white/10",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Unsaved round"}),e.jsx("p",{className:"text-sm leading-relaxed text-black/70 dark:text-white/70",children:"You already have a generated round that hasn't been saved. What would you like to do?"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{disabled:He,onClick:async()=>{await Vt(),qe(!1),yt({force:!0})},className:"btn btn-primary w-full justify-center disabled:opacity-60",children:He?"Saving…":"Save & Generate New"}),e.jsx("button",{onClick:()=>{qe(!1),console.log("Discarding unsaved round and generating new"),yt({force:!0})},className:"btn btn-orange w-full justify-center",children:"Generate Without Saving"}),e.jsx("button",{onClick:()=>qe(!1),className:"btn btn-ghost w-full justify-center",children:"Cancel"})]})]})]}),Re&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:()=>!Xe&&Ke(null)}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl max-w-sm w-full p-6 space-y-5 border border-black/10 dark:border-white/10",children:[e.jsx("h2",{className:"text-lg font-semibold flex items-center gap-2 text-red-600 dark:text-red-300",children:"Delete Round"}),e.jsxs("div",{className:"text-sm leading-relaxed text-black/70 dark:text-white/70",children:["Are you sure you want to delete",e.jsxs("span",{className:"font-medium text-black dark:text-white",children:[" ",Re.title||"this round"]}),"? This action cannot be undone."]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{disabled:Xe,onClick:async()=>{if(!(!p?.user||!Re)){qt(!0);try{await ot(p.user.uid,Re.id),se(t=>t.filter(s=>s.id!==Re.id)),Le(t=>t.filter(s=>s!==Re.id)),je.current.delete(Re.id),Ke(null),b("Round deleted.","error")}catch(t){console.error(t),b(t?.message||"Failed to delete round.","error",6e3)}finally{qt(!1)}}},className:"btn btn-orange w-full justify-center disabled:opacity-60",children:Xe?"Deleting…":"Delete Permanently"}),e.jsx("button",{disabled:Xe,onClick:()=>Ke(null),className:"btn btn-ghost w-full justify-center",children:"Cancel"})]})]})]}),De&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:()=>!Ze&&Je(null)}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl max-w-sm w-full p-6 space-y-5 border border-black/10 dark:border-white/10",children:[e.jsx("h2",{className:"text-lg font-semibold flex items-center gap-2 text-red-600 dark:text-red-300",children:"Delete Folder"}),e.jsxs("div",{className:"text-sm leading-relaxed text-black/70 dark:text-white/70",children:["Delete folder ",e.jsx("span",{className:"font-semibold text-black dark:text-white",children:De.name})," and its ",De.count," round(s)? This cannot be undone."]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{disabled:Ze,onClick:async()=>{if(p?.user){Gt(!0);try{await ss(De.name,De.roundIds),he(t=>t.filter(s=>s!==De.name)),Be(new Set),Je(null)}finally{Gt(!1)}}},className:"btn btn-orange w-full justify-center disabled:opacity-60",children:Ze?"Deleting…":"Delete Permanently"}),e.jsx("button",{disabled:Ze,onClick:()=>Je(null),className:"btn btn-ghost w-full justify-center",children:"Cancel"})]})]})]}),e.jsx(En,{open:js,onClose:()=>{Pt(!1),Et(!1)},players:X,onSubmit:({team:t,playerId:s,newName:i})=>{Oe(l=>{if(l.filter(A=>A.team===t).length>=5)return l;const n=l.map(A=>A.id===s?{...A,status:"replaced"}:A),d=n.filter(A=>A.team===t).map(A=>A.seat).filter(Boolean),k=Math.max(0,...d,4)+(d.includes(5)?0:1),M={id:xs.current++,team:t,seat:k>5?k:5,name:i,status:"active",stats:{correct:0,incorrect:0,correctInterrupt:0,incorrectInterrupt:0}};return[...n,M]}),b(`Substitution: ${i} entered for Team ${t}.`,"success")}}),zs&&e.jsxs("div",{className:"fixed inset-0 z-[70] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>wt(!1)}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl max-w-3xl w-full p-6 space-y-4 border border-black/10 dark:border-white/10 flex flex-col max-h-[85vh]",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Manage Saved Rounds"}),e.jsx("button",{className:"btn btn-ghost btn-sm",onClick:()=>wt(!1),children:"Close"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:"chip px-3 py-1",onClick:()=>Be(new Set(J.map(t=>t.id))),children:"Select All"}),e.jsx("button",{className:"chip px-3 py-1",onClick:()=>Be(new Set),children:"Clear"}),e.jsx("button",{className:"chip px-3 py-1",onClick:()=>Be(t=>new Set(J.filter(s=>!t.has(s.id)).map(s=>s.id))),children:"Invert"}),e.jsx("button",{className:"chip px-3 py-1",onClick:()=>{Le(Array.from(Te)),b("Excluded rounds updated.","success")},children:"Apply Exclusions"}),e.jsx("button",{className:"chip px-3 py-1 text-red-600 border-red-200 hover:bg-red-50 dark:text-red-300 dark:border-red-700 dark:hover:bg-red-900/30",onClick:async()=>{if(!p?.user)return;if(Te.size===0){b("No rounds selected.","error");return}if(!window.confirm(`Delete ${Te.size} selected round(s)? This cannot be undone.`))return;const t=Array.from(Te);let s=0;for(const i of t)try{await ot(p.user.uid,i),s++}catch{}se(i=>i.filter(l=>!Te.has(l.id))),Le(i=>i.filter(l=>!Te.has(l))),Be(new Set),b(`Deleted ${s} round(s).`,"error")},children:"Delete Selected"})]}),e.jsx("div",{className:"flex-1 overflow-auto rounded border border-black/10 dark:border-white/10",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-black/5 dark:bg-white/10 backdrop-blur",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-3 py-2 w-10",children:"Sel"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Title"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Folder"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Count"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Created"})]})}),e.jsx("tbody",{children:J.map(t=>{const s=t.createdAt?.seconds?new Date(t.createdAt.seconds*1e3):null;return e.jsxs("tr",{className:"odd:bg-black/0 even:bg-black/5 dark:even:bg-white/5 hover:bg-tint/10",children:[e.jsx("td",{className:"px-3 py-1.5",children:e.jsx("input",{type:"checkbox",checked:Te.has(t.id),onChange:()=>Be(i=>{const l=new Set(i);return l.has(t.id)?l.delete(t.id):l.add(t.id),l})})}),e.jsx("td",{className:"px-3 py-1.5 truncate max-w-[280px]",title:t.title,children:t.title||"Untitled"}),e.jsx("td",{className:"px-3 py-1.5",children:t.folder||""}),e.jsx("td",{className:"px-3 py-1.5",children:t.count??""}),e.jsx("td",{className:"px-3 py-1.5 whitespace-nowrap",children:s?s.toLocaleDateString():""})]},t.id)})})]})})]})]}),e.jsx("div",{className:"fixed top-4 right-4 z-[60] flex flex-col gap-3 w-[min(92vw,360px)] pointer-events-none",children:E.map(t=>e.jsxs("div",{className:"group pointer-events-auto relative overflow-hidden rounded-md px-4 py-3 pr-10 text-sm shadow-lg flex items-start gap-3 animate-toast-enter "+(t.type==="success"?"bg-emerald-600 text-white":t.type==="error"?"bg-red-600 text-white":"bg-neutral-800 text-white"),role:"status","aria-live":"polite",children:[e.jsx("div",{className:"flex-1 break-words leading-relaxed",children:t.message}),e.jsx("button",{className:"absolute top-1.5 right-1.5 rounded p-1 text-white/70 hover:text-white hover:bg-white/10 transition-colors","aria-label":"Dismiss notification",onClick:()=>O(s=>s.filter(i=>i.id!==t.id)),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"h-4 w-4",children:e.jsx("path",{fillRule:"evenodd",d:"M4.22 4.22a.75.75 0 011.06 0L10 8.94l4.72-4.72a.75.75 0 111.06 1.06L11.06 10l4.72 4.72a.75.75 0 11-1.06 1.06L10 11.06l-4.72 4.72a.75.75 0 01-1.06-1.06L8.94 10 4.22 5.28a.75.75 0 010-1.06z",clipRule:"evenodd"})})}),e.jsx("span",{className:"absolute bottom-0 left-0 h-0.5 bg-white/70 group-hover:bg-white",style:{width:"100%",transformOrigin:"left",animation:`toast-bar-${t.id} ${t.ttl}ms linear forwards`}}),e.jsx("style",{children:`@keyframes toast-disappear { to { opacity:0; transform: translateY(-4px); } }
                @keyframes toast-enter { from { opacity:0; transform: translateY(-4px) scale(.98); } to { opacity:1; transform: translateY(0) scale(1); } }
                .animate-toast-enter { animation: toast-enter 160ms cubic-bezier(.4,0,.2,1); }
              `}),e.jsx("style",{children:`@keyframes toast-bar-${t.id} { from { transform: scaleX(1); } to { transform: scaleX(0); } }`})]},t.id))})]})}export{So as default};
