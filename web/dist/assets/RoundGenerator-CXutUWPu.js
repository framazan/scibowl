import{j as e,r as x,b as X}from"./vendor-react-DpsG3A-O.js";import{e as is,r as ls,s as At,h as Rt,i as es,j as ts,k as it,l as ln,m as cs,p as Pe,L as ue,f as ss,u as cn,n as dn,a as un,o as mn,q as pn,T as fn,C as hn,R as xn,t as bn,c as gn,b as yn,v as wn,w as jn,x as vn,y as kn}from"./index-D40vYvX6.js";import{g as ds,i as Ee}from"./visualBonuses-DUgqxwx-.js";import{L as Nn,R as Sn,F as Cn,a as ns,j as An,k as St,l as Ct,h as rs,m as Rn,X as Ln,g as Bn,U as In,d as os,e as Mn,f as Tn,T as En,n as as,o as Pn,p as $n,q as Dn}from"./vendor-lucide-react-DoOgXp02.js";import{S as zn,p as Fn}from"./vendor-react-pdf-renderer-DfOTdHag.js";import{D as _n,P as Un,T as ee,V as Q}from"./vendor-react-pdf-primitives-B6ApagcG.js";import"./vendor-abs-svg-path-DCUpb6Nw.js";import"./vendor-react-dom-D1u-fJLi.js";import"./vendor-scheduler-CoSDG3-6.js";import"./vendor-firebase-B4IeM3Lq.js";import"./vendor-firebase-app-DqcDUDC6.js";import"./vendor-firebase-component-B9jxOSis.js";import"./vendor-firebase-util-CIVODmCg.js";import"./vendor-firebase-logger-CNz1B4Yj.js";import"./vendor-idb-BXWtuYvb.js";import"./vendor-firebase-app-check-Co35-rT3.js";import"./vendor-firebase-firestore-BRp-7IKb.js";import"./vendor-firebase-webchannel-wrapper-QS5lB7L3.js";import"./vendor-firebase-storage-D1N4MLec.js";import"./vendor-firebase-database-DJucM1bQ.js";import"./vendor-react-helmet-async-bvMvt1Ax.js";import"./vendor-react-fast-compare-BCtOC5yC.js";import"./vendor-invariant-DW3JcdOx.js";import"./vendor-shallowequal-Df9Q-7bk.js";import"./vendor-react-router-dom-D6uELkfw.js";import"./vendor-react-router-B_FrsTVh.js";import"./vendor-remix-run-router-9r-WWGj9.js";import"./vendor-mui-material-DksXbHt-.js";import"./vendor-mui-utils-B23qfrSe.js";import"./vendor-clsx-B-dksMZM.js";import"./vendor-mui-system-BndTH9qf.js";import"./vendor-mui-styled-engine-CPmDJbkS.js";import"./vendor-emotion-styled-5vLscvJp.js";import"./vendor-babel-runtime-WXw8LxeR.js";import"./vendor-emotion-serialize-B6qc6euy.js";import"./vendor-emotion-hash-WldOFDRm.js";import"./vendor-emotion-unitless-x5IvBceT.js";import"./vendor-emotion-memoize-3S_6p140.js";import"./vendor-emotion-use-insertion-effect-with-fallbacks-B--OEmuQ.js";import"./vendor-emotion-utils-BijCJQMc.js";import"./vendor-emotion-is-prop-valid-DOnQZHJ6.js";import"./vendor-emotion-react-DrbGOuDy.js";import"./vendor-hoist-non-react-statics-mDtaWys7.js";import"./vendor-react-is-CnyDuYXe.js";import"./vendor-emotion-cache-DvsOMRO7.js";import"./vendor-emotion-sheet-6IwnyhEX.js";import"./vendor-stylis-DDa9OTMq.js";import"./vendor-react-transition-group-Q1VPUTjR.js";import"./vendor-three-CGYwrSEf.js";import"./vendor-katex-DP_4UPSs.js";import"./vendor-queue-IZnSDwnG.js";import"./vendor-inherits-BICa84dG.js";import"./vendor-events-DQ172AOg.js";import"./vendor-react-pdf-font-ByacAZ2x.js";import"./vendor-cross-fetch-DvOI2u39.js";import"./vendor-fontkit-5mDwoQ7O.js";import"./vendor-restructure-DwIbRzqP.js";import"./vendor-swc-helpers-DIxjOVuh.js";import"./vendor-fast-deep-equal-DtIvihjZ.js";import"./vendor-unicode-properties-BbL32wKl.js";import"./vendor-base64-js-BJmSPyJr.js";import"./vendor-unicode-trie-rSh8NucD.js";import"./vendor-tiny-inflate-BmeP50H3.js";import"./vendor-dfa-DFRa2UL2.js";import"./vendor-clone-DniFCc4t.js";import"./vendor-brotli-CUuIRSoC.js";import"./vendor-tslib-kHcLnhpD.js";import"./vendor-react-pdf-render-DYs5yDRr.js";import"./vendor-react-pdf-fns-DIcDsgsD.js";import"./vendor-parse-svg-path-Bi0KIs1g.js";import"./vendor-normalize-svg-path-CFWHe3yZ.js";import"./vendor-svg-arc-to-cubic-bezier-DEq50KMd.js";import"./vendor-color-string-BKSasjlw.js";import"./vendor-color-name-Dju3oUBS.js";import"./vendor-simple-swizzle-3gX0Onlb.js";import"./vendor-is-arrayish-DyGeW-O8.js";import"./vendor-react-pdf-pdfkit-CgWEQEi-.js";import"./vendor-pako-CNe1bWpJ.js";import"./vendor-crypto-js-C9XMI5TL.js";import"./vendor-jay-peg-DnV82Tak.js";import"./vendor-react-pdf-png-js-D_OjzuBh.js";import"./vendor-react-pdf-layout-CVT9JNgr.js";import"./vendor-react-pdf-stylesheet-B2kC1IpU.js";import"./vendor-postcss-value-parser-DOXmp8r9.js";import"./vendor-hsl-to-hex-CDkcI7Vq.js";import"./vendor-hsl-to-rgb-for-reals-jL61FXS_.js";import"./vendor-media-engine-BWjc9dwl.js";import"./vendor-react-pdf-textkit-R3VqYnwu.js";import"./vendor-bidi-js-DLACMwmw.js";import"./vendor-hyphen-B2aENclZ.js";import"./vendor-yoga-layout-nAHjiEuJ.js";import"./vendor-react-pdf-image-BJ1YGwqv.js";import"./vendor-object-assign-Dm9xdUEz.js";function qn({auth:n,roundsIndex:c,setRoundsIndex:p,roundFolders:b,setRoundFolders:T,loadingUserRounds:k,refresh:L,selectedExcludeRoundIds:R,setSelectedExcludeRoundIds:E,foldersOpen:B,setFoldersOpen:z,handleExcludeRoundToggle:$,pushToast:m,setManagerSelection:S,setShowRoundsManager:A,setFolderDeleteTarget:C,setDeleteTarget:y,onViewRound:a}){return n?.user?e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold mb-2 flex items-center gap-2",children:["Exclude rounds",e.jsx("button",{className:"chip px-2 py-0.5 text-xs",title:"Clear selection",onClick:()=>E([]),children:e.jsx(Nn,{size:16})}),e.jsx("button",{className:"chip px-2 py-0.5 text-xs inline-flex items-center","aria-label":"Refresh rounds & folders",title:"Refresh",onClick:L,children:e.jsx(Sn,{size:14})}),e.jsx("button",{className:"chip px-2 py-0.5 text-xs inline-flex items-center","aria-label":"Create folder",title:"Create folder",onClick:async()=>{if(!n?.user)return;const j=window.prompt("Folder name");if(j==null)return;const q=j.trim();if(!q){m("Folder name cannot be empty.","error");return}const Y=q.toLowerCase();if(b.some(o=>o.toLowerCase()===Y)){m("Folder already exists.","error");return}try{await is(n.user.uid,q),T(o=>[...o,q].sort((r,v)=>r.localeCompare(v))),z(o=>{const r=new Set(o);return r.add(q),r}),m("Folder created.","success")}catch(o){m(o.message||"Failed to create folder.","error")}},children:e.jsx(Cn,{size:14})}),e.jsx("button",{className:"chip px-2 py-0.5 text-xs inline-flex items-center","aria-label":"Open rounds manager",title:"Manage saved rounds",onClick:()=>{S(new Set(R)),A(!0)},children:e.jsx(ns,{size:14})})]}),k?e.jsx("div",{className:"text-sm opacity-70",children:"Loading your rounds…"}):c.length===0?e.jsx("div",{className:"text-sm opacity-70",children:"No saved rounds yet."}):e.jsx("div",{className:"border rounded-lg max-h-64 overflow-y-auto overflow-x-hidden divide-y divide-black/10 dark:divide-white/10",children:(()=>{const j=[],q=b.sort((r,v)=>r.localeCompare(v)).map(r=>{const v=B.has(r),w=c.filter(l=>l.folder===r);return e.jsxs("div",{className:"select-none",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 hover:bg-black/5 dark:hover:bg-white/10 cursor-pointer",onClick:()=>z(l=>{const g=new Set(l);return g.has(r)?g.delete(r):g.add(r),g}),onDragOver:l=>{l.preventDefault(),l.dataTransfer.dropEffect="move"},onDrop:async l=>{if(l.preventDefault(),!n?.user)return;const g=l.dataTransfer.getData("text/round-ids");if(!g)return;const D=g.split(",").filter(Boolean);for(const F of D)try{await At(n.user.uid,F,r)}catch{}p(F=>F.map(h=>D.includes(h.id)?{...h,folder:r}:h)),m(`Moved ${D.length} round(s) to ${r}.`,"success")},children:[e.jsx("button",{type:"button",className:"p-0.5 rounded hover:bg-black/10 dark:hover:bg-white/10","aria-label":v?"Collapse folder":"Expand folder",children:v?e.jsx(ns,{size:15}):e.jsx(An,{size:15})}),e.jsx("input",{type:"checkbox",className:"accent-tint",ref:l=>{if(!l)return;const g=c.filter(h=>h.folder===r),D=g.length,F=g.filter(h=>R.includes(h.id)).length;l.indeterminate=F>0&&F<D},checked:(()=>{const l=c.filter(g=>g.folder===r);return l.length>0&&l.every(g=>R.includes(g.id))})(),onChange:()=>{const g=c.filter(D=>D.folder===r).map(D=>D.id);E(D=>{const F=new Set(D);return g.every(J=>F.has(J))?g.forEach(J=>F.delete(J)):g.forEach(J=>F.add(J)),Array.from(F)})},"aria-label":`Select all rounds in folder ${r}`,title:"Select all in folder"}),e.jsxs("span",{className:"font-medium flex-1 truncate",title:r,children:[r," ",e.jsxs("span",{className:"opacity-60 text-xs",children:["(",w.length,")"]})]}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-[11px] inline-flex items-center","aria-label":"Rename folder",title:"Rename folder",onClick:l=>{l.stopPropagation();const g=window.prompt("Rename folder",r);if(g==null)return;const D=g.trim();if(!(!D||D===r)){if(b.some(F=>F.toLowerCase()===D.toLowerCase())){m("Folder name already exists.","error");return}(async()=>{try{await ls(n.user.uid,r,D),T(F=>F.map(h=>h===r?D:h)),p(F=>F.map(h=>h.folder===r?{...h,folder:D}:h)),z(F=>{const h=new Set(F);return h.has(r)&&(h.delete(r),h.add(D)),h}),m("Folder renamed.","success")}catch(F){m(F.message||"Failed to rename folder.","error")}})()}},children:e.jsx(St,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-[11px] inline-flex items-center text-red-600 border-red-200 hover:bg-red-50 dark:text-red-300 dark:border-red-700 dark:hover:bg-red-900/30","aria-label":"Delete folder and its rounds",title:"Delete folder",onClick:l=>{l.stopPropagation();const g=c.filter(D=>D.folder===r);C({name:r,count:g.length,roundIds:g.map(D=>D.id)})},children:e.jsx(Ct,{className:"h-3.5 w-3.5"})})]}),v&&e.jsx("ul",{className:"divide-y divide-black/5 dark:divide-white/10",role:"group",children:w.map(l=>{j.push(l.id);const g=l.createdAt?.seconds?new Date(l.createdAt.seconds*1e3):null,D=g?`${g.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})} on ${g.toLocaleDateString()}`:l.title||"Untitled",F=R.includes(l.id);return e.jsx("li",{draggable:!0,onDragStart:h=>{h.dataTransfer.effectAllowed="move";const J=R.includes(l.id)?R:[l.id];h.dataTransfer.setData("text/round-ids",J.join(","))},children:e.jsxs("div",{className:`group flex items-center justify-between gap-2 pl-10 pr-3 py-2 ${F?"bg-tint/10 ring-1 ring-tint":""}`,children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer flex-1 min-w-0",title:l.title||`Round ${D}`,children:[e.jsx("input",{type:"checkbox",checked:F,onChange:h=>$(h,l.id)}),e.jsx("span",{className:"block whitespace-normal overflow-visible group-hover:truncate group-focus-within:truncate",children:l.title||`Round ${D}`})]}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100 inline-flex items-center","aria-label":"View round",title:"View round",onClick:h=>{h.stopPropagation(),a?.(l)},children:e.jsx(rs,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100 inline-flex items-center","aria-label":"Rename round",title:"Rename round",onClick:async h=>{h.stopPropagation();const J=l.title||`Round ${D}`,te=window.prompt("Rename round",J);if(te==null)return;const re=te.trim();if(!re||re===J)return;if(c.some(me=>me.id!==l.id&&(me.title||"").trim().toLowerCase()===re.toLowerCase())){m("Another round already has that title.","error");return}try{await Rt(n.user.uid,l.id,re),p(me=>me.map(xe=>xe.id===l.id?{...xe,title:re}:xe))}catch(me){window.alert?.(me?.message||"Failed to rename round.")}},children:e.jsx(St,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 text-red-600 border-red-200 hover:bg-red-50 dark:text-red-300 dark:border-red-700 dark:hover:bg-red-900/30",title:"Delete round",onClick:h=>{h.stopPropagation(),y(l)},children:e.jsx(Ct,{className:"h-3.5 w-3.5"})})]})},l.id)})})]},r)}),Y=c.filter(r=>!r.folder),o=e.jsxs("div",{className:"select-none",onDragOver:r=>{r.preventDefault(),r.dataTransfer.dropEffect="move"},onDrop:async r=>{if(r.preventDefault(),!n?.user)return;const v=r.dataTransfer.getData("text/round-ids");if(!v)return;const w=v.split(",").filter(Boolean);for(const l of w)try{await At(n.user.uid,l,"")}catch{}p(l=>l.map(g=>w.includes(g.id)?(()=>{const{folder:D,...F}=g;return F})():g)),m(`Cleared folder for ${w.length} round(s).`,"success")},children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-black/5 dark:bg-white/10 font-medium",children:["Unfiled ",e.jsxs("span",{className:"opacity-60 text-xs",children:["(",Y.length,")"]})]}),e.jsx("ul",{className:"divide-y divide-black/5 dark:divide-white/10",role:"group",children:Y.map(r=>{j.push(r.id);const v=r.createdAt?.seconds?new Date(r.createdAt.seconds*1e3):null,w=v?`${v.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})} on ${v.toLocaleDateString()}`:r.title||"Untitled",l=R.includes(r.id);return e.jsx("li",{draggable:!0,onDragStart:g=>{g.dataTransfer.effectAllowed="move";const D=R.includes(r.id)?R:[r.id];g.dataTransfer.setData("text/round-ids",D.join(","))},children:e.jsxs("div",{className:`group flex items-center justify-between gap-2 pl-6 pr-3 py-2 ${l?"bg-tint/10 ring-1 ring-tint":""}`,children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer flex-1 min-w-0",title:r.title||`Round ${w}`,children:[e.jsx("input",{type:"checkbox",checked:l,onChange:g=>$(g,r.id)}),e.jsx("span",{className:"block whitespace-normal overflow-visible group-hover:truncate group-focus-within:truncate",children:r.title||`Round ${w}`})]}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100 inline-flex items-center","aria-label":"View round",title:"View round",onClick:g=>{g.stopPropagation(),a?.(r)},children:e.jsx(rs,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100 inline-flex items-center","aria-label":"Rename round",title:"Rename round",onClick:async g=>{g.stopPropagation();const D=r.title||`Round ${w}`,F=window.prompt("Rename round",D);if(F==null)return;const h=F.trim();if(!h||h===D)return;if(c.some(te=>te.id!==r.id&&(te.title||"").trim().toLowerCase()===h.toLowerCase())){m("Another round already has that title.","error");return}try{await Rt(n.user.uid,r.id,h),p(te=>te.map(re=>re.id===r.id?{...re,title:h}:re))}catch(te){window.alert?.(te?.message||"Failed to rename round.")}},children:e.jsx(St,{size:13})}),e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs shrink-0 text-red-600 border-red-200 hover:bg-red-50 dark:text-red-300 dark:border-red-700 dark:hover:bg-red-900/30",title:"Delete round",onClick:g=>{g.stopPropagation(),y(r)},children:e.jsx(Ct,{className:"h-3.5 w-3.5"})})]})},r.id)})})]},"__unfiled__");return e.jsxs(e.Fragment,{children:[q,o]})})()})]}):null}function On({auth:n,pushToast:c}){const[p,b]=x.useState([]),[T,k]=x.useState(!1),[L,R]=x.useState([]),[E,B]=x.useState(()=>new Set),[z,$]=x.useState([]),m=x.useRef(new Map);x.useEffect(()=>{let o=!1;async function r(){if(!n?.user){b([]),m.current.clear(),R([]);return}k(!0);try{const v=await es(n.user.uid).catch(()=>[]);o||b(v);const w=await ts(n.user.uid).catch(()=>[]);o||R(w)}finally{o||k(!1)}}return r(),()=>{o=!0}},[n?.user?.uid]);async function S(o,r){o?.nativeEvent?.shiftKey||o?.shiftKey;const v=z.includes(r),w=!v;if($(l=>{const g=new Set(l);return v?g.delete(r):g.add(r),Array.from(g)}),w&&n?.user&&!m.current.has(r))try{const l=await cs(n.user.uid,r);l&&m.current.set(r,l)}catch{}}async function A(){if(n?.user){k(!0);try{b(await es(n.user.uid,{force:!0})),R(await ts(n.user.uid,{force:!0}))}finally{k(!1)}}}async function C(o){if(!n?.user)return;if(!o?.trim()){c?.("Folder name cannot be empty.","error");return}const r=o.toLowerCase();if(L.some(v=>v.toLowerCase()===r)){c?.("Folder already exists.","error");return}await is(n.user.uid,o),R(v=>[...v,o].sort((w,l)=>w.localeCompare(l))),B(v=>{const w=new Set(v);return w.add(o),w}),c?.("Folder created.","success")}async function y(o,r){if(!n?.user)return;const v=r.trim();if(!(!v||v===o)){if(L.some(w=>w.toLowerCase()===v.toLowerCase())){c?.("Folder name already exists.","error");return}await ls(n.user.uid,o,v),R(w=>w.map(l=>l===o?v:l)),b(w=>w.map(l=>l.folder===o?{...l,folder:v}:l)),B(w=>{const l=new Set(w);return l.has(o)&&(l.delete(o),l.add(v)),l}),c?.("Folder renamed.","success")}}async function a(o,r){if(n?.user){for(const v of o)try{await At(n.user.uid,v,r)}catch{}b(v=>v.map(w=>o.includes(w.id)?{...w,folder:r}:w)),c?.(r?`Moved ${o.length} round(s) to ${r}.`:`Cleared folder for ${o.length} round(s).`,"success")}}async function j(o,r){if(!n?.user)return;if(p.some(l=>l.id!==o.id&&(l.title||"").trim().toLowerCase()===r.toLowerCase())){c?.("Another round already has that title.","error");return}await Rt(n.user.uid,o.id,r),b(l=>l.map(g=>g.id===o.id?{...g,title:r}:g));const w=m.current.get(o.id);w&&m.current.set(o.id,{...w,title:r})}async function q(o){n?.user&&(await it(n.user.uid,o),b(r=>r.filter(v=>v.id!==o)),$(r=>r.filter(v=>v!==o)),m.current.delete(o),c?.("Round deleted.","error"))}async function Y(o,r=[]){if(n?.user){for(const v of r)try{await it(n.user.uid,v)}catch{}try{await ln(n.user.uid,o)}catch{}b(v=>v.filter(w=>!r.includes(w.id))),$(v=>v.filter(w=>!r.includes(w))),R(v=>v.filter(w=>w!==o)),c?.("Folder and rounds deleted.","error")}}return{roundsIndex:p,setRoundsIndex:b,loadingUserRounds:T,roundFolders:L,setRoundFolders:R,foldersOpen:E,setFoldersOpen:B,selectedExcludeRoundIds:z,setSelectedExcludeRoundIds:$,excludeDetailCache:m,handleExcludeRoundToggle:S,refresh:A,createFolder:C,renameFolder:y,moveRoundsToFolder:a,renameRound:j,deleteRoundPermanently:q,deleteFolderAndRounds:Y}}const U=zn.create({page:{padding:16,fontSize:8,fontFamily:"Times-Roman"},title:{textAlign:"center",fontSize:11,fontWeight:"bold",marginBottom:4},legendBlock:{marginBottom:4},tiny:{fontSize:6.5},footer:{marginTop:4,textAlign:"center",fontSize:6.5},tablesWrap:{flexDirection:"row"},teamACol:{flex:1.1,marginRight:4},teamBCol:{flex:.9,marginLeft:4},headerRow:{flexDirection:"row",backgroundColor:"#eee"},bodyRow:{flexDirection:"row"},cell:{borderWidth:.5,borderColor:"#000",paddingVertical:1.5,paddingHorizontal:2,justifyContent:"center",textAlign:"center",minHeight:12},headCellText:{fontWeight:"bold",fontSize:6.5},qnCell:{fontSize:6.5,fontWeight:"bold"},subjCell:{fontSize:6.5},attempt:{fontSize:6.5,fontWeight:"bold"},nameHead:{fontSize:6,fontWeight:"bold"},spacer:{width:4}});function Gn(n){return[4,7,6,...Array(n).fill(9),7,6,7]}function Wn(n){return[...Array(n).fill(9),7,6,7]}function Hn({playerLabels:n=[],cols:c}){const p=["Q","Subj","Type",...n,"Bonus","Pen","Score"];return e.jsx(Q,{style:U.headerRow,children:p.map((b,T)=>{const k=c[T];return e.jsx(Q,{style:[U.cell,{flexGrow:k,flexBasis:k}],children:e.jsx(ee,{style:U.headCellText,children:b})},T)})})}function Vn({playerLabels:n=[],cols:c}){const p=[...n,"Bonus","Pen","Score"];return e.jsx(Q,{style:U.headerRow,children:p.map((b,T)=>{const k=c[T];return e.jsx(Q,{style:[U.cell,{flexGrow:k,flexBasis:k}],children:e.jsx(ee,{style:U.headCellText,children:b})},T)})})}function Qn({r:n,seatPlayers:c,outRows:p,cols:b}){if(!n||n.pad)return e.jsx(Q,{style:U.bodyRow,children:b.map((S,A)=>e.jsx(Q,{style:[U.cell,{flexGrow:S,flexBasis:S}],children:A===0&&n?.index?e.jsx(ee,{style:U.qnCell,children:n.index}):null},A))});const T=(n.attempts||[]).filter(S=>S&&S.playerId!=null);function k(S){if(!S)return"";const A=T.filter(y=>y.playerId===S.id);if(!A.length)return"";const C=A[A.length-1];return C.result==="correct"?C.interrupt?"CI":"C":C.result==="incorrect"?C.interrupt?"II":"I":""}const L=n.bonusA,R=n.penaltyA,E=n.cumA;function B(S,A){let C=k(S);return!C&&S&&p[S.id]===n.index&&(C="out"),e.jsx(Q,{style:[U.cell,{flexGrow:A,flexBasis:A}],children:e.jsx(ee,{style:U.attempt,children:C})},S?S.id:Math.random())}const z=b.slice(0,3),$=b.slice(3,3+c.length),m=b.slice(3+c.length);return e.jsxs(Q,{style:U.bodyRow,children:[e.jsx(Q,{style:[U.cell,{flexGrow:z[0],flexBasis:z[0]}],children:e.jsx(ee,{style:U.qnCell,children:n.index})}),e.jsx(Q,{style:[U.cell,{flexGrow:z[1],flexBasis:z[1]}],children:e.jsx(ee,{style:U.subjCell,children:n.subject})}),e.jsx(Q,{style:[U.cell,{flexGrow:z[2],flexBasis:z[2]}],children:e.jsx(ee,{style:U.subjCell,children:n.type})}),c.map((S,A)=>B(S,$[A])),e.jsx(Q,{style:[U.cell,{flexGrow:m[0],flexBasis:m[0]}],children:e.jsx(ee,{children:L?String(L):""})}),e.jsx(Q,{style:[U.cell,{flexGrow:m[1],flexBasis:m[1]}],children:e.jsx(ee,{children:R?String(R):""})}),e.jsx(Q,{style:[U.cell,{flexGrow:m[2],flexBasis:m[2]}],children:e.jsx(ee,{children:E!=null?String(E):""})})]})}function Xn({r:n,seatPlayers:c,outRows:p,cols:b}){if(!n||n.pad)return e.jsx(Q,{style:U.bodyRow,children:b.map((m,S)=>e.jsx(Q,{style:[U.cell,{flexGrow:m,flexBasis:m}]},S))});const T=(n.attempts||[]).filter(m=>m&&m.playerId!=null);function k(m){if(!m)return"";const S=T.filter(C=>C.playerId===m.id);if(!S.length)return"";const A=S[S.length-1];return A.result==="correct"?A.interrupt?"CI":"C":A.result==="incorrect"?A.interrupt?"II":"I":""}const L=n.bonusB,R=n.penaltyB,E=n.cumB;function B(m,S){let A=k(m);return!A&&m&&p[m.id]===n.index&&(A="out"),e.jsx(Q,{style:[U.cell,{flexGrow:S,flexBasis:S}],children:e.jsx(ee,{style:U.attempt,children:A})},m?m.id:Math.random())}const z=b.slice(0,c.length),$=b.slice(c.length);return e.jsxs(Q,{style:U.bodyRow,children:[c.map((m,S)=>B(m,z[S])),e.jsx(Q,{style:[U.cell,{flexGrow:$[0],flexBasis:$[0]}],children:e.jsx(ee,{children:L?String(L):""})}),e.jsx(Q,{style:[U.cell,{flexGrow:$[1],flexBasis:$[1]}],children:e.jsx(ee,{children:R?String(R):""})}),e.jsx(Q,{style:[U.cell,{flexGrow:$[2],flexBasis:$[2]}],children:e.jsx(ee,{children:E!=null?String(E):""})})]})}function Yn({sheetRows:n=[],players:c=[],metadata:p={}}){const b=c.filter(o=>o.team==="A").sort((o,r)=>(o.seat||0)-(r.seat||0)),T=c.filter(o=>o.team==="B").sort((o,r)=>(o.seat||0)-(r.seat||0)),k=b.filter(o=>(o.seat||0)>=1&&(o.seat||0)<=4).sort((o,r)=>o.seat-r.seat),L=T.filter(o=>(o.seat||0)>=1&&(o.seat||0)<=4).sort((o,r)=>o.seat-r.seat),R=b.find(o=>(o.seat||0)===5&&o.status==="active"),E=T.find(o=>(o.seat||0)===5&&o.status==="active"),B=R?[...k,R]:[...k],z=E?[...L,E]:[...L],$=(o,r)=>o&&o.name?Kn(o.name,9):r,m=B.map((o,r)=>$(o,["Captain","P1","P2","P3","Sub"][r]||"P"+(r+1))),S=z.map((o,r)=>$(o,["Captain","P1","P2","P3","Sub"][r]||"P"+(r+1))),A=Gn(B.length),C=Wn(z.length);function y(o,r){if(!o.length)return{};const v={};for(const l of n){if(!l||l.pad)continue;const g=l.index;for(const D of l.attempts||[])!D||D.team!==r||o.includes(D.playerId)&&(v[D.playerId]=g)}const w={};for(const l of o){const g=v[l];g&&g<25&&(w[l]=g+1)}return w}const a=b.filter(o=>o.status==="replaced").map(o=>o.id),j=T.filter(o=>o.status==="replaced").map(o=>o.id),q=y(a,"A"),Y=y(j,"B");return e.jsx(_n,{children:e.jsxs(Un,{size:"LETTER",style:U.page,orientation:"landscape",children:[e.jsx(ee,{style:U.title,children:"Coaches Scoresheet"}),e.jsxs(Q,{style:U.legendBlock,children:[e.jsx(ee,{style:U.tiny,children:"Subjects: E ESS | C Chemistry | B Bio | M Math | P Physics | EN Energy"}),e.jsx(ee,{style:U.tiny,children:"Types: MC Multiple Choice | SA Short Answer | Markers: C / CI / I / II | 'out' = player substituted"})]}),e.jsxs(Q,{style:U.tablesWrap,children:[e.jsxs(Q,{style:U.teamACol,children:[e.jsx(Hn,{playerLabels:m,cols:A}),n.slice(0,25).map(o=>e.jsx(Qn,{r:o,seatPlayers:B,outRows:q,cols:A},"A-"+o.index))]}),e.jsxs(Q,{style:U.teamBCol,children:[e.jsx(Vn,{playerLabels:S,cols:C}),n.slice(0,25).map(o=>e.jsx(Xn,{r:o,seatPlayers:z,outRows:Y,cols:C},"B-"+o.index))]})]}),e.jsxs(ee,{style:U.footer,children:["Generated ",p.generatedAt||""," | atombowl"]})]})})}function Kn(n,c){return n?n.length<=c?n:n.slice(0,c-1)+"…":""}function Jn({pair:n,index:c,scorekeeping:p=!1,currentIndex:b=0,tossupResults:T=[],showBonusContent:k,questionRef:L}){const R=n.tossup?Pe(n.tossup):[],E=n.bonus?Pe(n.bonus):[],B=!p||c===b,[z,$]=X.useState(null),[m,S]=X.useState(!1);return X.useEffect(()=>{let A=!1;async function C(){$(null);const y=n?.bonus;if(!y||!(y.is_visual_bonus===!0||String(y.visual||"").toLowerCase()==="true"))return;const j=await ds({tournament:y.tournament,round:y.round,question_number:y.question_number}).catch(()=>null);A||$(j)}return k&&C(),()=>{A=!0}},[n?.bonus?.tournament,n?.bonus?.round,n?.bonus?.question_number,k]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:L,className:`glass p-6 space-y-4 min-w-0 relative ${p&&!B?"opacity-50 blur-sm select-none pointer-events-none":""}`,children:[p&&c===b&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-0 rounded-lg pointer-events-none border-2 border-green-500 shadow-[0_0_0_3px_rgba(34,197,94,0.35)]",style:{boxShadow:"0 0 0 3px rgba(34,197,94,0.35), 0 4px 12px -2px rgba(16,185,129,0.5)"}}),e.jsx("div",{className:"absolute -top-3 left-4 px-3 py-1 bg-green-600 text-white rounded-full text-[11px] font-semibold shadow-lg",children:"Active"})]}),n.tossup&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-sm text-black/60 dark:text-white/80 mb-2",children:[e.jsx("span",{className:"font-semibold",children:String(n.tossup.tournament).toUpperCase()})," • ","Round ",n.tossup.round??"—"," • ",n.tossup.category,n.tossup.question_number!=null&&e.jsxs(e.Fragment,{children:[" • ","Q",n.tossup.question_number]}),e.jsx("span",{className:"ml-2 inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold tracking-wide border "+(R.length>0?"bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-900/20 dark:text-blue-200 dark:border-blue-700":"bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/20 dark:text-purple-200 dark:border-purple-700"),children:R.length>0?"MULTIPLE CHOICE":"SHORT ANSWER"})]}),e.jsxs("div",{className:"font-medium mb-2",children:["Toss-up ",c+1]}),e.jsx("div",{className:"mb-3 whitespace-pre-line",children:e.jsx(ue,{children:n.tossup.question})}),R.length>0&&e.jsx("div",{className:"mb-3",children:R.map(([A,C])=>e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`gen-tossup-${c}`,className:"accent-tint",disabled:!0}),e.jsxs("span",{children:[A.toUpperCase(),") ",e.jsx(ue,{children:C})]})]},A))}),e.jsxs("div",{className:"text-sm text-black/70 dark:text-white/80",children:[e.jsx("span",{className:"uppercase text-black/60 dark:text-white/60",children:"Answer:"})," ",e.jsx("span",{className:"text-black dark:text-white",children:e.jsx(ue,{children:n.tossup.answer})})]})]}),n.bonus&&k&&e.jsxs("div",{className:n.tossup?"mt-6 pt-4 border-t":"mt-2",children:[e.jsxs("div",{className:"text-sm text-black/60 dark:text-white/80 mb-2",children:[e.jsx("span",{className:"font-semibold",children:String(n.tossup?n.tossup.tournament:n.bonus.tournament).toUpperCase()})," • ","Round ",n.bonus.round??"—"," • ",n.bonus.category,n.bonus.question_number!=null&&e.jsxs(e.Fragment,{children:[" • ","Q",n.bonus.question_number]}),e.jsx("span",{className:"ml-2 inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold tracking-wide border "+(E.length>0?"bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-900/20 dark:text-blue-200 dark:border-blue-700":"bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/20 dark:text-purple-200 dark:border-purple-700"),children:E.length>0?"MULTIPLE CHOICE":"SHORT ANSWER"})]}),e.jsxs("div",{className:"font-semibold mb-2",children:["Bonus ",c+1]}),z&&e.jsxs("div",{className:"mb-3",children:[e.jsx("img",{src:z,alt:`Visual bonus${n?.bonus?.tournament?` • ${n.bonus.tournament}`:""}${n?.bonus?.round?` • Round ${n.bonus.round}`:""}${n?.bonus?.question_number!=null?` • Q${n.bonus.question_number}`:""}`,className:"max-h-64 rounded-md border border-black/10 dark:border-white/10 object-contain cursor-zoom-in hover:opacity-95 transition",onClick:()=>S(!0)}),e.jsx("div",{className:"text-xs text-black/60 dark:text-white/60 mt-1",children:"Click image to view full screen"})]}),e.jsx("div",{className:"mb-2 whitespace-pre-line",children:e.jsx(ue,{children:n.bonus.question})}),E.length>0&&e.jsx("div",{className:"mb-3",children:E.map(([A,C])=>e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"radio",name:`gen-bonus-${c}`,className:"accent-tint",disabled:!0}),e.jsxs("span",{children:[A.toUpperCase(),") ",e.jsx(ue,{children:C})]})]},A))}),e.jsxs("div",{className:"text-sm text-black/70 dark:text-white/80",children:[e.jsx("span",{className:"uppercase text-black/60 dark:text-white/60",children:"Answer:"})," ",e.jsx("span",{className:"text-black dark:text-white",children:e.jsx(ue,{children:n.bonus.answer})})]})]})]}),m&&z&&e.jsxs("div",{className:"fixed inset-0 z-[90] flex items-center justify-center",role:"dialog","aria-modal":"true","aria-label":"Visual bonus image",children:[e.jsx("div",{className:"absolute inset-0 bg-black/80",onClick:()=>S(!1)}),e.jsxs("div",{className:"relative max-w-[96vw] max-h-[96vh] p-2",children:[e.jsx("img",{src:z,alt:"Visual bonus full screen",className:"max-w-[96vw] max-h-[92vh] object-contain rounded shadow-2xl"}),e.jsx("button",{type:"button",className:"absolute -top-3 -right-3 bg-white text-black rounded-full shadow p-2 hover:bg-white/90 focus:outline-none","aria-label":"Close full screen image",onClick:()=>S(!1),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"h-4 w-4",children:e.jsx("path",{fillRule:"evenodd",d:"M4.22 4.22a.75.75 0 011.06 0L10 8.94l4.72-4.72a.75.75 0 111.06 1.06L11.06 10l4.72 4.72a.75.75 0 11-1.06 1.06L10 11.06l-4.72 4.72a.75.75 0 01-1.06-1.06L8.94 10 4.22 5.28a.75.75 0 010-1.06z",clipRule:"evenodd"})})})]}),e.jsx(Zn,{onClose:()=>S(!1)})]})]})}function Zn({onClose:n}){return X.useEffect(()=>{const c=p=>{p.key==="Escape"&&n?.()};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[n]),null}function er({displayPairs:n,QUESTIONS_PER_PAGE:c=2,pdfRef:p}){const[b,T]=X.useState({});return X.useEffect(()=>{let k=!1;return(async()=>{const L={};for(let R=0;R<n.length;R++){const E=n[R]?.bonus;if(!(!E||!(E.is_visual_bonus===!0||String(E.visual||"").toLowerCase()==="true")))try{const z=await ds({tournament:E.tournament,round:E.round,question_number:E.question_number});z&&(L[R]=z)}catch{}}k||T(L)})(),()=>{k=!0}},[n]),e.jsx("div",{"aria-hidden":"true",style:{position:"fixed",left:"-10000px",top:0,width:816,pointerEvents:"none",opacity:0,visibility:"visible"},children:e.jsxs("div",{ref:p,className:"pdf-root",children:[e.jsx("style",{children:`
          .pdf-root, .pdf-root * { box-sizing: border-box; }
          .html2pdf__page-break + .pdf-header { margin-top: 0 !important; }
          @page { margin: 12mm; }
          .pdf-root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, 'Apple Color Emoji', 'Segoe UI Emoji'; color: #000; margin: 0; padding: 0; }
          .pdf-page { width: 720px; margin: 0 auto; padding: 2mm 4px 0 4px; }
          .pdf-page { page-break-after: always; }
          .pdf-page:last-child { page-break-after: auto; }
          .pdf-header { text-align: center; font-size: 16px; font-weight: bold; margin-bottom: 2mm; padding: 0 2px; }
          .pdf-q { page-break-inside: avoid; break-inside: avoid; margin-bottom: 4mm; }
          .pdf-hr { border: none; border-top: 1px solid #888; margin: 8px 0; }
          .pdf-meta { font-size: 11px; color: #333; margin-bottom: 2mm; }
          .pdf-title { font-weight: 600; margin-bottom: 2mm; }
          .pdf-body { white-space: pre-wrap; line-height: 1.4; word-break: break-word; overflow-wrap: anywhere; }
          .pdf-choices { margin: 2mm 0; break-inside: avoid; }
          .pdf-choice { display: flex; align-items: flex-start; gap: 4px; line-height: 1.35; }
          .pdf-choice-key { font-weight: 600; width: 16px; flex: 0 0 auto; }
          .pdf-choice-val { flex: 1; }
          .pdf-ans { font-size: 12px; margin-top: 2mm; }
          .pdf-footer { text-align: center; font-size: 12px; color: #888; margin-top: 2mm; }
          .katex-display { margin: 0; }
        `}),(()=>{const k=[];for(let E=0;E<n.length;E+=c){const B=n.slice(E,E+c);B.length>0&&k.push(B)}const L=new Date().toLocaleDateString(),R="atombowl";return k.map((E,B)=>{const z=B*c,$=B+1;return e.jsxs("div",{className:"pdf-page",children:[e.jsxs("div",{className:"pdf-header",children:[R," — ",L]}),E.map((m,S)=>{const A=z+S,C=m.tossup?Pe(m.tossup):[],y=m.bonus?Pe(m.bonus):[];return e.jsxs(X.Fragment,{children:[e.jsxs("div",{className:"pdf-q",children:[m.tossup&&e.jsxs("div",{children:[e.jsxs("div",{className:"pdf-meta",children:[m.tossup.tournament," • Round ",m.tossup.round??"—"," • ",m.tossup.category,m.tossup.question_number!=null?` • Q${m.tossup.question_number}`:"",e.jsx("span",{style:C.length>0?at("mc"):at("sa"),children:C.length>0?"MULTIPLE CHOICE":"SHORT ANSWER"})]}),e.jsxs("div",{className:"pdf-title",children:["Toss-up ",A+1]}),e.jsx("div",{className:"pdf-body",children:e.jsx(ue,{children:m.tossup.question})}),C.length>0&&e.jsx("div",{className:"pdf-choices",children:C.map(([a,j])=>e.jsxs("div",{className:"pdf-choice",children:[e.jsxs("span",{className:"pdf-choice-key",children:[a.toUpperCase(),")"]}),e.jsx("span",{className:"pdf-choice-val",children:e.jsx(ue,{children:j})})]},a))}),e.jsxs("div",{className:"pdf-ans",children:[e.jsx("span",{style:{opacity:.7},children:"Answer:"})," ",e.jsx(ue,{children:m.tossup.answer})]})]}),m.bonus&&e.jsxs("div",{style:{marginTop:m.tossup?"6mm":0,paddingTop:m.tossup?"2mm":0,borderTop:m.tossup?"1px solid #ddd":"none"},children:[e.jsxs("div",{className:"pdf-meta",children:[m.tossup?m.tossup.tournament:m.bonus.tournament," • Round ",m.bonus.round??"—"," • ",m.bonus.category,m.bonus.question_number!=null?` • Q${m.bonus.question_number}`:"",e.jsx("span",{style:y.length>0?at("mc"):at("sa"),children:y.length>0?"MULTIPLE CHOICE":"SHORT ANSWER"})]}),e.jsxs("div",{className:"pdf-title",children:["Bonus ",A+1]}),b[A]&&e.jsx("div",{className:"pdf-body",style:{marginBottom:"2mm"},children:e.jsx("img",{src:b[A],alt:"Visual bonus",style:{maxHeight:220,width:"100%",objectFit:"contain",border:"1px solid #e5e7eb",borderRadius:6}})}),e.jsx("div",{className:"pdf-body",children:e.jsx(ue,{children:m.bonus.question})}),y.length>0&&e.jsx("div",{className:"pdf-choices",children:y.map(([a,j])=>e.jsxs("div",{className:"pdf-choice",children:[e.jsxs("span",{className:"pdf-choice-key",children:[a.toUpperCase(),")"]}),e.jsx("span",{className:"pdf-choice-val",children:e.jsx(ue,{children:j})})]},a))}),e.jsxs("div",{className:"pdf-ans",children:[e.jsx("span",{style:{opacity:.7},children:"Answer:"})," ",e.jsx(ue,{children:m.bonus.answer})]})]})]}),S<E.length-1&&e.jsx("hr",{className:"pdf-hr"})]},`pdf-${A}`)}),e.jsxs("div",{className:"pdf-footer",children:["Page ",$," of ",k.length]})]},`pdf-group-${B}`)})})()]})})}function at(n){return n==="mc"?{marginLeft:6,border:"1px solid #bfdbfe",background:"#eff6ff",color:"#1d4ed8",borderRadius:9999,padding:"1px 6px",fontSize:10,fontWeight:600}:{marginLeft:6,border:"1px solid #e9d5ff",background:"#faf5ff",color:"#6b21a8",borderRadius:9999,padding:"1px 6px",fontSize:10,fontWeight:600}}function tr({searchInput:n,setSearchInput:c,committedSearch:p,setCommittedSearch:b,hasGenerated:T=!1}){return e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold mb-2 flex items-center gap-2",children:["Search",p&&e.jsx("button",{type:"button",className:"chip px-2 py-0.5 text-xs",onClick:()=>{c(""),b("")},"aria-label":"Clear search",children:"Clear"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Rn,{className:"h-4 w-4 absolute left-2 top-1/2 -translate-y-1/2 text-black/50 dark:text-white/50 pointer-events-none"}),e.jsx("input",{type:"text",value:n,onChange:k=>c(k.target.value),onKeyDown:k=>{k.key==="Enter"&&b(n)},placeholder:"Find text in generated round...",className:"w-full pl-8 pr-3 py-1.5 rounded-lg border border-black/10 bg-white dark:bg-darkcard text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Search questions",disabled:!T})]}),e.jsx("button",{type:"button",className:"btn btn-fancy whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed",disabled:!T||!n.trim()||n.trim()===p.trim(),onClick:()=>b(n),children:"Search"})]}),p.trim()&&e.jsxs("div",{className:"text-xs mt-1 opacity-70",children:['Showing all matches containing "',p,'" (ignores other filters except selected tournaments for loading).']})]})}function sr({headerOffset:n,close:c,currentIndex:p,displayPairs:b,awaitingPlayer:T,interruptArmed:k,setAwaitingPlayer:L,setInterruptArmed:R,typedAnswerActive:E,setTypedAnswerActive:B,typedAnswerText:z,setTypedAnswerText:$,typedAnswerPlayerId:m,typedAnswerLoading:S,typedAnswerReason:A,checkTypedAnswer:C,isTossupFinal:y,recordNoAnswer:a,throwOutAndReplace:j,tossupResults:q,bonusResults:Y,saveFixedBonus:o,players:r,handleSeatClick:v,allowedTeams:w,totalPoints:l,teamPoints:g,saveBonusPoints:D,subMode:F,setSubMode:h,resetScorekeeping:J,exportCoachesScoresheetPdf:te,coachesSheetLoading:re,tryoutsMode:$e,setTryoutsMode:me,questionType:xe}){return e.jsxs("div",{className:"fixed right-0 z-50 w-[400px] bg-white dark:bg-darkcard border-l border-black/10 dark:border-white/10 shadow-xl flex flex-col",style:{top:n,height:`calc(100vh - ${n}px)`},children:[e.jsxs("div",{className:"px-4 py-3 border-b border-black/10 dark:border-white/10 flex items-center justify-between",children:[e.jsx("h2",{className:"font-semibold text-sm",children:"Scorekeeper"}),e.jsx("button",{className:"text-xs chip",onClick:c,children:"Close"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-4 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{children:["Q ",Math.min(p+1,b.length)," / ",b.length]}),e.jsx("div",{className:"text-[10px] mt-0.5 opacity-70",children:w.length===0?"No buzz":"Buzz: "+w.join("/")})]}),e.jsxs("div",{className:"font-semibold text-xs leading-tight flex flex-col items-end",children:[e.jsxs("span",{children:["Total ",l]}),e.jsxs("span",{className:"text-green-600 dark:text-green-400",children:["A ",g.A]}),e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:["B ",g.B]})]})]}),p>=b.length&&e.jsx("div",{className:"p-2 rounded bg-emerald-600 text-white text-center text-xs",children:"Round complete"}),p<b.length&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2 text-[11px] font-medium",children:[e.jsx("input",{type:"checkbox",className:"scale-110",checked:!!$e,onChange:V=>me(V.target.checked),disabled:xe!=="tossup",title:xe==="tossup"?"Tryouts mode: an incorrect buzz only locks that player; others may continue buzzing.":"Switch question type to Toss-ups to enable Tryouts mode."}),"Tryouts"]}),xe!=="tossup"&&e.jsx("span",{className:"text-[10px] opacity-60",children:"Toss-ups only"})]}),e.jsxs("div",{className:"grid grid-cols-6 gap-2",children:[e.jsxs("button",{className:`col-span-2 chip flex items-center justify-center gap-1 text-xs disabled:opacity-40 disabled:cursor-not-allowed disabled:brightness-75 ${T?.type==="incorrect"?"ring-2 ring-red-500":""}`,onClick:()=>L({type:"incorrect",interrupt:k}),disabled:y(p),title:"Mark incorrect then click player seat (then select player)",children:[e.jsx(Ln,{color:"#ff2600",className:"h-4 w-4"})," Incorrect"]}),e.jsxs("button",{className:`col-span-2 chip flex items-center justify-center gap-1 text-xs disabled:opacity-40 disabled:cursor-not-allowed disabled:brightness-75 ${T?.type==="correct"?"ring-2 ring-green-500":""}`,onClick:()=>L({type:"correct",interrupt:k}),disabled:y(p),title:"Mark correct then click player seat",children:[e.jsx(Bn,{color:"#00f900",className:"h-4 w-4"})," Correct"]}),e.jsx("button",{className:`col-span-2 chip flex items-center justify-center gap-1 text-xs disabled:opacity-40 disabled:cursor-not-allowed disabled:brightness-75 ${k?"bg-purple-600 text-white ring-2 ring-purple-500":""}`,onClick:()=>R(V=>!V),disabled:y(p),title:"Toggle interrupt (applies to next correct/incorrect)",children:k?"Interrupt ON":"Interrupt"})]}),k&&b[p]?.tossup&&!y(p)&&e.jsxs("div",{className:"space-y-1 rounded-md border border-black/10 dark:border-white/10 p-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-[11px] font-medium",children:"Typed answer (AI check)"}),e.jsx("button",{type:"button",className:`chip text-[11px] px-2 py-0.5 ${E?"bg-purple-600 text-white":""}`,onClick:()=>B(V=>!V),title:"Toggle typed answer entry for interrupts",children:E?"Hide":"Type Answer"})]}),E&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-[10px] opacity-70",children:"Select a player seat, then enter the answer as given and check with AI."}),e.jsx("input",{type:"text",className:"w-full rounded border border-black/10 dark:border-white/10 bg-white dark:bg-darkcard px-2 py-1 text-xs",placeholder:"Type the player’s answer…",value:z,onChange:V=>$(V.target.value),disabled:S}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"text-[10px]",children:["Seat: ",m?"selected":"—"]}),e.jsx("button",{type:"button",className:"chip text-[11px] bg-tint text-white disabled:opacity-50 disabled:cursor-not-allowed",onClick:C,disabled:S||!m||!z.trim(),children:S?"Checking…":"Check with AI"})]}),A&&e.jsxs("div",{className:"text-[10px] opacity-80",children:["AI: ",A]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("button",{className:"chip text-xs disabled:opacity-40 disabled:cursor-not-allowed",onClick:a,disabled:y(p),title:"Record as no answer and advance (attempts already made remain in the log)",children:"No Answer"}),e.jsx("button",{className:"chip text-xs",onClick:j,children:"Throw Out & Replace"})]}),q[p]?.result==="correct"&&b[p]?.bonus&&b[p]?.tossup&&!Y[p]&&e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("button",{className:"chip text-xs bg-green-600 text-white hover:bg-green-700",onClick:()=>{o(!0)},children:"Award +10"}),e.jsx("button",{className:"chip text-xs bg-red-600 text-white hover:bg-red-700",onClick:()=>{o(!1)},children:"No Bonus"})]}),Y[p]&&e.jsxs("div",{className:"text-xs",children:["Bonus: ",Y[p].points," pts"]}),T&&e.jsxs("div",{className:"text-xs text-center text-blue-600 dark:text-blue-300",children:["Select a player seat to apply a ",T.interrupt?"Interrupt ":"",T.type,"."]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium flex items-center gap-2 justify-between",children:[e.jsxs("span",{children:["Players ",F&&e.jsx("span",{className:"text-[10px] font-normal px-1.5 py-0.5 rounded bg-purple-600 text-white",children:"SUB MODE"})]}),e.jsx("button",{type:"button",className:"chip px-2 py-1 text-[11px]",onClick:()=>h(!0),title:"Open substitution modal",children:"Substitute"})]}),e.jsx("div",{className:"space-y-6",children:["A","B"].map(V=>e.jsxs("div",{children:[e.jsxs("div",{className:`text-[12px] font-semibold mb-2 tracking-wide ${V==="A"?"text-green-600 dark:text-green-400":"text-blue-600 dark:text-blue-400"}`,children:["Team ",V]}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:r.filter(H=>H.team===V).map(H=>{const Le=r.findIndex(We=>We.id===H.id);let we=H.status==="replaced"||T&&!w.includes(H.team);return $e&&xe==="tossup"&&T&&((q[p]?.attempts||[]).some(lt=>lt.playerId===H.id)?we=!0:we=H.status==="replaced"),e.jsxs("button",{onClick:()=>v(Le),className:`relative flex flex-col items-center justify-center h-24 rounded-xl border border-black/10 dark:border-white/10 ${we?"bg-black/10 dark:bg-white/10 opacity-40 cursor-not-allowed":"bg-gradient-to-br from-black/5 to-black/10 dark:from-white/10 dark:to-white/5 hover:from-black/10 hover:to-black/20 dark:hover:from-white/20 dark:hover:to-white/10"} transition text-[11px] font-medium ${T&&!we&&H.status!=="replaced"?"ring-2 ring-offset-2 ring-green-500 dark:ring-green-400 animate-pulse-slow":""}`,title:H.name||`Seat ${V}${H.seat??(H.id<=4?H.id:H.id-4)}`,disabled:H.status==="replaced",children:[e.jsx(In,{className:"h-7 w-7 opacity-70"}),e.jsx("span",{className:"mt-2 truncate max-w-[120px] px-2 text-center leading-tight",children:H.name||`Seat ${V}${H.seat??(H.id<=4?H.id:H.id-4)}`}),H.status==="replaced"&&e.jsx("span",{className:"absolute top-1 left-1 text-[10px] bg-red-600 text-white px-1 rounded",children:"OUT"}),H.stats.correct+H.stats.correctInterrupt>0&&e.jsx("span",{className:"absolute top-0 right-0 text-[10px] bg-green-600 text-white rounded-bl px-1",children:H.stats.correct+H.stats.correctInterrupt})]},H.id)})})]},V))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium mb-1",children:"Player Stats"}),e.jsxs("table",{className:"w-full text-[10px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-[9px] text-black/70 dark:text-white/70",children:[e.jsx("th",{className:"text-left",children:"Player"}),e.jsx("th",{children:"Tm"}),e.jsx("th",{children:"C"}),e.jsx("th",{children:"I"}),e.jsx("th",{children:"CI"}),e.jsx("th",{children:"II"})]})}),e.jsx("tbody",{children:r.filter(V=>V.name).map(V=>e.jsxs("tr",{className:"odd:bg-black/0 even:bg-black/5 dark:even:bg-white/5",children:[e.jsx("td",{className:"truncate max-w-[90px] pr-1",children:V.name}),e.jsx("td",{className:"text-center",children:V.team}),e.jsx("td",{className:"text-center",children:V.stats.correct}),e.jsx("td",{className:"text-center",children:V.stats.incorrect}),e.jsx("td",{className:"text-center",children:V.stats.correctInterrupt}),e.jsx("td",{className:"text-center",children:V.stats.incorrectInterrupt})]},V.id))})]})]}),p>=b.length&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{className:"btn btn-orange w-full justify-center",onClick:te,disabled:re,children:re?"Generating…":"Coaches Scoresheet PDF"}),e.jsx("button",{className:"btn btn-ghost w-full justify-center",onClick:()=>J(),children:"Reset Scorekeeping"})]})]})]})}function nr({open:n,onClose:c,players:p,onSubmit:b,initialTeam:T="A"}){const[k,L]=x.useState(T),[R,E]=x.useState(null),[B,z]=x.useState(""),[$,m]=x.useState(!1);if(x.useEffect(()=>{if(n){L(T);const a=p.filter(j=>j.team===T)[0];E(a?.id??null),z(""),m(!1)}},[n,T,p]),!n)return null;const S=p.filter(a=>a.team===k),C=p.filter(a=>a.team===k).length>=5,y=B.trim().length>0&&R!=null&&!C;return p.find(a=>a.id===R),e.jsxs("div",{className:"fixed inset-0 z-[75] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:c}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl w-full max-w-md border border-black/10 dark:border-white/10 p-6 flex flex-col gap-5",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Substitute Player"}),e.jsx("button",{type:"button",className:"chip text-xs",onClick:c,children:"Close"})]}),e.jsxs("div",{className:"space-y-4 text-sm",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"font-medium text-xs uppercase tracking-wide",children:"Team"}),e.jsx("div",{className:"flex gap-2",children:["A","B"].map(a=>e.jsxs("button",{type:"button",className:`chip px-3 py-1 text-sm ${k===a?"ring-2 ring-tint bg-tint/10":""}`,onClick:()=>{L(a);const j=p.filter(q=>q.team===a)[0];E(j?.id??null)},children:["Team ",a]},a))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"font-medium text-xs uppercase tracking-wide",children:"Outgoing Seat"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:S.map(a=>e.jsxs("button",{type:"button",onClick:()=>E(a.id),className:`chip flex flex-col items-center gap-1 py-2 ${R===a.id?"ring-2 ring-tint bg-tint/10":""}`,children:[e.jsx("span",{className:"text-[11px] font-semibold",children:a.name||`Seat ${k}${a.seat??(a.id<=4?a.id:a.id-4)}`}),a.name&&e.jsxs("span",{className:"text-[10px] opacity-60",children:[a.stats.correct+a.stats.correctInterrupt," C / ",a.stats.incorrect+a.stats.incorrectInterrupt," I"]})]},a.id))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"font-medium text-xs uppercase tracking-wide",htmlFor:"new-player-name",children:"New Player Name"}),e.jsx("input",{id:"new-player-name",type:"text",className:"w-full rounded-lg border border-black/10 dark:border-white/10 bg-white dark:bg-darkcard px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-tint",placeholder:"Enter name",value:B,onChange:a=>{z(a.target.value),m(!0)},autoFocus:!0}),$&&B.trim()===""&&e.jsx("div",{className:"text-[11px] text-red-600 mt-1",children:"Name required."})]}),C&&e.jsx("div",{className:"text-[11px] text-red-600",children:"Team already has a substitute (5 players shown). Further substitutions disabled."})]}),e.jsxs("div",{className:"flex flex-col gap-2 pt-2",children:[e.jsx("button",{type:"button",disabled:!y,onClick:()=>{y&&(b({team:k,playerId:R,newName:B.trim()}),c())},className:"btn btn-primary w-full justify-center disabled:opacity-40 disabled:cursor-not-allowed",children:"Apply Substitution"}),e.jsx("button",{type:"button",onClick:c,className:"btn btn-ghost w-full justify-center",children:"Cancel"})]})]})]})}function rr({toasts:n,headerOffset:c=0,onDismiss:p}){return e.jsx("div",{className:"fixed right-4 z-[60] flex flex-col gap-3 w-[min(92vw,360px)] pointer-events-none",style:{top:Math.max(c+8,12)},children:n.map(b=>e.jsxs("div",{className:"group pointer-events-auto relative overflow-hidden rounded-md px-4 py-3 pr-10 text-sm shadow-lg flex items-start gap-3 animate-toast-enter "+(b.type==="success"?"bg-emerald-600 text-white":b.type==="error"?"bg-red-600 text-white":"bg-neutral-800 text-white"),role:"status","aria-live":"polite",children:[e.jsx("div",{className:"flex-1 break-words leading-relaxed",children:b.message}),e.jsx("button",{className:"absolute top-1.5 right-1.5 rounded p-1 text-white/70 hover:text-white hover:bg-white/10 transition-colors","aria-label":"Dismiss notification",onClick:()=>p?.(b.id),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"h-4 w-4",children:e.jsx("path",{fillRule:"evenodd",d:"M4.22 4.22a.75.75 0 011.06 0L10 8.94l4.72-4.72a.75.75 0 111.06 1.06L11.06 10l4.72 4.72a.75.75 0 11-1.06 1.06L10 11.06l-4.72 4.72a.75.75 0 01-1.06-1.06L8.94 10 4.22 5.28a.75.75 0 010-1.06z",clipRule:"evenodd"})})}),e.jsx("span",{className:"absolute bottom-0 left-0 h-0.5 bg-white/70 group-hover:bg-white",style:{width:"100%",transformOrigin:"left",animation:`toast-bar-${b.id} ${b.ttl}ms linear forwards`}}),e.jsx("style",{children:"@keyframes toast-enter { from { opacity:0; transform: translateY(-4px) scale(.98); } to { opacity:1; transform: translateY(0) scale(1); } } .animate-toast-enter { animation: toast-enter 160ms cubic-bezier(.4,0,.2,1); }"}),e.jsx("style",{children:`@keyframes toast-bar-${b.id} { from { transform: scaleX(1); } to { transform: scaleX(0); } }`})]},b.id))})}function or({validQuestions:n,selectedTournaments:c,inRanges:p,selectedCategories:b,selectedExcludeRoundIds:T,excludeDetailCache:k,count:L,questionType:R,allowVisualInPairs:E,allowVisualInBonusOnly:B,buildExcludeSetFromRound:z}){const $=new Set;for(const C of T||[]){const y=k?.current?.get(C);if(y){const a=z(y);for(const j of a)$.add(j)}}function m(C,y){if(C.length===0||y<=0)return[];const a=new Map;for(const w of C)a.has(w.category)||a.set(w.category,[]),a.get(w.category).push(w);let j=Array.from(a.keys());if(b&&b.length){const w=new Set(b);j=j.filter(l=>w.has(l))}if(j=j.filter(w=>(a.get(w)?.length||0)>0),j.length===0)return[];const q=[...j].sort(()=>Math.random()-.5),Y=Math.floor(y/q.length);let o=y%q.length;const r=[],v=new Set;for(let w=0;w<q.length;w++){const l=q[w],g=[...a.get(l)].sort(()=>Math.random()-.5),D=Math.min(Y+(o>0?1:0),g.length);o>0&&o--;for(let F=0;F<D;F++){const h=g[F];v.has(h.id)||(r.push(h),v.add(h.id))}}if(r.length<y){const w=[];for(const l of j)for(const g of a.get(l))v.has(g.id)||w.push(g);w.sort(()=>Math.random()-.5);for(const l of w){if(r.length>=y)break;r.push(l),v.add(l.id)}}return r.slice(0,y)}let S=[];const A=String(R||"both").toLowerCase();if(A==="tossup"){const C=(n||[]).filter(a=>(c.length?c.includes(a.tournament):!0)&&p(a)&&String(a.question_type||"").toLowerCase()==="tossup"&&!$.has(a.id)),y=C.length<=L?[...C]:m(C,L);for(let a=y.length-1;a>0;a--){const j=Math.floor(Math.random()*(a+1));[y[a],y[j]]=[y[j],y[a]]}S=y.map(a=>({tossup:a,bonus:null}))}else if(A==="bonus"){const C=(n||[]).filter(a=>(c.length?c.includes(a.tournament):!0)&&p(a)&&String(a.question_type||"").toLowerCase()==="bonus"&&(B?!0:!Ee(a))&&!$.has(a.id)),y=C.length<=L?[...C]:m(C,L);for(let a=y.length-1;a>0;a--){const j=Math.floor(Math.random()*(a+1));[y[a],y[j]]=[y[j],y[a]]}S=y.map(a=>({tossup:null,bonus:a}))}else if(A==="visual-bonus"){const C=(n||[]).filter(a=>(c.length?c.includes(a.tournament):!0)&&p(a)&&String(a.question_type||"").toLowerCase()==="bonus"&&Ee(a)&&!$.has(a.id)),y=C.length<=L?[...C]:m(C,L);for(let a=y.length-1;a>0;a--){const j=Math.floor(Math.random()*(a+1));[y[a],y[j]]=[y[j],y[a]]}S=y.map(a=>({tossup:null,bonus:a}))}else{const y=(n||[]).filter(j=>(c.length?c.includes(j.tournament):!0)&&p(j)&&String(j.question_type||"").toLowerCase()==="tossup"&&!$.has(j.id)).filter(j=>{const q=ss(j,n);return!(!q||$.has(q.id)||!E&&Ee(q))}),a=y.length<=L?[...y]:m(y,L);for(let j=a.length-1;j>0;j--){const q=Math.floor(Math.random()*(j+1));[a[j],a[q]]=[a[q],a[j]]}S=a.map(j=>{const q=ss(j,n),Y=q&&(E||!Ee(q))&&!$.has(q.id)?q:null;return{tossup:j,bonus:Y}})}return S}function ar({leftPaneCollapsed:n,leftPanePinned:c,leftPaneHovered:p,setLeftPaneCollapsed:b,setLeftPanePinned:T,setLeftPaneHovered:k}){return e.jsx("button",{className:"absolute top-2 -right-2 bg-white dark:bg-darkcard border border-black/10 dark:border-white/20 rounded-full p-1 shadow hover:bg-gray-50 dark:hover:bg-white/10 transition z-10",onClick:()=>{n||!c?(b(!1),T(!0)):(T(!1),b(!0))},onMouseEnter:()=>k(!0),onMouseLeave:()=>k(!1),title:n?"Expand panel":c?"Unpin panel":"Pin panel",children:n?p?e.jsx(os,{className:"h-4 w-4"}):e.jsx(Mn,{className:"h-4 w-4 transition-transform rotate-180"}):c?e.jsx(Tn,{className:"h-4 w-4"}):e.jsx(os,{className:"h-4 w-4"})})}function Xo({questions:n=[],lazy:c=null,auth:p=null,persistedGenerated:b=null,setPersistedGenerated:T=null,onNewRound:k=null}){const{isLazy:L,tournaments:R,tournamentGroups:E,selectedTournaments:B,setSelectedTournaments:z,selectedCategories:$,setSelectedCategories:m,tournamentGroupsOpen:S,setTournamentGroupsOpen:A,tournamentVisibleEntriesMainRef:C,handleTournamentToggle:y,loadedQuestions:a,validQuestions:j,categories:q,roundRanges:Y,setRoundRanges:o,roundsByTournament:r,globalNumericRoundMax:v,inRanges:w}=cn({questions:n,lazy:c}),[l,g]=x.useState(!1),[D,F]=x.useState([]);function h(s,t="info",i=4e3){const d=Math.random().toString(36).slice(2),f=Date.now();F(u=>[...u,{id:d,message:s,type:t,ttl:i,created:f}]),i>0&&setTimeout(()=>F(u=>u.filter(N=>N.id!==d)),i+50)}const{roundsIndex:J,setRoundsIndex:te,loadingUserRounds:re,roundFolders:$e,setRoundFolders:me,foldersOpen:xe,setFoldersOpen:V,selectedExcludeRoundIds:H,setSelectedExcludeRoundIds:Le,excludeDetailCache:we,handleExcludeRoundToggle:We,refresh:lt,deleteFolderAndRounds:us}=On({auth:p,pushToast:h});x.useRef(null),x.useRef(null);const[ms,ps]=x.useState(!1),[De,fs]=x.useState(10),[hs,xs]=x.useState([]),pe=Array.isArray(b)?b:hs,be=typeof T=="function"?T:xs,{history:Z,setHistory:bs}=dn(),[ze,ct]=x.useState(null);X.useEffect(()=>{Array.isArray(Z)&&Z.length>0?ct(Z.length-1):ct(null)},[Z]);function Lt(s){if(!Array.isArray(Z)||Z.length===0||s<0||s>=Z.length)return;gt(""),ct(s);const t=Z[s]||[];be(t),Me(!0),Ye();try{window.scrollTo({top:0,behavior:"smooth"})}catch{}try{bn(s+1).catch(()=>{})}catch{}}const[fe,gs]=x.useState(!0),[he,ys]=x.useState(!0),[ge,ws]=x.useState(!1),[le,Bt]=x.useState("both"),It=fe&&he&&ge,Mt=!fe&&he&&ge;X.useEffect(()=>{let s="both";fe&&he?s="both":fe&&!he?s="tossup":!fe&&he&&!ge?s="bonus":!fe&&!he&&ge?s="visual-bonus":!fe&&he&&ge?s="bonus":s="both",Bt(s)},[fe,he,ge]);const Tt=X.useRef(null),js=2,[Et,Pt]=x.useState(!1),[$t,Dt]=x.useState(!1),[He,zt]=x.useState(!1),[vs,ks]=x.useState(!1),{dark:Ns}=un(),Ss=!!Ns,[oe,Ft]=x.useState(!1),Cs=x.useRef(9),[K,Fe]=x.useState(()=>Array.from({length:8},(s,t)=>({id:t+1,team:t<4?"A":"B",seat:t<4?t+1:t-3,name:"",status:"active",stats:{correct:0,incorrect:0,correctInterrupt:0,incorrectInterrupt:0}}))),[W,dt]=x.useState(0),[ae,je]=x.useState(null),[As,Be]=x.useState(!1),[ut,mt]=x.useState(!1),[_t,pt]=x.useState(""),[ft,ht]=x.useState(null),[Rs,Ut]=x.useState(!1),[Ls,xt]=x.useState(""),[ie,_e]=x.useState([]),[ye,Ve]=x.useState([]),[qt,de]=x.useState(null),[bt,ce]=x.useState(["A","B"]),[ve,Ot]=x.useState(!1);X.useEffect(()=>{try{localStorage.getItem("sb_tryoutsMode")==="1"&&Ot(!0)}catch{}},[]),X.useEffect(()=>{try{localStorage.setItem("sb_tryoutsMode",ve?"1":"0")}catch{}},[ve]);const[Bs,Gt]=x.useState(!1),[ir,lr]=x.useState("A"),[Is,Wt]=x.useState(!1),[Ms,Qe]=x.useState(""),[Xe,Ht]=x.useState(0),Vt=x.useRef([]);X.useEffect(()=>{function s(){const t=document.querySelector("header, .site-header, .app-header, .top-bar");if(t){const i=t.getBoundingClientRect();Ht(i.height)}else Ht(0)}return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),X.useEffect(()=>{if(!oe)return;const s=Vt.current[W];if(s&&typeof s.scrollIntoView=="function"){const t=Math.max(Xe+12,0),i=s.getBoundingClientRect(),d=window.scrollY+i.top-t;window.scrollTo({top:d,behavior:"smooth"})}},[W,oe,Xe]);const Ts=x.useMemo(()=>{let s=0;return ie.forEach(t=>{t&&(Array.isArray(t.attempts)?t.attempts.forEach(i=>{typeof i.points=="number"&&(s+=i.points)}):typeof t.points=="number"&&(s+=t.points))}),ye.forEach(t=>{t&&typeof t.points=="number"&&(s+=t.points)}),s},[ie,ye]),Es=x.useMemo(()=>{const s={A:0,B:0};return ie.forEach(t=>{if(t){if(Array.isArray(t.attempts)&&t.attempts.length)t.attempts.forEach(i=>{const d=K.find(f=>f.id===i.playerId)?.team;d&&(s[d]+=i.points||0)});else if(t.playerId){const i=K.find(d=>d.id===t.playerId)?.team;i&&(s[i]+=t.points||0)}}}),ye.forEach(t=>{t?.team&&(s[t.team]+=t.points||0)}),s},[ie,ye,K]);function Ye(){dt(0),je(null),_e([]),Ve([]),Qe(""),de(null),ce(["A","B"]),Gt(!1)}function Ps(s){const t=K[s];if(t){if(ut){if(!bt.includes(t.team)){h(`Team ${t.team} not allowed to buzz now.`,"error");return}if(t.status==="replaced"){h("Cannot buzz: seat replaced.","error");return}if(ve&&le==="tossup"&&(ie[W]?.attempts||[]).some(d=>d.playerId===t.id)){h("This player already attempted this toss-up.","error");return}ht(t.id),h(`Selected ${t.name||`Seat ${t.team}${t.seat??""}`} for typed interrupt.`,"info",2500);return}if(t.status==="replaced"){h("Cannot buzz: seat replaced.","error");return}if(ae){if(!bt.includes(t.team)){h(`Team ${t.team} not allowed to buzz now.`,"error");return}const{type:i,interrupt:d}=ae,f=qt==null;if(_e(u=>{const N=[...u],M=i==="correct"?4:i==="incorrect"&&d?-4:0,I=N[W]||{},O=Array.isArray(I.attempts)?[...I.attempts]:[];return O.push({playerId:t.id,team:t.team,result:i,interrupt:d,points:M}),i==="correct"?N[W]={...I,attempts:O,result:"correct",playerId:t.id,interrupt:d,points:M}:f?N[W]={...I,attempts:O,result:"incorrect",playerId:t.id,interrupt:d,points:M}:N[W]={...I,attempts:O,result:"incorrect",playerId:t.id,interrupt:d,points:M},N}),Fe(u=>u.map(N=>N.id===t.id?{...N,stats:{...N.stats,correct:N.stats.correct+(ae.type==="correct"&&!ae.interrupt?1:0),incorrect:N.stats.incorrect+(ae.type==="incorrect"&&!ae.interrupt?1:0),correctInterrupt:N.stats.correctInterrupt+(ae.type==="correct"&&ae.interrupt?1:0),incorrectInterrupt:N.stats.incorrectInterrupt+(ae.type==="incorrect"&&ae.interrupt?1:0)}}:N)),je(null),Be(!1),f&&ae.type==="incorrect")ve&&le==="tossup"?(de(null),ce(["A","B"])):(de(t.team),ce([t.team==="A"?"B":"A"]));else if(ae.type==="incorrect")de(null),ce([]),setTimeout(()=>Ie(),200);else if(ae.type==="correct"){de(null),ce([]);const u=se[W];u?.bonus&&u.tossup?Qe(""):setTimeout(()=>Ie(),150)}return}if(t.name){const i=window.prompt("Rename player",t.name);i!=null&&Fe(d=>d.map((f,u)=>u===s?{...f,name:i.trim()}:f))}else{const i=window.prompt("Enter player name (seat "+(s+1)+")","");i!=null&&Fe(d=>d.map((f,u)=>u===s?{...f,name:i.trim()}:f))}}}function $s({player:s,type:t,interrupt:i}){if(!s)return;const d=qt==null;if(_e(f=>{const u=[...f],N=t==="correct"?4:t==="incorrect"&&i?-4:0,M=u[W]||{},I=Array.isArray(M.attempts)?[...M.attempts]:[];return I.push({playerId:s.id,team:s.team,result:t,interrupt:i,points:N}),t==="correct"?u[W]={...M,attempts:I,result:"correct",playerId:s.id,interrupt:i,points:N}:u[W]={...M,attempts:I,result:"incorrect",playerId:s.id,interrupt:i,points:N},u}),Fe(f=>f.map(u=>u.id===s.id?{...u,stats:{...u.stats,correct:u.stats.correct+0,incorrect:u.stats.incorrect+0,correctInterrupt:u.stats.correctInterrupt+(t==="correct"&&i?1:0),incorrectInterrupt:u.stats.incorrectInterrupt+(t==="incorrect"&&i?1:0)}}:u)),je(null),Be(!1),t==="incorrect")d?ve&&le==="tossup"?(de(null),ce(["A","B"])):(de(s.team),ce([s.team==="A"?"B":"A"])):(de(null),ce([]),setTimeout(()=>Ie(),200));else if(t==="correct"){de(null),ce([]);const f=se[W];f?.bonus&&f.tossup?Qe(""):setTimeout(()=>Ie(),150)}}async function Ds(){try{if(!ut)return;const t=se[W]?.tossup;if(!t){h("No toss-up at this question.","error");return}if(!ft){h("Select a player seat first.","error");return}const i=K.find(_=>_.id===ft);if(!i){h("Invalid player selection.","error");return}const d=String(_t||"").trim();if(!d){h("Enter an answer to check.","error");return}Ut(!0),xt("");const f=Pe(t),u=Array.isArray(f)&&f.length>0,N={userAnswer:d,correctAnswer:t.answer,question:t.question};u&&(N.choices=f);const M=await(u?gn(N):yn(N)).catch(_=>({ok:!1,statusText:_?.message}));if(!M||!M.ok){h("AI check failed. You can record manually.","error");return}const I=await M.json().catch(()=>({})),O=!!I?.correct,P=typeof I?.reason=="string"?I.reason:"";xt(P||""),$s({player:i,type:O?"correct":"incorrect",interrupt:!0}),h(O?"AI: Correct interrupt.":"AI: Incorrect interrupt.",O?"success":"error")}catch(s){console.error(s),h("AI check encountered an error.","error")}finally{Ut(!1),mt(!1),pt(""),ht(null),setTimeout(()=>xt(""),4e3)}}function zs(){_e(s=>{const t=[...s],i=t[W]||{},d=Array.isArray(i.attempts)?i.attempts:[];return t[W]={...i,attempts:d,result:"no-answer",points:i.points||0},t}),je(null),Be(!1),ce([]),setTimeout(()=>Ie(),150)}function Ie(){const s=se[W],t=ie[W];s?.bonus&&s?.tossup&&t?.result==="correct"&&!ye[W]||(dt(i=>Math.min(i+1,se.length)),de(null),ce(["A","B"]))}function Fs(){const s=Number(Ms);if(!Number.isFinite(s)||s<0)return;const t=Math.min(10,Math.max(0,s)),i=ie[W],d=i?.playerId&&K.find(f=>f.id===i.playerId)?.team||"A";Ve(f=>{const u=[...f];return u[W]={points:t,team:d},u}),Qe(""),setTimeout(()=>Ie(),100)}function _s(s){const t=ie[s];if(!t)return!1;if(t.result==="replaced"||t.result==="no-answer"||t.result==="correct")return!0;if(ve&&le==="tossup"){const f=t.attempts||[],u=new Set(f.map(M=>M.playerId));return K.filter(M=>M.status!=="replaced").filter(M=>!u.has(M.id)).length===0}const i=t.attempts||[];return new Set(i.map(f=>K.find(u=>u.id===f.playerId)?.team).filter(Boolean)).size>=2&&t.result==="incorrect"}function Us(s){const t=s?10:0,i=ie[W],d=i?.playerId&&K.find(f=>f.id===i.playerId)?.team||"A";Ve(f=>{const u=[...f];return u[W]={points:t,team:d},u}),je(null),Be(!1),de(null),ce(["A","B"]),dt(f=>Math.min(f+1,se.length))}function qs(){if(!se[W])return;const t=new Set(se.flatMap(f=>[f.tossup?.id,f.bonus?.id].filter(Boolean))),i=tt(),d=i.find(f=>!t.has(f.tossup?.id)&&!t.has(f.bonus?.id))||i[0];be(f=>f.map((u,N)=>N===W?d:u)),_e(f=>{const u=[...f];return u[W]=void 0,u}),Ve(f=>{const u=[...f];return u[W]=void 0,u}),de(null),ce(["A","B"]),je(null),Be(!1),mt(!1),pt(""),ht(null),h("Question replaced.","info")}const[Os,Qt]=x.useState(!1);async function Gs(){Qt(!0);try{const s=await Fn(e.jsx(Yn,{sheetRows:Ks,players:K,metadata:{generatedAt:new Date().toLocaleString()}})).toBlob(),t=URL.createObjectURL(s),i=document.createElement("a");i.href=t,i.download="Coaches-Scoresheet-"+new Date().toISOString().slice(0,10)+".pdf",document.body.appendChild(i),i.click(),setTimeout(()=>{URL.revokeObjectURL(t),i.remove()},1e3)}catch(s){console.error("Failed to export coaches scoresheet (react-pdf):",s),window.alert?.("Failed to export coaches scoresheet: "+(s.message||String(s)))}finally{Qt(!1)}}const Xt=25,[Ws,Hs]=x.useState(""),[ke,gt]=x.useState(""),[Vs,Me]=x.useState(!1),[Qs,Ue]=x.useState(!1),[Ne,Ke]=x.useState(null),[Je,Yt]=x.useState(!1),[Xs,yt]=x.useState(!1),[Se,Ce]=x.useState(new Set),[Te,Ze]=x.useState(null),[et,Kt]=x.useState(!1);x.useRef([]),x.useRef(null),X.useEffect(()=>{const s=()=>{try{const t=window.scrollY||document.documentElement.scrollTop||0;ks(t>300)}catch{}};return window.addEventListener("scroll",s,{passive:!0}),s(),()=>window.removeEventListener("scroll",s)},[]);function tt(){return or({validQuestions:j,selectedTournaments:B,inRanges:w,selectedCategories:$,selectedExcludeRoundIds:H,excludeDetailCache:we,count:De,questionType:le,allowVisualInPairs:It,allowVisualInBonusOnly:Mt,buildExcludeSetFromRound:kn})}X.useEffect(()=>{L&&B.length!==0&&c.ensureLoaded(B)},[L,c,B]);const Ys=x.useMemo(()=>{const s=ke.trim().toLowerCase();return s?j.filter(t=>[t.question,t.answer,t.category,t.tournament,t.round].some(d=>d!=null&&String(d).toLowerCase().includes(s))).map(t=>({tossup:t.question_type?.toLowerCase()==="tossup"?t:null,bonus:t.question_type?.toLowerCase()==="bonus"?t:null})):[]},[ke,j]),se=ke.trim()&&pe.length>0?Ys:pe,Ks=x.useMemo(()=>{const s=[];for(let d=0;d<Math.min(se.length,Xt);d++){const f=se[d],u=f.tossup,N=ie[d],M=ye[d],I=u?Pe(u).length>0:!1,O=N?.attempts||[],P={A:O.filter(_=>K.find(ne=>ne.id===_.playerId)?.team==="A"),B:O.filter(_=>K.find(ne=>ne.id===_.playerId)?.team==="B")};s.push({index:d+1,subject:mn(u?.category||f.bonus?.category),type:I?"MC":"SA",attempts:O,byTeam:P,bonusA:M&&M.team==="A"?M.points:0,bonusB:M&&M.team==="B"?M.points:0,penaltyA:O.filter(_=>K.find(ne=>ne.id===_.playerId)?.team==="A"&&(_.points||0)<0).reduce((_,ne)=>_+Math.abs(ne.points||0),0),penaltyB:O.filter(_=>K.find(ne=>ne.id===_.playerId)?.team==="B"&&(_.points||0)<0).reduce((_,ne)=>_+Math.abs(ne.points||0),0),bonusAwardedTeam:M?.team||null})}for(;s.length<Xt;)s.push({pad:!0,index:s.length+1});let t=0,i=0;return s.forEach(d=>{if(d.pad){d.cumA=t,d.cumB=i;return}const f=(d.attempts||[]).filter(N=>K.find(M=>M.id===N.playerId)?.team==="A").reduce((N,M)=>N+(M.points||0),0),u=(d.attempts||[]).filter(N=>K.find(M=>M.id===N.playerId)?.team==="B").reduce((N,M)=>N+(M.points||0),0);t+=f+(d.bonusA||0),i+=u+(d.bonusB||0),d.cumA=t,d.cumB=i}),s},[se,ie,ye,K]);async function wt(s={}){const{force:t=!1}=s;if(ke.trim())return;if(!fe&&!he&&!ge){h("Select at least one question type (Toss-ups, Bonuses, or Visual bonuses).","error");return}if(ps(!0),!t&&pe.length>0&&Vs){Ue(!0);return}const i=Number(De)>50;i&&Dt(!0);try{try{L&&B.length>0&&await c.ensureLoaded(B)}catch{}console.group("RoundGenerator.generate"),console.log("Filters:",{selectedTournaments:B,selectedCategories:$,roundRanges:Y,count:De,questionType:le});try{const f=Math.max(1,Number(De)||1);async function u(){const P=await wn({questionType:le,categories:$,count:f}).catch(()=>({roundId:null}));if(!(P?.roundId||null))return{pairs:[],tournaments:[]};const ne=Array.isArray(P.pairs)?P.pairs:[];if(ne.length===0)return{pairs:[],tournaments:[]};const Nt=new Set;for(const G of ne){const rt=G?.tossupMeta?.tournament;rt&&Nt.add(rt);const ot=G?.bonusMeta?.tournament;ot&&Nt.add(ot)}const st=Array.from(Nt);try{L&&st.length&&await c.ensureLoaded(st)}catch{}const rn=L?c.getLoadedQuestions(st):j,Zt=new Map(rn.map(G=>[G.id,G])),on=new Set($),nt=G=>!(!G||$.length&&!on.has(G.category));let Re=ne.map(G=>({tossup:G.tossupId&&Zt.get(G.tossupId)||null,bonus:G.bonusId&&Zt.get(G.bonusId)||null}));return le==="tossup"?Re=Re.map(G=>G.tossup?{tossup:G.tossup,bonus:null}:null).filter(Boolean).filter(G=>nt(G.tossup)):le==="bonus"?Re=Re.map(G=>G.bonus?{tossup:null,bonus:G.bonus}:null).filter(Boolean).filter(G=>nt(G.bonus)).filter(G=>Mt?!0:!Ee(G.bonus)):Re=Re.map(G=>{const rt=nt(G.tossup),ot=G.bonus?nt(G.bonus):!0,an=G.bonus?ot&&(It||!Ee(G.bonus)):!0;return rt?{tossup:G.tossup,bonus:an?G.bonus:null}:null}).filter(Boolean),{pairs:Re,tournaments:st}}const N=[],M=new Set,I=P=>{let _="";le==="tossup"?_=P.tossup?.id?`tu:${P.tossup.id}`:"":le==="bonus"?_=P.bonus?.id?`bo:${P.bonus.id}`:"":_=P.tossup?.id?`tu:${P.tossup.id}`:P.bonus?.id?`bo:${P.bonus.id}`:"",!(!_||M.has(_))&&(M.add(_),N.push(P))};if((await u()).pairs.forEach(I),N.length>=f){const P=N.slice(0,f);typeof k=="function"?k(P):be(P),Me(!0),console.groupEnd();return}if(N.length<f&&(await u()).pairs.forEach(I),N.length>=f){const P=N.slice(0,f);typeof k=="function"?k(P):be(P),Me(!0),console.groupEnd();return}N.length>0&&h("Not enough preset questions matched filters; using normal generator.","info",5e3)}catch(f){console.warn("Preset round claim/materialization failed; falling back.",f)}const d=tt();typeof k=="function"?k(d):be(d),d.length===0&&h("No questions match the criteria provided.","error",5e3),Me(!0),console.groupEnd()}finally{i&&Dt(!1)}}async function Jt(){if(!p?.user){window.alert?.("Please log in to save rounds.");return}zt(!0);try{let s=pe;if((!s||s.length===0)&&(s=tt(),be(s)),!s||s.length===0)return;const t=new Date,d={title:`Round at ${t.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})} on ${t.toLocaleDateString()}`,questionType:le,count:s.length,tournaments:B,categories:$,roundRanges:Y,pairs:s.map(u=>({tossupId:u.tossup?.id||null,bonusId:u.bonus?.id||null,tossupMeta:u.tossup?{tournament:u.tossup.tournament,round:u.tossup.round,question_number:u.tossup.question_number,category:u.tossup.category}:null,bonusMeta:u.bonus?{tournament:u.bonus.tournament,round:u.bonus.round,question_number:u.bonus.question_number,category:u.bonus.category}:null}))},f=await jn(p.user.uid,d);te(u=>[{id:f,title:d.title,createdAt:{seconds:Math.floor(Date.now()/1e3)},count:d.count},...u]),h("Round saved to your account.","success"),Me(!1)}catch(s){console.error(s),window.alert?.(`Failed to save round: ${s.message||String(s)}`),h(`Failed to save round: ${s.message||String(s)}`,"error",6e3)}finally{zt(!1)}}async function Js(){if(L&&B.length===0&&pe.length===0&&(a?.length??0)===0){window.alert?.("Select at least one tournament to generate a PDF.");return}Pt(!0);try{let s=[];if(ke.trim()?s=se:(s=pe,(!s||s.length===0)&&(s=tt(),be(s),await new Promise(f=>requestAnimationFrame(()=>f())).then(()=>new Promise(f=>setTimeout(f,0))))),!s||s.length===0)return;const t=Tt.current;if(!t)return;const i=await vn(),d={margin:[12,12,12,12],filename:`atombowl-Round-${new Date().toISOString().slice(0,10)}.pdf`,image:{type:"jpeg",quality:.95},html2canvas:{scale:2,useCORS:!0,letterRendering:!0,scrollY:0},pagebreak:{mode:["css","legacy"]},jsPDF:{unit:"mm",format:"letter",orientation:"portrait"}};await i().from(t).set(d).save()}finally{Pt(!1)}}async function Zs(s){try{if(!p?.user||!s?.id)return;const t=await cs(p.user.uid,s.id).catch(()=>null);if(!t){h("Failed to open round details.","error");return}const i=new Set;for(const I of t.pairs||[])I?.tossupMeta?.tournament&&i.add(I.tossupMeta.tournament),I?.bonusMeta?.tournament&&i.add(I.bonusMeta.tournament);const d=Array.from(i);try{L&&d.length&&await c.ensureLoaded(d)}catch{}const f=L?c.getLoadedQuestions(d.length?d:B):j,u=new Map;for(const I of f)u.set(I.id,I);let N=(t.pairs||[]).map(I=>({tuId:I.tossupId||null,boId:I.bonusId||null,tossup:I.tossupId&&u.get(I.tossupId)||null,bonus:I.bonusId&&u.get(I.bonusId)||null}));if(N.some(I=>I.tuId&&!I.tossup||I.boId&&!I.bonus)){const I=L?c.getLoadedQuestions(Array.from(new Set([...d||[],...B]))):j,O=new Map;for(const P of I)O.set(P.id,P);N=N.map(P=>({...P,tossup:P.tossup||P.tuId&&O.get(P.tuId)||null,bonus:P.bonus||P.boId&&O.get(P.boId)||null}))}const M=N.map(({tossup:I,bonus:O})=>({tossup:I,bonus:O})).filter(I=>I.tossup||I.bonus);if(!M.length){h("Round questions are not available in the current dataset.","error");return}be(M),Me(!1),gt("");try{Array.isArray(t.tournaments)&&t.tournaments.length&&z(t.tournaments),Array.isArray(t.categories)&&m(t.categories),t.roundRanges&&o(t.roundRanges),t.questionType&&Bt(t.questionType)}catch{}Ye(),window.scrollTo({top:0,behavior:"smooth"}),h("Round opened.","success")}catch(t){h(t?.message||"Failed to open round.","error")}}X.useEffect(()=>{(async()=>{if(!((Z?.length||0)>0&&(pe?.length||0)>0))try{const s=await pn();if(!Array.isArray(s)||s.length===0)return;const t=new Set;for(const P of s)for(const _ of P||[])_?.tu?.tournament&&t.add(_.tu.tournament),_?.bo?.tournament&&t.add(_.bo.tournament);const i=Array.from(t);try{L&&i.length&&await c.ensureLoaded(i)}catch{}const d=L?c.getLoadedQuestions(i.length?i:B):j,f=new Map(d.map(P=>[P.id,P])),u=P=>(P||[]).map(_=>({tossup:_?.tu?.id&&f.get(_.tu.id)||null,bonus:_?.bo?.id&&f.get(_.bo.id)||null})).filter(_=>_.tossup||_.bonus),N=s.map(u).filter(P=>Array.isArray(P));if(N.length===0)return;const M=N[0]||[],I=N.slice(1);M.length>0&&be(M);const O=[...I,M].filter(P=>Array.isArray(P));O.length>0&&bs(O)}catch{}})()},[L,c,j,B]);const[Ae,en]=x.useState(!1),[jt,qe]=x.useState(!1),[tn,sn]=x.useState(!0),[Oe,nn]=x.useState(()=>{try{const s=localStorage.getItem("sb_leftPaneWidth_rounds"),t=Number(s);return Number.isFinite(t)&&t>=220&&t<=720?t:320}catch{return 320}}),Ge=X.useRef(!1),vt=X.useRef(0),kt=X.useRef(320);return X.useEffect(()=>{function s(i){if(!Ge.current)return;const f=(i.touches?i.touches[0].clientX:i.clientX)-vt.current;let u=Math.round(kt.current+f);u=Math.max(220,Math.min(720,u)),nn(u)}function t(){if(Ge.current){Ge.current=!1;try{localStorage.setItem("sb_leftPaneWidth",String(Oe))}catch{}document.body.style.cursor="",document.body.style.userSelect=""}}return window.addEventListener("mousemove",s),window.addEventListener("mouseup",t),window.addEventListener("touchmove",s,{passive:!1}),window.addEventListener("touchend",t),()=>{window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",t),window.removeEventListener("touchmove",s),window.removeEventListener("touchend",t)}},[Oe]),e.jsx("div",{className:"relative",children:e.jsxs("div",{className:`relative z-10 grid gap-6 max-w-[100vw] w-full overflow-x-hidden ${oe?"transition-all":""} md:[grid-template-columns:var(--left-pane-w)_minmax(0,1fr)]`,style:{...oe?{paddingRight:420}:{},"--left-pane-w":Ae&&!jt?"25px":`${Oe}px`},children:[e.jsxs("div",{className:`md:self-start ${oe?"hidden":""} relative`,children:[Ae&&e.jsx("div",{className:"absolute inset-0 z-5",onMouseEnter:()=>qe(!0),onMouseLeave:()=>qe(!1)}),e.jsx(ar,{leftPaneCollapsed:Ae,leftPanePinned:tn,leftPaneHovered:jt,setLeftPaneCollapsed:en,setLeftPanePinned:sn,setLeftPaneHovered:qe}),e.jsxs("div",{className:`glass p-6 space-y-6 bg-white/80 dark:bg-darkcard/70 backdrop-blur min-w-0 transition-all duration-300 ${Ae&&!jt?"opacity-0 pointer-events-none scale-95":"opacity-100 scale-100"}`,onMouseEnter:()=>qe(!0),onMouseLeave:()=>qe(!1),children:[e.jsx(tr,{searchInput:Ws,setSearchInput:Hs,committedSearch:ke,setCommittedSearch:gt,hasGenerated:pe.length>0}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-2",children:"Question Types"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs("label",{className:`chip cursor-pointer ${fe?"ring-1 ring-tint bg-tint/10":""}`,children:[e.jsx("input",{type:"checkbox",className:"mr-1",checked:fe,onChange:s=>gs(s.target.checked)})," Toss-ups"]}),e.jsxs("label",{className:`chip cursor-pointer ${he?"ring-1 ring-tint bg-tint/10":""}`,children:[e.jsx("input",{type:"checkbox",className:"mr-1",checked:he,onChange:s=>ys(s.target.checked)})," Bonuses"]}),e.jsxs("label",{className:`chip cursor-pointer ${ge?"ring-1 ring-tint bg-tint/10":""}`,title:"Bonuses that have associated visual images",children:[e.jsx("input",{type:"checkbox",className:"mr-1",checked:ge,onChange:s=>ws(s.target.checked)})," Visual bonuses"]})]})]}),B.length===0&&e.jsxs("div",{role:"alert","aria-live":"polite",className:"flex items-start gap-2 rounded-lg border-l-4 border-amber-500 bg-amber-50 text-amber-900 dark:border-amber-400 dark:bg-amber-900/20 dark:text-amber-100 px-3 py-2",children:[e.jsx(En,{className:"mt-0.5 h-4 w-4 shrink-0"}),e.jsx("div",{className:"text-sm",children:"No tournaments selected."})]}),e.jsx(fn,{tournaments:R,tournamentGroups:E,selectedTournaments:B,setSelectedTournaments:z,tournamentGroupsOpen:S,setTournamentGroupsOpen:A,handleTournamentToggle:y,tournamentVisibleEntriesMainRef:C,isDark:Ss,showTournamentModal:l,setShowTournamentModal:g}),p?.user&&e.jsx(qn,{auth:p,roundsIndex:J,setRoundsIndex:te,roundFolders:$e,setRoundFolders:me,loadingUserRounds:re,refresh:lt,selectedExcludeRoundIds:H,setSelectedExcludeRoundIds:Le,foldersOpen:xe,setFoldersOpen:V,handleExcludeRoundToggle:We,pushToast:h,setManagerSelection:Ce,setShowRoundsManager:yt,setFolderDeleteTarget:Ze,setDeleteTarget:Ke,onViewRound:Zs}),e.jsx(hn,{categories:q,selectedCategories:$,setSelectedCategories:m}),e.jsx(xn,{selectedTournaments:B,tournaments:R,roundRanges:Y,setRoundRanges:o,roundsByTournament:r,globalNumericRoundMax:v}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("label",{className:"text-black dark:text-white",children:"Count"}),e.jsx("input",{type:"number",min:1,max:50,className:"w-24 rounded-lg border border-black/10 bg-white dark:bg-darkcard text-black dark:text-white px-2 py-1",value:De,onChange:s=>fs(Number(s.target.value))})]}),e.jsxs("div",{className:"pt-2 flex flex-wrap justify-center gap-4 w-full",children:[e.jsx("button",{className:"btn btn-fancy flex items-center gap-2 hover-lift disabled:opacity-50 disabled:cursor-not-allowed",onClick:wt,disabled:$t,style:{minWidth:140},children:$t?e.jsxs("span",{className:"inline-flex items-center",children:[e.jsx("span",{className:"h-4 w-4 mr-2 inline-block animate-spin rounded-full border-2 border-current border-t-transparent","aria-hidden":"true"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 4V2m0 20v-2m7-7h-2M4 12H2m16.24-6.24l-1.42 1.42M6.34 17.66l-1.42 1.42M17.66 17.66l-1.42-1.42M6.34 6.34l-1.42-1.42M12 8a4 4 0 100 8 4 4 0 000-8z"})}),"Generate"]})}),p?.user?e.jsxs("button",{className:"btn btn-fancy flex items-center gap-2 hover-lift disabled:opacity-50 disabled:cursor-not-allowed",onClick:Jt,disabled:He||pe.length===0,style:{minWidth:140},children:[e.jsx(as,{className:"h-5 w-5"}),He?"Saving…":"Save Round"]}):e.jsxs("button",{className:"btn btn-fancy flex items-center gap-2 hover-lift disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>window.alert?.("Log in to save rounds."),disabled:pe.length===0,style:{minWidth:140},children:[e.jsx(as,{className:"h-5 w-5"}),"Save Round"]}),e.jsx("button",{className:"btn btn-fancy hover-lift disabled:opacity-50 disabled:cursor-not-allowed",disabled:Et,onClick:Js,title:"Generate and export as PDF",children:Et?e.jsxs("span",{className:"inline-flex items-center",children:[e.jsx("span",{className:"h-4 w-4 mr-2 inline-block animate-spin rounded-full border-2 border-current border-t-transparent","aria-hidden":"true"}),"Generating..."]}):e.jsxs("span",{className:"inline-flex items-center",children:[e.jsx(Pn,{className:"h-4 w-4 mr-1"})," Generate PDF"]})}),e.jsxs("button",{className:`btn flex items-center gap-2 hover-lift disabled:opacity-50 disabled:cursor-not-allowed ${oe?"btn-orange":"btn-fancy"}`,onClick:()=>{oe||Ye(),Ft(s=>!s)},style:{minWidth:140},title:oe?"Close Scorekeeper":"Open Scorekeeper",disabled:pe.length===0,children:[e.jsx($n,{className:"h-5 w-5"})," ",oe?"Close":"Scorekeeper"]})]}),Array.isArray(Z)&&Z.length>0&&e.jsxs("div",{className:"mt-3 flex items-center justify-center gap-3 text-sm",children:[e.jsx("button",{className:"chip px-2 py-1 disabled:opacity-50",onClick:()=>Lt((ze??Z.length-1)-1),disabled:(ze??Z.length-1)<=0,"aria-label":"Previous generated round",children:"◀ Prev"}),e.jsxs("div",{className:"opacity-80",children:["Round ",(ze??Z.length-1)+1," of ",Z.length," (this session)"]}),e.jsx("button",{className:"chip px-2 py-1 disabled:opacity-50",onClick:()=>Lt((ze??Z.length-1)+1),disabled:(ze??Z.length-1)>=Z.length-1,"aria-label":"Next generated round",children:"Next ▶"})]})]}),!Ae&&e.jsx("div",{role:"separator","aria-orientation":"vertical",title:"Drag to resize",onMouseDown:s=>{Ae||(Ge.current=!0,vt.current=s.clientX,kt.current=Oe,document.body.style.cursor="col-resize",document.body.style.userSelect="none")},onTouchStart:s=>{if(Ae)return;const t=s.touches?.[0];t&&(Ge.current=!0,vt.current=t.clientX,kt.current=Oe,document.body.style.cursor="col-resize",document.body.style.userSelect="none")},className:"hidden md:block absolute top-0 -right-5 h-full w-2 cursor-col-resize z-30 transition-colors",children:e.jsx("div",{className:"absolute inset-y-0 left-[-1px] right-[-1px] w-[1px] bg-gray-400 dark:bg-gray-500"})})]}),"  ",e.jsxs("div",{className:`${oe?"md:col-span-2":""} md:self-start space-y-4 min-w-0 overflow-x-hidden`,children:[null,se.length===0&&e.jsx("div",{className:"glass p-6 bg-white/80 dark:bg-darkcard/70 backdrop-blur",role:"status","aria-live":"polite",children:ke.trim()?"No matches found.":ms?"No questions match the criteria provided.":"No questions generated yet."}),se.map((s,t)=>{const d=(!oe||t===W)&&(!oe||!s.tossup||ie[t]?.result==="correct"||t<W),f=`${s.tossup?.id??"tu"}-${s.bonus?.id??"bo"}-${t}`;return e.jsx(Jn,{pair:s,index:t,scorekeeping:oe,currentIndex:W,tossupResults:ie,showBonusContent:d,questionRef:u=>{Vt.current[t]=u}},f)})]}),oe&&e.jsx(sr,{headerOffset:Xe,close:()=>Ft(!1),currentIndex:W,displayPairs:se,awaitingPlayer:ae,interruptArmed:As,setAwaitingPlayer:je,setInterruptArmed:Be,typedAnswerActive:ut,setTypedAnswerActive:mt,typedAnswerText:_t,setTypedAnswerText:pt,typedAnswerPlayerId:ft,typedAnswerLoading:Rs,typedAnswerReason:Ls,checkTypedAnswer:Ds,isTossupFinal:_s,recordNoAnswer:zs,throwOutAndReplace:qs,tossupResults:ie,bonusResults:ye,saveFixedBonus:Us,players:K,handleSeatClick:Ps,allowedTeams:bt,totalPoints:Ts,teamPoints:Es,saveBonusPoints:Fs,subMode:Bs,setSubMode:()=>{Wt(!0)},resetScorekeeping:Ye,exportCoachesScoresheetPdf:Gs,coachesSheetLoading:Os,tryoutsMode:ve,setTryoutsMode:Ot,questionType:le}),e.jsx(er,{displayPairs:se,QUESTIONS_PER_PAGE:js,pdfRef:Tt}),vs&&e.jsxs("button",{type:"button",onClick:()=>window.scrollTo({top:0,behavior:"smooth"}),"aria-label":"Back to top",className:"fixed bottom-6 right-6 z-40 inline-flex items-center gap-2 rounded-full bg-tint text-white shadow-lg px-4 py-2 hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-tint",children:[e.jsx(Dn,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Top"})]}),Qs&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:()=>Ue(!1)}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl max-w-sm w-full p-6 space-y-4 border border-black/10 dark:border-white/10",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Unsaved round"}),e.jsx("p",{className:"text-sm leading-relaxed text-black/70 dark:text-white/70",children:"You already have a generated round that hasn't been saved. What would you like to do?"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{disabled:He,onClick:async()=>{await Jt(),Ue(!1),wt({force:!0})},className:"btn btn-primary w-full justify-center disabled:opacity-60",children:He?"Saving…":"Save & Generate New"}),e.jsx("button",{onClick:()=>{Ue(!1),console.log("Discarding unsaved round and generating new"),wt({force:!0})},className:"btn btn-orange w-full justify-center",children:"Generate Without Saving"}),e.jsx("button",{onClick:()=>Ue(!1),className:"btn btn-ghost w-full justify-center",children:"Cancel"})]})]})]}),Ne&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:()=>!Je&&Ke(null)}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl max-w-sm w-full p-6 space-y-5 border border-black/10 dark:border-white/10",children:[e.jsx("h2",{className:"text-lg font-semibold flex items-center gap-2 text-red-600 dark:text-red-300",children:"Delete Round"}),e.jsxs("div",{className:"text-sm leading-relaxed text-black/70 dark:text-white/70",children:["Are you sure you want to delete",e.jsxs("span",{className:"font-medium text-black dark:text-white",children:[" ",Ne.title||"this round"]}),"? This action cannot be undone."]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{disabled:Je,onClick:async()=>{if(!(!p?.user||!Ne)){Yt(!0);try{await it(p.user.uid,Ne.id),te(s=>s.filter(t=>t.id!==Ne.id)),Le(s=>s.filter(t=>t!==Ne.id)),we.current.delete(Ne.id),Ke(null),h("Round deleted.","error")}catch(s){console.error(s),h(s?.message||"Failed to delete round.","error",6e3)}finally{Yt(!1)}}},className:"btn btn-orange w-full justify-center disabled:opacity-60",children:Je?"Deleting…":"Delete Permanently"}),e.jsx("button",{disabled:Je,onClick:()=>Ke(null),className:"btn btn-ghost w-full justify-center",children:"Cancel"})]})]})]}),Te&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:()=>!et&&Ze(null)}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl max-w-sm w-full p-6 space-y-5 border border-black/10 dark:border-white/10",children:[e.jsx("h2",{className:"text-lg font-semibold flex items-center gap-2 text-red-600 dark:text-red-300",children:"Delete Folder"}),e.jsxs("div",{className:"text-sm leading-relaxed text-black/70 dark:text-white/70",children:["Delete folder ",e.jsx("span",{className:"font-semibold text-black dark:text-white",children:Te.name})," and its ",Te.count," round(s)? This cannot be undone."]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{disabled:et,onClick:async()=>{if(p?.user){Kt(!0);try{await us(Te.name,Te.roundIds),me(s=>s.filter(t=>t!==Te.name)),Ce(new Set),Ze(null)}finally{Kt(!1)}}},className:"btn btn-orange w-full justify-center disabled:opacity-60",children:et?"Deleting…":"Delete Permanently"}),e.jsx("button",{disabled:et,onClick:()=>Ze(null),className:"btn btn-ghost w-full justify-center",children:"Cancel"})]})]})]}),e.jsx(nr,{open:Is,onClose:()=>{Wt(!1),Gt(!1)},players:K,onSubmit:({team:s,playerId:t,newName:i})=>{Fe(d=>{if(d.filter(O=>O.team===s).length>=5)return d;const u=d.map(O=>O.id===t?{...O,status:"replaced"}:O),N=u.filter(O=>O.team===s).map(O=>O.seat).filter(Boolean),M=Math.max(0,...N,4)+(N.includes(5)?0:1),I={id:Cs.current++,team:s,seat:M>5?M:5,name:i,status:"active",stats:{correct:0,incorrect:0,correctInterrupt:0,incorrectInterrupt:0}};return[...u,I]}),h(`Substitution: ${i} entered for Team ${s}.`,"success")}}),Xs&&e.jsxs("div",{className:"fixed inset-0 z-[70] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>yt(!1)}),e.jsxs("div",{className:"relative bg-white dark:bg-darkcard rounded-lg shadow-xl max-w-3xl w-full p-6 space-y-4 border border-black/10 dark:border-white/10 flex flex-col max-h-[85vh]",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Manage Saved Rounds"}),e.jsx("button",{className:"btn btn-ghost btn-sm",onClick:()=>yt(!1),children:"Close"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{className:"chip px-3 py-1",onClick:()=>Ce(new Set(J.map(s=>s.id))),children:"Select All"}),e.jsx("button",{className:"chip px-3 py-1",onClick:()=>Ce(new Set),children:"Clear"}),e.jsx("button",{className:"chip px-3 py-1",onClick:()=>Ce(s=>new Set(J.filter(t=>!s.has(t.id)).map(t=>t.id))),children:"Invert"}),e.jsx("button",{className:"chip px-3 py-1",onClick:()=>{Le(Array.from(Se)),h("Excluded rounds updated.","success")},children:"Apply Exclusions"}),e.jsx("button",{className:"chip px-3 py-1 text-red-600 border-red-200 hover:bg-red-50 dark:text-red-300 dark:border-red-700 dark:hover:bg-red-900/30",onClick:async()=>{if(!p?.user)return;if(Se.size===0){h("No rounds selected.","error");return}if(!window.confirm(`Delete ${Se.size} selected round(s)? This cannot be undone.`))return;const s=Array.from(Se);let t=0;for(const i of s)try{await it(p.user.uid,i),t++}catch{}te(i=>i.filter(d=>!Se.has(d.id))),Le(i=>i.filter(d=>!Se.has(d))),Ce(new Set),h(`Deleted ${t} round(s).`,"error")},children:"Delete Selected"})]}),e.jsx("div",{className:"flex-1 overflow-auto rounded border border-black/10 dark:border-white/10",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-black/5 dark:bg-white/10 backdrop-blur",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-3 py-2 w-10",children:"Sel"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Title"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Folder"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Count"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Created"})]})}),e.jsx("tbody",{children:J.map(s=>{const t=s.createdAt?.seconds?new Date(s.createdAt.seconds*1e3):null;return e.jsxs("tr",{className:"odd:bg-black/0 even:bg-black/5 dark:even:bg-white/5 hover:bg-tint/10",children:[e.jsx("td",{className:"px-3 py-1.5",children:e.jsx("input",{type:"checkbox",checked:Se.has(s.id),onChange:()=>Ce(i=>{const d=new Set(i);return d.has(s.id)?d.delete(s.id):d.add(s.id),d})})}),e.jsx("td",{className:"px-3 py-1.5 truncate max-w-[280px]",title:s.title,children:s.title||"Untitled"}),e.jsx("td",{className:"px-3 py-1.5",children:s.folder||""}),e.jsx("td",{className:"px-3 py-1.5",children:s.count??""}),e.jsx("td",{className:"px-3 py-1.5 whitespace-nowrap",children:t?t.toLocaleDateString():""})]},s.id)})})]})})]})]}),e.jsx(rr,{toasts:D,headerOffset:Xe,onDismiss:s=>F(t=>t.filter(i=>i.id!==s))})]})})}export{Xo as default};
